{	
	"id" : "/post/tesseract-ocr-xamarin/",
	"tv" : false,
	"date": "2015-09-23 14:00:00 -0500",
	"title" : "Tesseract OCR in Xamarin",
	"author" : "Antonio Feregrino Bolaños",
	"featured_image": "http://thatcsharpguy.com/postimagesfeatured.png",
	"tags" :
	[ 
		"XamarinForms",
		"Xamarin"
	],
	"content" : "<p>While surfing the web for a free / open source solution to a certain OCR problem that I came across I found this pretty cool library named Tesseract OCR which, in its own words, is <em>“probably the most accurate open source OCR engine available”</em>. Along with the library (written in C/C++) there are an entire world of wrappers, including some for Xamarin… so, why not?</p>

<h3 id=\"application\">Application</h3>
<p>In this post I’ll show you how to create a simple iOS and Android application that allows the user to take a picture and identify the characters that got captured on the picture. Nothing too complicated. It’ll be a Xamarin.Forms app, code sharing at its best!</p>

<h4 id=\"creating-the-solution\">Creating the solution</h4>
<p>For this post I used Xamarin Studio on a Mac, but as you know, you can create it regardless of the OS or IDE. Go to New solution &gt; Cross-platform &gt; App &gt; Blank Xamarin.Forms app. Give it any name you want and select Use Portable Class Library.</p>

<p><figure><img src='/postimages/post/tesseract-ocr-xamarin/post.jsonproject-creation-1.png' alt='Creación del proyecto images_set' /></figure></p>

<h4 id=\"nugets-and-nugets\">NuGets and NuGets</h4>
<p>Then proceed to add the XLabs NuGet package (<code>XLabs.Forms</code>) to the three projects, we’ll use the IoC features that it provides and the ability to take photos right from our PCL. Add also the TinyIoC package (<code>XLabs.IoC.TinyIoC</code>) to both the iOS and Android projects, I’m using TinyIoC but you can use whatever DI tool you want.</p>

<h4 id=\"the-tesseract-nuget\">The Tesseract NuGet</h4>
<p>Yay! another NuGet, but this time is the most important for our app. Add the package <code>Xamarin.Tesseract</code> to the three projects, yes, the same package for all three. This little package is <a href=\"http://shamsutdinov.net/2015/07/01/tesseract-orc-xamarin-part-1/\" target=\"_blank\">developed by Artur Shamsutdinov</a> and it is a wrapper for Tesseract OCR that provides a nice API to work with. So far so good.</p>

<p>Tesseract relay on some data files to work, for each language symbols you want to recognize you must add a set of files. For example, this app recognizes english characters so only the <code>eng.*</code> files are needed, these files must be placed in a folder named <code>tessdata</code> inside the AndroidAssets folder for Android and the Resources folder for iOS. You can download the <a href=\"https://code.google.com/p/tesseract-ocr/downloads/list\" target=\"_blank\">symbol files for each language here</a>.</p>

<h4 id=\"configuring-tinyioc\">Configuring TinyIoC</h4>
<p>As Tesseract and XLabs require platform specific code to work, we must find a way to allow a the shared PCL to execute such code, there are many options but I choose to implement IoC with TinyIoC. To use it we must configure each project separately.</p>

<h5 id=\"android\">Android</h5>
<p>First of all, grab a reference to the container with<br />
<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="n">TinyIoCContainer</span><span class="p">.</span><span class="n">Current</span><span class="p">;</span></code></pre></figure>
The container is like a bucket where we “put” pieces of code that will be used within our application. Then, we must put code in that bucket, we do so by calling the <code>Register</code> method of the container:<br />
<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">idevice</span><span class="p">&gt;(</span><span class="n">AndroidDevice</span><span class="p">.</span><span class="n">CurrentDevice</span><span class="p">);</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">itesseractapi</span><span class="p">&gt;((</span><span class="n">cont</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span> <span class="p">=&amp;</span><span class="n">gt</span><span class="p">;</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nf">TesseractApi</span><span class="p">(</span><span class="n">ApplicationContext</span><span class="p">,</span> <span class="n">AssetsDeployment</span><span class="p">.</span><span class="n">OncePerInitialization</span><span class="p">);</span>
<span class="p">});</span></code></pre></figure>
With the first line the device where the app is running gets registered (alongside with all its available features), whereas with the second line we are registering the implementation of the Tesseract API, for Android we must pass in the constructor a reference to the application context where the application is running. For this example it is set to <code>ApplicationContext</code> in the <code>MainActivity.cs</code>.  
Finally we have yet to register our <code>container</code> in the XLabs <code>Resolver</code>:
<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Resolver</span><span class="p">.</span><span class="n">SetResolver</span><span class="p">(</span><span class="k">new</span> <span class="n">TinyResolver</span><span class="p">(</span><span class="n">container</span><span class="p">));</span></code></pre></figure>
By the way, do not forget to add the following <code>using</code> statements at the top of your file
<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">TinyIoC</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Tesseract</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Tesseract.Droid</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">XLabs.Ioc</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">XLabs.Ioc.TinyIOC</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">XLabs.Platform.Device</span><span class="p">;</span></code></pre></figure></itesseractapi></idevice></p>

<h5 id=\"ios\">iOS</h5>
<p>It is almost the same process as with Android. First, get a reference to the container:<br />
<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="n">TinyIoCContainer</span><span class="p">.</span><span class="n">Current</span><span class="p">;</span></code></pre></figure><br />
After that, register the device and the Tesseract API implementation. This time there is no need to add parameters to the <code>TesseractApi</code> constructor.<br />
<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">idevice</span><span class="p">&gt;(</span><span class="n">AndroidDevice</span><span class="p">.</span><span class="n">CurrentDevice</span><span class="p">);</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">itesseractapi</span><span class="p">&gt;((</span><span class="n">cont</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span> <span class="p">=&amp;</span><span class="n">gt</span><span class="p">;</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nf">TesseractApi</span><span class="p">();</span>
<span class="p">});</span></code></pre></figure>
Again, register the <code>container</code> in the <code>Resolver</code>
<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Resolver</span><span class="p">.</span><span class="n">SetResolver</span><span class="p">(</span><span class="k">new</span> <span class="n">TinyResolver</span><span class="p">(</span><span class="n">container</span><span class="p">));</span></code></pre></figure> 
Here are the <code>using</code> statements for the <code>AppDelegate.cs</code> file
<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">TinyIoC</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Tesseract</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Tesseract.iOS</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">XLabs.Ioc</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">XLabs.Ioc.TinyIOC</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">XLabs.Platform.Device</span><span class="p">;</span></code></pre></figure></itesseractapi></idevice></p>

<h4 id=\"shared-code-yay\">Shared code! yay!</h4>
<p>Finally, we get to the code sharing part. The UI for this app wont be much of a hassle, just a button, an image and a label. The button to call the photo-taking action, the image to display the recently captured image and the label to display the recognized text. For this simple demo app all the code will be on the page itself, however, you may want to move the code to a viewmodel to create a more complex app, to start, create a new Page named <code>HomePage</code> in the root of the shared PCL project and add the following as class-level variables:
<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="n">Button</span> <span class="n">_takePictureButton</span><span class="p">;</span>
<span class="k">private</span> <span class="n">Label</span> <span class="n">_recognizedTextLabel</span><span class="p">;</span>
<span class="k">private</span> <span class="n">Image</span> <span class="n">_takenImage</span><span class="p">;&lt;/</span><span class="n">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="k">private</span> <span class="k">readonly</span> <span class="n">ITesseractApi</span> <span class="n">_tesseractApi</span><span class="p">;</span>
<span class="k">private</span> <span class="k">readonly</span> <span class="n">IDevice</span> <span class="n">_device</span><span class="p">;</span></code></pre></figure>
The last two lines are interfaces which abstract the platform specific features that we registered a few lines above. In the constructor of the <code>HomePage</code> we’ll call the <code>Resolve</code> method on our resolver class to get a references to the implementations for each platform:
<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">_tesseractApi</span> <span class="p">=</span> <span class="n">Resolver</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">itesseractapi</span><span class="p">&gt;();</span>
<span class="n">_device</span> <span class="p">=</span> <span class="n">Resolver</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">idevice</span><span class="p">&gt;();</span></code></pre></figure>
Then build the UI, I placed the three controls within a <code>StackLayout</code>, and wire the only event:
<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">_takePictureButton</span><span class="p">.</span><span class="n">Clicked</span> <span class="p">+=</span> <span class="n">TakePictureButton_Clicked</span><span class="p">;</span>
<span class="c1">// ...</span>
<span class="k">async</span> <span class="k">void</span> <span class="nf">TakePictureButton_Clicked</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(!</span><span class="n">_tesseractApi</span><span class="p">.</span><span class="n">Initialized</span><span class="p">)</span>
		<span class="k">await</span> <span class="n">_tesseractApi</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="err">\</span><span class="s">&quot;eng\&quot;);&lt;/idevice&gt;&lt;/itesseractapi&gt;&lt;/p&gt;</span>

<span class="p">&lt;</span><span class="n">pre</span><span class="p">&gt;&lt;</span><span class="n">code</span><span class="p">&gt;</span><span class="kt">var</span> <span class="n">photo</span> <span class="p">=</span> <span class="k">await</span> <span class="n">TakePic</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="n">photo</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">var</span> <span class="n">imageBytes</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">photo</span><span class="p">.</span><span class="n">Source</span><span class="p">.</span><span class="n">Length</span><span class="p">];</span>
	<span class="n">photo</span><span class="p">.</span><span class="n">Source</span><span class="p">.</span><span class="n">Position</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
	<span class="n">photo</span><span class="p">.</span><span class="n">Source</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">imageBytes</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">photo</span><span class="p">.</span><span class="n">Source</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
	<span class="n">photo</span><span class="p">.</span><span class="n">Source</span><span class="p">.</span><span class="n">Position</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

	<span class="n">_takenImage</span><span class="p">.</span><span class="n">Source</span> <span class="p">=</span> <span class="n">ImageSource</span><span class="p">.</span><span class="n">FromStream</span><span class="p">(()</span> <span class="p">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">photo</span><span class="p">.</span><span class="n">Source</span><span class="p">);</span>
	<span class="kt">var</span> <span class="n">tessResult</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_tesseractApi</span><span class="p">.</span><span class="n">SetImage</span><span class="p">(</span><span class="n">imageBytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tessResult</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">_recognizedTextLabel</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="n">_tesseractApi</span><span class="p">.</span><span class="n">Text</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span> <span class="p">}</span> <span class="c1">// ...  private async Task&amp;lt;MediaFile&amp;gt; TakePic() {</span>
<span class="kt">var</span> <span class="n">mediaStorageOptions</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CameraMediaStorageOptions</span>
<span class="p">{</span>
	<span class="n">DefaultCamera</span> <span class="p">=</span> <span class="n">CameraDevice</span><span class="p">.</span><span class="n">Rear</span>
<span class="p">};</span>
<span class="kt">var</span> <span class="n">mediaFile</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_device</span><span class="p">.</span><span class="n">MediaPicker</span><span class="p">.</span><span class="n">TakePhotoAsync</span><span class="p">(</span><span class="n">mediaStorageOptions</span><span class="p">);</span>

<span class="k">return</span> <span class="n">mediaFile</span><span class="p">;</span> <span class="p">}</span> </code></pre></figure>  
</code></pre>

<h4 id=\"wrapping-up\">Wrapping up</h4>
<p>Here are some photos I took of the app running on an iPod touch:</p>
<blockquote class=\"imgur-embed-pub\" lang=\"en\" data-id=\"a/FFi7b\"><a href=\"//imgur.com/FFi7b\">Tesseract OCR in Xamarin</a></blockquote>
<script async=\"\" src=\"//s.imgur.com/min/embed.js\" charset=\"utf-8\"></script>

<p>And that’s pretty much it. Now your Xamarin.Forms app can see! but everything has its drawbacks… this works well as a proof of concept but I have some final thoughts on it:</p>

<ul>
  <li>You may want to perform some preprocessing techniques on the image to improve the accuracy of Tesseract’s results</li>
  <li>Be aware of the size of your app as <em>tessdata</em> files aren’t small</li>
  <li>Consider the memory of the device yout app will be running on.</li>
</ul>

<p>As always, get the code for <a href=\"https://github.com/fferegrino/xocr\">Xocr on GitHub</a> and if you have questions, let me know!</p>
"
}