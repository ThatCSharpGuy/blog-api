{	
	"id" : "/post/full-camera-page.1/",
	"tv" : false,
	"date": "2016-11-08 02:00:00 -0600",
	"title" : "Full page camera in Xamarin.Forms",
	"author" : "Antonio Feregrino Bolaños",
	"featured_image": "http://thatcsharpguy.com/postimages//xamarin-forms/camerapage/featured.jpg",
	"tags" :
	[ 
		"XamarinForms",
		"Xamarin"
	],
	"content" : "<p>It has been a while since I coded <a href=\"..\Aharphat-Android\" target=\"_blank\">CharpHat</a>, which is an app that lets you snap a picture of anything and then put a nice C# graduation cap on it. That app was far from perfect, but it helped me to practice the usage of custom page renderers.</p>

<p>Today I decided to retake that project, but this time trying to isolate the code needed to build the interface and funcionality of the page, so that anyone looking forward to implement a full camera page in their apps could reuse the code for their own projects. So be sure to <strong><a href=\"https://github.com/ThatCSharpGuy/Forms-FullCameraPage\" target=\"_blank\">grab the source code</a></strong> for this post.</p>

<h2 id=\"forms-abstractions\">Forms abstractions</h2>
<p><small><a href=\"https://github.com/ThatCSharpGuy/Forms-FullCameraPage/blob/master/CameraPage.cs\" target=\"_blank\">Here is the source code for this section.</a></small></p>

<p>Let’s start by creating the Xamarin.Forms page that will serve as our point of interaction with the custom code:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">CameraPage</span> <span class="p">:</span> <span class="n">ContentPage</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">PhotoResultEventHandler</span><span class="p">(</span><span class="n">PhotoResultEventArgs</span> <span class="n">result</span><span class="p">);</span>
    <span class="k">public</span> <span class="k">event</span> <span class="n">PhotoResultEventHandler</span> <span class="n">OnPhotoResult</span><span class="p">;</span></code></pre></figure></p>

<p>Business as usual, create a class deriving from <code>ContentPage</code>. I have added an event handler as I want to access the picture taken by the user. Now let’s throw in some methods to call whenever an user performs an action in our camera page (in this case, the user will be allowed to take a photo or cancel the action):</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">void</span> <span class="nf">SetPhotoResult</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">image</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">OnPhotoResult</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">(</span><span class="k">new</span> <span class="n">PhotoResultEventArgs</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">));</span>
<span class="p">}&lt;/</span><span class="n">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="k">public</span> <span class="k">void</span> <span class="n">Cancel</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">OnPhotoResult</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">(</span><span class="k">new</span> <span class="n">PhotoResultEventArgs</span><span class="p">());</span>
<span class="p">}</span> </code></pre></figure></p>

<p>For reference, see the properties inside the <code>PhotoResultEventArgs</code> class:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="kt">bool</span> <span class="n">Success</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="k">public</span> <span class="kt">int</span> <span class="n">Width</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="k">public</span> <span class="kt">int</span> <span class="n">Height</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="k">public</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">Image</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span></code></pre></figure></p>

<p>Now, time to move on to the platform specifics.</p>

<h2 id=\"in-xamarinios\">In Xamarin.iOS</h2>
<p><small><a href=\"https://github.com/ThatCSharpGuy/Forms-FullCameraPage/blob/master/iOS/CameraPageRenderer.cs\" target=\"_blank\">Here is the source code for this section.</a></small></p>

<p>To be honest, this implementation is the easiest by far. Start off by creating a class that inherits from <code>PageRenderer</code>, and to add the <code>ExportRenderer</code> attribute:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="na">[assembly: ExportRenderer(typeof(CameraPage), typeof(CameraPageRenderer))]</span>
<span class="k">namespace</span> <span class="nn">FullCameraPage.iOS</span>
<span class="p">{</span>
	<span class="k">public</span> <span class="k">class</span> <span class="nc">CameraPageRenderer</span> <span class="p">:</span> <span class="n">PageRenderer</span></code></pre></figure></p>

<p>Now, an this is very important, you need to override the <code>ViewDidLoad</code> method, since it gets called as soon as our page is loaded by the iOS mechanisms. For the sake of organisation let’s split the code in several other methods:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">override</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">ViewDidLoad</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">base</span><span class="p">.</span><span class="n">ViewDidLoad</span><span class="p">();</span>
    <span class="n">SetupUserInterface</span><span class="p">();</span>
    <span class="n">SetupEventHandlers</span><span class="p">();</span>
    <span class="n">AuthorizeCameraUse</span><span class="p">();</span>
    <span class="n">SetupLiveCameraStream</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure></p>

<h3 id=\"setupuserinterface\">SetupUserInterface</h3>
<p>As the name states, here is where you need to build the UI. As you may have guessed, it is all done by code, but don’t worry, it is very easy… as long as your UI isn’t so complex, but you can do whatever you need here.</p>

<p>For this sample the UI will consist of a couple of buttons and a surface where the live preview from the camera is going to be shown, so you need to declare them on a class-level scope:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">VectorButton</span> <span class="n">takePhotoButton</span><span class="p">;</span>
<span class="n">VectorButton</span> <span class="n">cancelPhotoButton</span><span class="p">;</span>
<span class="n">UIView</span> <span class="n">liveCameraStream</span><span class="p">;</span></code></pre></figure></p>

<p>To set the items in place you need to think as if you were working with a relative layout, meaning that you need to set the position of each item within the screen. For example, look at how the live camera preview view is positioned:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="k">void</span> <span class="nf">SetupUserInterface</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Code ommited …</span>
    <span class="n">liveCameraStream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UIView</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Frame</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CGRect</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="n">View</span><span class="p">.</span><span class="n">Bounds</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span> <span class="n">View</span><span class="p">.</span><span class="n">Bounds</span><span class="p">.</span><span class="n">Height</span><span class="p">)</span>
    <span class="p">};</span>
    <span class="c1">// Code ommited …</span>
    <span class="n">View</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">liveCameraStream</span><span class="p">);</span>
    <span class="c1">// Code ommited …</span>
<span class="p">}</span></code></pre></figure></p>

<h3 id=\"setupeventhandlers\">SetupEventHandlers</h3>
<p>Now that the UI has been built, let’s hook up the event handlers to each control, luckly for this sample there are only two buttons on screen: one to take the picture and the other to cancel the whole thing.</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">cancelPhotoButton</span><span class="p">.</span><span class="n">TouchUpInside</span> <span class="p">+=</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&amp;</span><span class="n">gt</span><span class="p">;</span>
<span class="p">{</span>
    <span class="p">(</span><span class="n">Element</span> <span class="k">as</span> <span class="n">CameraPage</span><span class="p">).</span><span class="n">Cancel</span><span class="p">();</span>
<span class="p">};&lt;/</span><span class="n">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="n">takePhotoButton</span><span class="p">.</span><span class="n">TouchUpInside</span> <span class="p">+=</span> <span class="k">async</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&amp;</span><span class="n">gt</span><span class="p">;</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="k">await</span> <span class="n">CapturePhoto</span><span class="p">();</span>
    <span class="n">UIImage</span> <span class="n">imageInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UIImage</span><span class="p">(</span><span class="n">data</span><span class="p">);&lt;/</span><span class="n">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">pre</span><span class="p">&gt;&lt;</span><span class="n">code</span><span class="p">&gt;(</span><span class="n">Element</span> <span class="k">as</span> <span class="n">CameraPage</span><span class="p">).</span><span class="n">SetPhotoResult</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">ToArray</span><span class="p">(),</span>
                                       <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">imageInfo</span><span class="p">.</span><span class="n">Size</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span>
                                       <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">imageInfo</span><span class="p">.</span><span class="n">Size</span><span class="p">.</span><span class="n">Height</span><span class="p">);</span> <span class="p">};</span> </code></pre></figure>  
</code></pre>

<p>The property <code>Element</code> contains a reference to the page associated to the renderer, and is our way to interact with our Forms project. As for the method <code>CapturePhoto</code>… we’ll see it later.</p>

<h2 id=\"authorizecamerause\">AuthorizeCameraUse</h2>
<p>Now it’s time to ask the user for its permission to access the camera:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">authorizationStatus</span> <span class="p">=</span> <span class="n">AVCaptureDevice</span><span class="p">.</span><span class="n">GetAuthorizationStatus</span><span class="p">(</span><span class="n">AVMediaType</span><span class="p">.</span><span class="n">Video</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">authorizationStatus</span> <span class="p">!=</span> <span class="n">AVAuthorizationStatus</span><span class="p">.</span><span class="n">Authorized</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">await</span> <span class="n">AVCaptureDevice</span><span class="p">.</span><span class="n">RequestAccessForMediaTypeAsync</span><span class="p">(</span><span class="n">AVMediaType</span><span class="p">.</span><span class="n">Video</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure></p>

<p>But wait a minute, before executing the code above, make sure you have added the key <code>Privacy - Camera Usage Description</code> to the Info.plist in your project.</p>

<h3 id=\"setuplivecamerastream\">SetupLiveCameraStream</h3>
<p>Now the “heavy” stuff.</p>

<p>Start by declaring at class-level scope an <code>AVCaptureSession</code>, <code>AVCaptureDeviceInput</code> and <code>AVCaptureStillImageOutput</code>, as they will hel us access the camera, display the live feed and capture the photo.</p>

<p>Then, inside the <code>SetupLiveCameraStream</code> method, initialize the capture session, create a preview layer with the same size as our <code>liveCameraStream</code>, and add it as a sublayer of it:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp">    <span class="n">captureSession</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AVCaptureSession</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">videoPreviewLayer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AVCaptureVideoPreviewLayer</span><span class="p">(</span><span class="n">captureSession</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Frame</span> <span class="p">=</span> <span class="n">liveCameraStream</span><span class="p">.</span><span class="n">Bounds</span>
    <span class="p">};</span>
    <span class="n">liveCameraStream</span><span class="p">.</span><span class="n">Layer</span><span class="p">.</span><span class="n">AddSublayer</span><span class="p">(</span><span class="n">videoPreviewLayer</span><span class="p">);</span></code></pre></figure></p>

<p>Next, “create” a capture device (you can configure it to work according to your needs). And then, from it create the an input source for the capture session:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp">    <span class="kt">var</span> <span class="n">captureDevice</span> <span class="p">=</span> <span class="n">AVCaptureDevice</span><span class="p">.</span><span class="n">DefaultDeviceWithMediaType</span><span class="p">(</span><span class="n">AVMediaType</span><span class="p">.</span><span class="n">Video</span><span class="p">);</span>
    <span class="n">ConfigureCameraForDevice</span><span class="p">(</span><span class="n">captureDevice</span><span class="p">);</span>
    <span class="n">captureDeviceInput</span> <span class="p">=</span> <span class="n">AVCaptureDeviceInput</span><span class="p">.</span><span class="n">FromDevice</span><span class="p">(</span><span class="n">captureDevice</span><span class="p">);</span></code></pre></figure></p>

<p>We have an input (the camera of the device), now we need an output which is going to be a jpeg photograph:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp">    <span class="kt">var</span> <span class="n">dictionary</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NSMutableDictionary</span><span class="p">();</span>
    <span class="n">dictionary</span><span class="p">[</span><span class="n">AVVideo</span><span class="p">.</span><span class="n">CodecKey</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NSNumber</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">AVVideoCodec</span><span class="p">.</span><span class="n">JPEG</span><span class="p">);</span>
    <span class="n">stillImageOutput</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AVCaptureStillImageOutput</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">OutputSettings</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NSDictionary</span><span class="p">()</span>
    <span class="p">};</span></code></pre></figure></p>

<p>Finalize by setting the input and output of the capture session and starting it:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp">    <span class="n">captureSession</span><span class="p">.</span><span class="n">AddOutput</span><span class="p">(</span><span class="n">stillImageOutput</span><span class="p">);</span>
    <span class="n">captureSession</span><span class="p">.</span><span class="n">AddInput</span><span class="p">(</span><span class="n">captureDeviceInput</span><span class="p">);</span>
    <span class="n">captureSession</span><span class="p">.</span><span class="n">StartRunning</span><span class="p">();</span></code></pre></figure></p>

<h3 id=\"capturephoto\">CapturePhoto</h3>
<p>At last, the icing on the cake, the code to capture the photo. The code is pretty simple: Take the output and capture a still image from it, as we only need the bytes we get an <code>NSData</code> containing the taken photo.</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">nsdata</span><span class="p">&gt;</span> <span class="n">CapturePhoto</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">videoConnection</span> <span class="p">=</span> <span class="n">stillImageOutput</span><span class="p">.</span><span class="n">ConnectionFromMediaType</span><span class="p">(</span><span class="n">AVMediaType</span><span class="p">.</span><span class="n">Video</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">sampleBuffer</span> <span class="p">=</span> <span class="k">await</span> <span class="n">stillImageOutput</span><span class="p">.</span><span class="n">CaptureStillImageTaskAsync</span><span class="p">(</span><span class="n">videoConnection</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">jpegImageAsNsData</span> <span class="p">=</span> <span class="n">AVCaptureStillImageOutput</span><span class="p">.</span><span class="n">JpegStillToNSData</span><span class="p">(</span><span class="n">sampleBuffer</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">jpegImageAsNsData</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure></nsdata></p>

<h2 id=\"in-xamarinandroid\">In Xamarin.Android</h2>
<p><small><a href=\"https://github.com/ThatCSharpGuy/Forms-FullCameraPage/blob/master/Droid/CameraPageRenderer.cs\" target=\"_blank\">Here is the source code for this section.</a></small>  <br />
This implementation isn’t as clean as it is in iOS. Mainly because Android puts a lot of ephasis in the use of listeners, rather than in event handlers. However, that is not a problem for us.</p>

<p>As with the iOS implementation, start by creating a new class and make it derive from <code>PageRenderer</code> and also make it implement the <code>TextureView.ISurfaceTextureListener</code> interface. Don’t forget the <code>ExportRender</code> attribute:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="na">[assembly: Xamarin.Forms.ExportRenderer(typeof(CameraPage), typeof(CameraPageRenderer))]</span>
<span class="k">namespace</span> <span class="nn">FullCameraPage.Droid</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">CameraPageRenderer</span> <span class="p">:</span> <span class="n">PageRenderer</span><span class="p">,</span> <span class="n">TextureView</span><span class="p">.</span><span class="n">ISurfaceTextureListener</span></code></pre></figure></p>

<p>Then, override the <code>OnElementChanged</code> method (if you have creaated custom renderers before this method may be familar to you), this method is going to be called everytime the a <code>CamerPage</code> is shown on screen:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnElementChanged</span><span class="p">(</span><span class="n">ElementChangedEventArgs</span><span class="p">&lt;</span><span class="n">xamarin</span><span class="p">.</span><span class="n">forms</span><span class="p">.</span><span class="n">page</span><span class="p">&gt;</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">base</span><span class="p">.</span><span class="n">OnElementChanged</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
    <span class="n">SetupUserInterface</span><span class="p">();</span>
    <span class="n">SetupEventHandlers</span><span class="p">();</span></code></pre></figure></xamarin.forms.page></p>

<h3 id=\"setupuserinterface-1\">SetupUserInterface</h3>
<p>In this method we are supposed to create the camera page itself, you can do it by creating an <em>axml</em> file and calling all the Android inflating stuff… Or, like in this sample, you can create it by code.</p>

<p>For this sample, we’ll need a <code>RelativeLayout</code> to work as a container, a <code>TextureView</code> to display the live feed from the camera, and a <code>Button</code> (a <code>PaintCodeButton</code> actually) to snap the photograph. Declare all them at class-level scope:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">RelativeLayout</span> <span class="n">mainLayout</span><span class="p">;</span>
<span class="n">TextureView</span> <span class="n">liveView</span><span class="p">;</span>
<span class="n">PaintCodeButton</span> <span class="n">capturePhotoButton</span><span class="p">;</span></code></pre></figure></p>

<p>Now, proceed to create them and add them to the screen, for example, see how we can create the container layout and add the <code>TextureView</code> to it:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">void</span> <span class="nf">SetupUserInterface</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">mainLayout</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RelativeLayout</span><span class="p">(</span><span class="n">Context</span><span class="p">);</span>
    <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span> <span class="n">mainLayoutParams</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">(</span>
        <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">.</span><span class="n">MatchParent</span><span class="p">,</span>
        <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">.</span><span class="n">MatchParent</span><span class="p">);</span>
    <span class="n">mainLayout</span><span class="p">.</span><span class="n">LayoutParameters</span> <span class="p">=</span> <span class="n">mainLayoutParams</span><span class="p">;&lt;/</span><span class="n">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">pre</span><span class="p">&gt;&lt;</span><span class="n">code</span><span class="p">&gt;</span><span class="n">liveView</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TextureView</span><span class="p">(</span><span class="n">Context</span><span class="p">);</span>
<span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span> <span class="n">liveViewParams</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">(</span>
    <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">.</span><span class="n">MatchParent</span><span class="p">,</span> 
    <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">.</span><span class="n">MatchParent</span><span class="p">);</span>
<span class="n">liveView</span><span class="p">.</span><span class="n">LayoutParameters</span> <span class="p">=</span> <span class="n">liveViewParams</span><span class="p">;</span>
<span class="n">mainLayout</span><span class="p">.</span><span class="n">AddView</span><span class="p">(</span><span class="n">liveView</span><span class="p">);</span>

<span class="c1">// Code ommited...</span>

<span class="n">AddView</span><span class="p">(</span><span class="n">mainLayout</span><span class="p">);</span> <span class="p">}</span> </code></pre></figure>  
</code></pre>

<p>Before continuing, there is another method (<code>OnLayout</code>) we need to override to give our main layout it’s size (and acommodate the UI accordingly):</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnLayout</span><span class="p">(</span><span class="kt">bool</span> <span class="n">changed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">base</span><span class="p">.</span><span class="n">OnLayout</span><span class="p">(</span><span class="n">changed</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">changed</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">msw</span> <span class="p">=</span> <span class="n">MeasureSpec</span><span class="p">.</span><span class="n">MakeMeasureSpec</span><span class="p">(</span><span class="n">r</span> <span class="p">-</span> <span class="n">l</span><span class="p">,</span> <span class="n">MeasureSpecMode</span><span class="p">.</span><span class="n">Exactly</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">msh</span> <span class="p">=</span> <span class="n">MeasureSpec</span><span class="p">.</span><span class="n">MakeMeasureSpec</span><span class="p">(</span><span class="n">b</span> <span class="p">-</span> <span class="n">t</span><span class="p">,</span> <span class="n">MeasureSpecMode</span><span class="p">.</span><span class="n">Exactly</span><span class="p">);</span>
    <span class="n">mainLayout</span><span class="p">.</span><span class="n">Measure</span><span class="p">(</span><span class="n">msw</span><span class="p">,</span> <span class="n">msh</span><span class="p">);</span>
    <span class="n">mainLayout</span><span class="p">.</span><span class="n">Layout</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">r</span> <span class="p">-</span> <span class="n">l</span><span class="p">,</span> <span class="n">b</span> <span class="p">-</span> <span class="n">t</span><span class="p">);&lt;/</span><span class="n">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">pre</span><span class="p">&gt;&lt;</span><span class="n">code</span><span class="p">&gt;</span><span class="n">capturePhotoButton</span><span class="p">.</span><span class="n">SetX</span><span class="p">(</span> <span class="n">mainLayout</span><span class="p">.</span><span class="n">Width</span> <span class="p">/</span> <span class="m">2</span> <span class="p">-</span> <span class="m">60</span><span class="p">);</span>
<span class="n">capturePhotoButton</span><span class="p">.</span><span class="n">SetY</span><span class="p">(</span><span class="n">mainLayout</span><span class="p">.</span><span class="n">Height</span> <span class="p">-</span> <span class="m">200</span><span class="p">);</span> <span class="p">}</span> </code></pre></figure>  
</code></pre>

<h3 id=\"setupeventhandlers-1\">SetupEventHandlers</h3>
<p>As I said, Android relies mostly on event listeners rather than handlers, so the code for this method is pretty simple. We need to set an event handler for the “sutter” button and assign the listener that will be aware of the <code>SurfaceTexture</code> status (remember that our page render implements an interface?):</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">capturePhotoButton</span><span class="p">.</span><span class="n">Click</span> <span class="p">+=</span> <span class="k">async</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&amp;</span><span class="n">gt</span><span class="p">;</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">bytes</span> <span class="p">=</span> <span class="k">await</span> <span class="n">TakePhoto</span><span class="p">();</span>
    <span class="p">(</span><span class="n">Element</span> <span class="k">as</span> <span class="n">CameraPage</span><span class="p">).</span><span class="n">SetPhotoResult</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">liveView</span><span class="p">.</span><span class="n">Bitmap</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span> <span class="n">liveView</span><span class="p">.</span><span class="n">Bitmap</span><span class="p">.</span><span class="n">Height</span><span class="p">);</span>
<span class="p">};</span>
<span class="n">liveView</span><span class="p">.</span><span class="n">SurfaceTextureListener</span> <span class="p">=</span> <span class="k">this</span><span class="p">;</span></code></pre></figure></p>

<p>And one more thing, let’s to override the default behavior of the “back” button, so that it acts as a cancel button for the camera:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">OnKeyDown</span><span class="p">(</span><span class="n">Keycode</span> <span class="n">keyCode</span><span class="p">,</span> <span class="n">KeyEvent</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">keyCode</span> <span class="p">==</span> <span class="n">Keycode</span><span class="p">.</span><span class="n">Back</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="p">(</span><span class="n">Element</span> <span class="k">as</span> <span class="n">CameraPage</span><span class="p">).</span><span class="n">Cancel</span><span class="p">();</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="n">OnKeyDown</span><span class="p">(</span><span class="n">keyCode</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure></p>

<h3 id=\"textureviewisurfacetexturelistener-implementation\">TextureView.ISurfaceTextureListener implementation</h3>
<p>Now is time to implement the core of our page. Start by writing the code for the <code>OnSurfaceTextureAvailable</code> where we will prepare the output for the camera, but first we’ll need a camera, right?</p>

<p>At class-level scope declare a <code>Camera</code>:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Android</span><span class="p">.</span><span class="n">Hardware</span><span class="p">.</span><span class="n">Camera</span> <span class="n">camera</span><span class="p">;</span></code></pre></figure></p>

<p>Inside the method, open the camera (by default it’ll try to open the back camera of the device) and get its parameters. We need them to select the right preview size, because we want things to look great in our app:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">camera</span> <span class="p">=</span> <span class="n">Android</span><span class="p">.</span><span class="n">Hardware</span><span class="p">.</span><span class="n">Camera</span><span class="p">.</span><span class="n">Open</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">parameters</span> <span class="p">=</span> <span class="n">camera</span><span class="p">.</span><span class="n">GetParameters</span><span class="p">();</span></code></pre></figure></p>

<p>Once we have the parameters at hand, we can get the avaliable <code>PreviewSizes</code> and get the one that fits our preview surface. In this case I’m using a simple <a href=\"#\">linq expression</a> to get the best preview size based on aspect ratio:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">aspect</span> <span class="p">=</span> <span class="p">((</span><span class="kt">decimal</span><span class="p">)</span><span class="n">height</span><span class="p">)</span> <span class="p">/</span> <span class="p">((</span><span class="kt">decimal</span><span class="p">)</span><span class="n">width</span><span class="p">);&lt;/</span><span class="n">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="kt">var</span> <span class="n">previewSize</span> <span class="p">=</span> <span class="n">parameters</span><span class="p">.</span><span class="n">SupportedPreviewSizes</span>
                            <span class="p">.</span><span class="n">OrderBy</span><span class="p">(</span><span class="n">s</span> <span class="p">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Math</span><span class="p">.</span><span class="n">Abs</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">Width</span> <span class="p">/</span> <span class="p">(</span><span class="kt">decimal</span><span class="p">)</span><span class="n">s</span><span class="p">.</span><span class="n">Height</span> <span class="p">-</span> <span class="n">aspect</span><span class="p">))</span>
                            <span class="p">.</span><span class="n">First</span><span class="p">();&lt;/</span><span class="n">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="n">parameters</span><span class="p">.</span><span class="n">SetPreviewSize</span><span class="p">(</span><span class="n">previewSize</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span> <span class="n">previewSize</span><span class="p">.</span><span class="n">Height</span><span class="p">);</span>
<span class="n">camera</span><span class="p">.</span><span class="n">SetParameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">);</span></code></pre></figure></p>

<p>Finish by setting our surface as the preview texture, at this point the only thing left to do is to start the camera:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">camera</span><span class="p">.</span><span class="n">SetPreviewTexture</span><span class="p">(</span><span class="n">surface</span><span class="p">);</span>
<span class="n">StartCamera</span><span class="p">();</span></code></pre></figure></p>

<p>The other method we need to write code into is <code>OnSurfaceTextureDestroyed</code> in order to stop the camera, so just write the following inside and it’ll be all:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">StopCamera</span><span class="p">();</span>
<span class="k">return</span> <span class="k">true</span><span class="p">;</span></code></pre></figure></p>

<h3 id=\"startcamera-and-stopcamera\">StartCamera and StopCamera</h3>
<p>These two methods are quite simple too, for <code>StartCamera</code> we only need to rotate the preview to make it look right in the screen (in this case I’m setting it to be viewed vertically), and then finally, start the camera:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">camera</span><span class="p">.</span><span class="n">SetDisplayOrientation</span><span class="p">(</span><span class="m">90</span><span class="p">);</span>
<span class="n">camera</span><span class="p">.</span><span class="n">StartPreview</span><span class="p">();</span></code></pre></figure></p>

<p>The <code>StopCamera</code> method stops the preview and releases the camera, so that other apps can access to it:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">camera</span><span class="p">.</span><span class="n">StopPreview</span><span class="p">();</span>
<span class="n">camera</span><span class="p">.</span><span class="n">Release</span><span class="p">();</span></code></pre></figure></p>

<h3 id=\"takephoto\">TakePhoto</h3>

<p>In order to get a photo, the only thing we need to do is get an sitll image from the live feed presented in the <code>TextureView</code>, here is the code to do so and then return the image in bytes:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">camera</span><span class="p">.</span><span class="n">StopPreview</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">ratio</span> <span class="p">=</span> <span class="p">((</span><span class="kt">decimal</span><span class="p">)</span><span class="n">Height</span><span class="p">)</span> <span class="p">/</span> <span class="n">Width</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">image</span> <span class="p">=</span> <span class="n">Bitmap</span><span class="p">.</span><span class="n">CreateBitmap</span><span class="p">(</span><span class="n">liveView</span><span class="p">.</span><span class="n">Bitmap</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">liveView</span><span class="p">.</span><span class="n">Bitmap</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">liveView</span><span class="p">.</span><span class="n">Bitmap</span><span class="p">.</span><span class="n">Width</span> <span class="p">*</span> <span class="n">ratio</span><span class="p">));</span>
<span class="kt">byte</span><span class="p">[]</span> <span class="n">imageBytes</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
<span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">imageStream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">MemoryStream</span><span class="p">())</span>
<span class="p">{</span>
    <span class="k">await</span> <span class="n">image</span><span class="p">.</span><span class="n">CompressAsync</span><span class="p">(</span><span class="n">Bitmap</span><span class="p">.</span><span class="n">CompressFormat</span><span class="p">.</span><span class="n">Jpeg</span><span class="p">,</span> <span class="m">50</span><span class="p">,</span> <span class="n">imageStream</span><span class="p">);</span>
    <span class="n">image</span><span class="p">.</span><span class="n">Recycle</span><span class="p">();</span>
    <span class="n">imageBytes</span> <span class="p">=</span> <span class="n">imageStream</span><span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">camera</span><span class="p">.</span><span class="n">StartPreview</span><span class="p">();</span>
<span class="k">return</span> <span class="n">imageBytes</span><span class="p">;</span></code></pre></figure></p>

<p>And that’s it, after all that code, you can now make use of this camera page. Keep reading to find a sample usage code:</p>

<h2 id=\"usage-in-forms\">Usage in Forms</h2>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">cameraPage</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CameraPage</span><span class="p">();</span>
<span class="n">cameraPage</span><span class="p">.</span><span class="n">OnPhotoResult</span> <span class="p">+=</span> <span class="n">CameraPage_OnPhotoResult</span><span class="p">;</span>
<span class="n">Navigation</span><span class="p">.</span><span class="n">PushModalAsync</span><span class="p">(</span><span class="n">cameraPage</span><span class="p">);&lt;</span><span class="n">br</span> <span class="p">/&gt;</span>
<span class="c1">// …</span>
<span class="k">async</span> <span class="k">void</span> <span class="nf">CameraPage_OnPhotoResult</span><span class="p">(</span><span class="n">Pages</span><span class="p">.</span><span class="n">PhotoResultEventArgs</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">await</span> <span class="n">Navigation</span><span class="p">.</span><span class="n">PopModalAsync</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">result</span><span class="p">.</span><span class="n">Success</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="n">Image</span><span class="p">.</span><span class="n">Source</span> <span class="p">=</span> <span class="n">ImageSource</span><span class="p">.</span><span class="n">FromStream</span><span class="p">(()</span> <span class="p">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="k">new</span> <span class="n">MemoryStream</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">Image</span><span class="p">));</span></code></pre></figure></p>

<p>If you <strong><a href=\"https://github.com/ThatCSharpGuy/Forms-FullCameraPage\" target=\"_blank\">download the source code</a></strong> and run it, you will see something like this:</p>

<iframe width=\"560\" height=\"315\" src=\"https://www.youtube.com/embed/DgFEK9tPKs0\" frameborder=\"0\" allowfullscreen=\"\"></iframe>

<h2 id=\"acknowledgements\">Acknowledgements</h2>
<p>The code for this post was entirely based on the code from the <a href=\"..\Aharphat-Android\" target=\"_blank\">CharpHat</a>, which at the same time was based on the <a href=\"https://blog.xamarin.com/build-your-own-snapchat-clone-with-xamarin-forms-and-azure/\" target=\"_blank\">Moments app</a> by <a href=\"https://github.com/pierceboggan\" target=\"_blank\">Pierce Boggan</a>.</p>
"
}