{	
	"id" : "/post/full-camera-page.1/",
	"tv" : false,
	"date": "2016-11-08 02:00:00 -0600",
	"title" : "Full page camera in Xamarin.Forms",
	"author" : "Antonio Feregrino Bola√±os",
	"featured_image": "http://thatcsharpguy.com/postimages//xamarin-forms/camerapage/featured.jpg",
	"tags" : ["XamarinForms","Xamarin"],
	  
	"content": '"It has been a while since I coded <a href=\"..\\Aharphat-Android\" target=\"_blank\">CharpHat</a>, which is an app that lets you snap a picture of anything and then put a nice C# graduation cap on it. That app was far from perfect, but it helped me to practice the usage of custom page renderers.  \n\nToday I decided to retake that project, but this time trying to isolate the code needed to build the interface and funcionality of the page, so that anyone looking forward to implement a full camera page in their apps could reuse the code for their own projects. So be sure to <strong><a href=\"https://github.com/ThatCSharpGuy/Forms-FullCameraPage\" target=\"_blank\">grab the source code</a></strong> for this post.\n\n## Forms abstractions  \n<small><a href=\"https://github.com/ThatCSharpGuy/Forms-FullCameraPage/blob/master/CameraPage.cs\" target=\"_blank\">Here is the source code for this section.</a></small>  \n\nLet's start by creating the Xamarin.Forms page that will serve as our point of interaction with the custom code:  \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">npublic</span> <span class="k">class</span> <span class="nc">CameraPage</span> <span class="p">:</span> <span class="n">ContentPage</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="k">public</span> <span class="k">delegate</span> <span class="k">void</span> <span class="n">PhotoResultEventHandler</span><span class="p">(</span><span class="n">PhotoResultEventArgs</span> <span class="n">result</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="k">public</span> <span class="k">event</span> <span class="n">PhotoResultEventHandler</span> <span class="n">OnPhotoResult</span><span class="p">;</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nBusiness as usual, create a class deriving from `ContentPage`. I have added an event handler as I want to access the picture taken by the user. Now let's throw in some methods to call whenever an user performs an action in our camera page (in this case, the user will be allowed to take a photo or cancel the action):\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">npublic</span> <span class="k">void</span> <span class="n">SetPhotoResult</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">image</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="n">OnPhotoResult</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">(</span><span class="k">new</span> <span class="n">PhotoResultEventArgs</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">));</span><span class="err">\</span><span class="n">n</span><span class="p">}</span><span class="err">\</span><span class="n">n</span><span class="err">\</span><span class="n">npublic</span> <span class="k">void</span> <span class="n">Cancel</span><span class="p">()</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="n">OnPhotoResult</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">(</span><span class="k">new</span> <span class="n">PhotoResultEventArgs</span><span class="p">());</span><span class="err">\</span><span class="n">n</span><span class="p">}</span> <span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nFor reference, see the properties inside the `PhotoResultEventArgs` class:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">npublic</span> <span class="kt">bool</span> <span class="n">Success</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span><span class="err">\</span><span class="n">npublic</span> <span class="kt">int</span> <span class="n">Width</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span><span class="err">\</span><span class="n">npublic</span> <span class="kt">int</span> <span class="n">Height</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span><span class="err">\</span><span class="n">npublic</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">Image</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nNow, time to move on to the platform specifics. \n\n## In Xamarin.iOS    \n<small><a href=\"https://github.com/ThatCSharpGuy/Forms-FullCameraPage/blob/master/iOS/CameraPageRenderer.cs\" target=\"_blank\">Here is the source code for this section.</a></small>  \n\nTo be honest, this implementation is the easiest by far. Start off by creating a class that inherits from `PageRenderer`, and to add the `ExportRenderer` attribute:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">n</span><span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="n">ExportRenderer</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">CameraPage</span><span class="p">),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">CameraPageRenderer</span><span class="p">))]</span><span class="err">\</span><span class="n">nnamespace</span> <span class="n">FullCameraPage</span><span class="p">.</span><span class="n">iOS</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span><span class="err">\</span><span class="n">tpublic</span> <span class="k">class</span> <span class="nc">CameraPageRenderer</span> <span class="p">:</span> <span class="n">PageRenderer</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nNow, an this is very important, you need to override the `ViewDidLoad` method, since it gets called as soon as our page is loaded by the iOS mechanisms. For the sake of organisation let's split the code in several other methods:  \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">npublic</span> <span class="k">override</span> <span class="k">async</span> <span class="k">void</span> <span class="n">ViewDidLoad</span><span class="p">()</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="k">base</span><span class="p">.</span><span class="n">ViewDidLoad</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>    <span class="n">SetupUserInterface</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>    <span class="n">SetupEventHandlers</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>    <span class="n">AuthorizeCameraUse</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>    <span class="n">SetupLiveCameraStream</span><span class="p">();</span><span class="err">\</span><span class="n">n</span><span class="p">}</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\n### SetupUserInterface \nAs the name states, here is where you need to build the UI. As you may have guessed, it is all done by code, but don't worry, it is very easy... as long as your UI isn't so complex, but you can do whatever you need here.  \n\nFor this sample the UI will consist of a couple of buttons and a surface where the live preview from the camera is going to be shown, so you need to declare them on a class-level scope:  \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nVectorButton</span> <span class="n">takePhotoButton</span><span class="p">;</span><span class="err">\</span><span class="n">nVectorButton</span> <span class="n">cancelPhotoButton</span><span class="p">;</span><span class="err">\</span><span class="n">nUIView</span> <span class="n">liveCameraStream</span><span class="p">;</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nTo set the items in place you need to think as if you were working with a relative layout, meaning that you need to set the position of each item within the screen. For example, look at how the live camera preview view is positioned:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nprivate</span> <span class="k">void</span> <span class="n">SetupUserInterface</span><span class="p">()</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="c1">// Code ommited ...\n    liveCameraStream = new UIView()\n    {\n        Frame = new CGRect(0f, 0f, View.Bounds.Width, View.Bounds.Height)\n    };\n    // Code ommited ...\n    View.Add(liveCameraStream);\n    // Code ommited ...\n}\n</span></code></pre></figure>  \n\n### SetupEventHandlers\nNow that the UI has been built, let's hook up the event handlers to each control, luckly for this sample there are only two buttons on screen: one to take the picture and the other to cancel the whole thing.\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">ncancelPhotoButton</span><span class="p">.</span><span class="n">TouchUpInside</span> <span class="p">+=</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&gt;</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="p">(</span><span class="n">Element</span> <span class="k">as</span> <span class="n">CameraPage</span><span class="p">).</span><span class="n">Cancel</span><span class="p">();</span><span class="err">\</span><span class="n">n</span><span class="p">};</span><span class="err">\</span><span class="n">n</span><span class="err">\</span><span class="n">ntakePhotoButton</span><span class="p">.</span><span class="n">TouchUpInside</span> <span class="p">+=</span> <span class="k">async</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&gt;</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="k">await</span> <span class="n">CapturePhoto</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>    <span class="n">UIImage</span> <span class="n">imageInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UIImage</span><span class="p">(</span><span class="n">data</span><span class="p">);</span><span class="err">\</span><span class="n">n</span><span class="err">\</span><span class="n">n</span>    <span class="p">(</span><span class="n">Element</span> <span class="k">as</span> <span class="n">CameraPage</span><span class="p">).</span><span class="n">SetPhotoResult</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">ToArray</span><span class="p">(),</span><span class="err">\</span><span class="n">n</span>                                           <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">imageInfo</span><span class="p">.</span><span class="n">Size</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span><span class="err">\</span><span class="n">n</span>                                           <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">imageInfo</span><span class="p">.</span><span class="n">Size</span><span class="p">.</span><span class="n">Height</span><span class="p">);</span><span class="err">\</span><span class="n">n</span><span class="p">};</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nThe property `Element` contains a reference to the page associated to the renderer, and is our way to interact with our Forms project. As for the method `CapturePhoto`... we'll see it later. \n\n## AuthorizeCameraUse  \nNow it's time to ask the user for its permission to access the camera: \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nvar</span> <span class="n">authorizationStatus</span> <span class="p">=</span> <span class="n">AVCaptureDevice</span><span class="p">.</span><span class="n">GetAuthorizationStatus</span><span class="p">(</span><span class="n">AVMediaType</span><span class="p">.</span><span class="n">Video</span><span class="p">);</span><span class="err">\</span><span class="n">nif</span> <span class="p">(</span><span class="n">authorizationStatus</span> <span class="p">!=</span> <span class="n">AVAuthorizationStatus</span><span class="p">.</span><span class="n">Authorized</span><span class="p">)</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="k">await</span> <span class="n">AVCaptureDevice</span><span class="p">.</span><span class="n">RequestAccessForMediaTypeAsync</span><span class="p">(</span><span class="n">AVMediaType</span><span class="p">.</span><span class="n">Video</span><span class="p">);</span><span class="err">\</span><span class="n">n</span><span class="p">}</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nBut wait a minute, before executing the code above, make sure you have added the key `Privacy - Camera Usage Description` to the Info.plist in your project.  \n\n### SetupLiveCameraStream\nNow the \"heavy\" stuff.  \n  \nStart by declaring at class-level scope an `AVCaptureSession`, `AVCaptureDeviceInput` and `AVCaptureStillImageOutput`, as they will hel us access the camera, display the live feed and capture the photo.  \n\nThen, inside the `SetupLiveCameraStream` method, initialize the capture session, create a preview layer with the same size as our `liveCameraStream`, and add it as a sublayer of it:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">n</span>    <span class="n">captureSession</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AVCaptureSession</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">videoPreviewLayer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AVCaptureVideoPreviewLayer</span><span class="p">(</span><span class="n">captureSession</span><span class="p">)</span><span class="err">\</span><span class="n">n</span>    <span class="p">{</span><span class="err">\</span><span class="n">n</span>        <span class="n">Frame</span> <span class="p">=</span> <span class="n">liveCameraStream</span><span class="p">.</span><span class="n">Bounds</span><span class="err">\</span><span class="n">n</span>    <span class="p">};</span><span class="err">\</span><span class="n">n</span>    <span class="n">liveCameraStream</span><span class="p">.</span><span class="n">Layer</span><span class="p">.</span><span class="n">AddSublayer</span><span class="p">(</span><span class="n">videoPreviewLayer</span><span class="p">);</span><span class="err">\</span><span class="n">n</span></code></pre></figure>    \n\nNext, \"create\" a capture device (you can configure it to work according to your needs). And then, from it create the an input source for the capture session:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">captureDevice</span> <span class="p">=</span> <span class="n">AVCaptureDevice</span><span class="p">.</span><span class="n">DefaultDeviceWithMediaType</span><span class="p">(</span><span class="n">AVMediaType</span><span class="p">.</span><span class="n">Video</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">ConfigureCameraForDevice</span><span class="p">(</span><span class="n">captureDevice</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">captureDeviceInput</span> <span class="p">=</span> <span class="n">AVCaptureDeviceInput</span><span class="p">.</span><span class="n">FromDevice</span><span class="p">(</span><span class="n">captureDevice</span><span class="p">);</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nWe have an input (the camera of the device), now we need an output which is going to be a jpeg photograph:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">dictionary</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NSMutableDictionary</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>    <span class="n">dictionary</span><span class="p">[</span><span class="n">AVVideo</span><span class="p">.</span><span class="n">CodecKey</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NSNumber</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">AVVideoCodec</span><span class="p">.</span><span class="n">JPEG</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">stillImageOutput</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AVCaptureStillImageOutput</span><span class="p">()</span><span class="err">\</span><span class="n">n</span>    <span class="p">{</span><span class="err">\</span><span class="n">n</span>        <span class="n">OutputSettings</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NSDictionary</span><span class="p">()</span><span class="err">\</span><span class="n">n</span>    <span class="p">};</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nFinalize by setting the input and output of the capture session and starting it: \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">n</span>    <span class="n">captureSession</span><span class="p">.</span><span class="n">AddOutput</span><span class="p">(</span><span class="n">stillImageOutput</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">captureSession</span><span class="p">.</span><span class="n">AddInput</span><span class="p">(</span><span class="n">captureDeviceInput</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">captureSession</span><span class="p">.</span><span class="n">StartRunning</span><span class="p">();</span><span class="err">\</span><span class="n">n</span></code></pre></figure>\n\n### CapturePhoto\nAt last, the icing on the cake, the code to capture the photo. The code is pretty simple: Take the output and capture a still image from it, as we only need the bytes we get an `NSData` containing the taken photo. \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">npublic</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">NSData</span><span class="p">&gt;</span> <span class="n">CapturePhoto</span><span class="p">()</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">videoConnection</span> <span class="p">=</span> <span class="n">stillImageOutput</span><span class="p">.</span><span class="n">ConnectionFromMediaType</span><span class="p">(</span><span class="n">AVMediaType</span><span class="p">.</span><span class="n">Video</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">sampleBuffer</span> <span class="p">=</span> <span class="k">await</span> <span class="n">stillImageOutput</span><span class="p">.</span><span class="n">CaptureStillImageTaskAsync</span><span class="p">(</span><span class="n">videoConnection</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">jpegImageAsNsData</span> <span class="p">=</span> <span class="n">AVCaptureStillImageOutput</span><span class="p">.</span><span class="n">JpegStillToNSData</span><span class="p">(</span><span class="n">sampleBuffer</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="k">return</span> <span class="n">jpegImageAsNsData</span><span class="p">;</span><span class="err">\</span><span class="n">n</span><span class="p">}</span><span class="err">\</span><span class="n">n</span></code></pre></figure>\n\n## In Xamarin.Android    \n<small><a href=\"https://github.com/ThatCSharpGuy/Forms-FullCameraPage/blob/master/Droid/CameraPageRenderer.cs\" target=\"_blank\">Here is the source code for this section.</a></small>    \nThis implementation isn't as clean as it is in iOS. Mainly because Android puts a lot of ephasis in the use of listeners, rather than in event handlers. However, that is not a problem for us.\n\nAs with the iOS implementation, start by creating a new class and make it derive from `PageRenderer` and also make it implement the `TextureView.ISurfaceTextureListener` interface. Don't forget the `ExportRender` attribute:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">n</span><span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="n">Xamarin</span><span class="p">.</span><span class="n">Forms</span><span class="p">.</span><span class="n">ExportRenderer</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">CameraPage</span><span class="p">),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">CameraPageRenderer</span><span class="p">))]</span><span class="err">\</span><span class="n">nnamespace</span> <span class="n">FullCameraPage</span><span class="p">.</span><span class="n">Droid</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="k">public</span> <span class="k">class</span> <span class="nc">CameraPageRenderer</span> <span class="p">:</span> <span class="n">PageRenderer</span><span class="p">,</span> <span class="n">TextureView</span><span class="p">.</span><span class="n">ISurfaceTextureListener</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nThen, override the `OnElementChanged` method (if you have creaated custom renderers before this method may be familar to you), this method is going to be called everytime the a `CamerPage` is shown on screen:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nprotected</span> <span class="k">override</span> <span class="k">void</span> <span class="n">OnElementChanged</span><span class="p">(</span><span class="n">ElementChangedEventArgs</span><span class="p">&lt;</span><span class="n">Xamarin</span><span class="p">.</span><span class="n">Forms</span><span class="p">.</span><span class="n">Page</span><span class="p">&gt;</span> <span class="n">e</span><span class="p">)</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="k">base</span><span class="p">.</span><span class="n">OnElementChanged</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">SetupUserInterface</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>    <span class="n">SetupEventHandlers</span><span class="p">();</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\n### SetupUserInterface  \nIn this method we are supposed to create the camera page itself, you can do it by creating an *axml* file and calling all the Android inflating stuff... Or, like in this sample, you can create it by code.\n\nFor this sample, we'll need a `RelativeLayout` to work as a container, a `TextureView` to display the live feed from the camera, and a `Button` (a `PaintCodeButton` actually) to snap the photograph. Declare all them at class-level scope: \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nRelativeLayout</span> <span class="n">mainLayout</span><span class="p">;</span><span class="err">\</span><span class="n">nTextureView</span> <span class="n">liveView</span><span class="p">;</span><span class="err">\</span><span class="n">nPaintCodeButton</span> <span class="n">capturePhotoButton</span><span class="p">;</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nNow, proceed to create them and add them to the screen, for example, see how we can create the container layout and add the `TextureView` to it:  \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nvoid</span> <span class="n">SetupUserInterface</span><span class="p">()</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="n">mainLayout</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RelativeLayout</span><span class="p">(</span><span class="n">Context</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span> <span class="n">mainLayoutParams</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">(</span><span class="err">\</span><span class="n">n</span>        <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">.</span><span class="n">MatchParent</span><span class="p">,</span><span class="err">\</span><span class="n">n</span>        <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">.</span><span class="n">MatchParent</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">mainLayout</span><span class="p">.</span><span class="n">LayoutParameters</span> <span class="p">=</span> <span class="n">mainLayoutParams</span><span class="p">;</span><span class="err">\</span><span class="n">n</span><span class="err">\</span><span class="n">n</span>    <span class="n">liveView</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TextureView</span><span class="p">(</span><span class="n">Context</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span> <span class="n">liveViewParams</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">(</span><span class="err">\</span><span class="n">n</span>        <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">.</span><span class="n">MatchParent</span><span class="p">,</span> <span class="err">\</span><span class="n">n</span>        <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">.</span><span class="n">MatchParent</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">liveView</span><span class="p">.</span><span class="n">LayoutParameters</span> <span class="p">=</span> <span class="n">liveViewParams</span><span class="p">;</span><span class="err">\</span><span class="n">n</span>    <span class="n">mainLayout</span><span class="p">.</span><span class="n">AddView</span><span class="p">(</span><span class="n">liveView</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="err">\</span><span class="n">n</span>    <span class="c1">// Code ommited...\n\n    AddView(mainLayout);\n}\n</span></code></pre></figure>  \n\nBefore continuing, there is another method (`OnLayout`) we need to override to give our main layout it's size (and acommodate the UI accordingly): \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nprotected</span> <span class="k">override</span> <span class="k">void</span> <span class="n">OnLayout</span><span class="p">(</span><span class="kt">bool</span> <span class="n">changed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="k">base</span><span class="p">.</span><span class="n">OnLayout</span><span class="p">(</span><span class="n">changed</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="k">if</span> <span class="p">(!</span><span class="n">changed</span><span class="p">)</span><span class="err">\</span><span class="n">n</span>        <span class="k">return</span><span class="p">;</span><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">msw</span> <span class="p">=</span> <span class="n">MeasureSpec</span><span class="p">.</span><span class="n">MakeMeasureSpec</span><span class="p">(</span><span class="n">r</span> <span class="p">-</span> <span class="n">l</span><span class="p">,</span> <span class="n">MeasureSpecMode</span><span class="p">.</span><span class="n">Exactly</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">msh</span> <span class="p">=</span> <span class="n">MeasureSpec</span><span class="p">.</span><span class="n">MakeMeasureSpec</span><span class="p">(</span><span class="n">b</span> <span class="p">-</span> <span class="n">t</span><span class="p">,</span> <span class="n">MeasureSpecMode</span><span class="p">.</span><span class="n">Exactly</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">mainLayout</span><span class="p">.</span><span class="n">Measure</span><span class="p">(</span><span class="n">msw</span><span class="p">,</span> <span class="n">msh</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">mainLayout</span><span class="p">.</span><span class="n">Layout</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">r</span> <span class="p">-</span> <span class="n">l</span><span class="p">,</span> <span class="n">b</span> <span class="p">-</span> <span class="n">t</span><span class="p">);</span><span class="err">\</span><span class="n">n</span><span class="err">\</span><span class="n">n</span>    <span class="n">capturePhotoButton</span><span class="p">.</span><span class="n">SetX</span><span class="p">(</span> <span class="n">mainLayout</span><span class="p">.</span><span class="n">Width</span> <span class="p">/</span> <span class="m">2</span> <span class="p">-</span> <span class="m">60</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">capturePhotoButton</span><span class="p">.</span><span class="n">SetY</span><span class="p">(</span><span class="n">mainLayout</span><span class="p">.</span><span class="n">Height</span> <span class="p">-</span> <span class="m">200</span><span class="p">);</span><span class="err">\</span><span class="n">n</span><span class="p">}</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\n### SetupEventHandlers  \nAs I said, Android relies mostly on event listeners rather than handlers, so the code for this method is pretty simple. We need to set an event handler for the \"sutter\" button and assign the listener that will be aware of the `SurfaceTexture` status (remember that our page render implements an interface?):  \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">ncapturePhotoButton</span><span class="p">.</span><span class="n">Click</span> <span class="p">+=</span> <span class="k">async</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&gt;</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">bytes</span> <span class="p">=</span> <span class="k">await</span> <span class="n">TakePhoto</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>    <span class="p">(</span><span class="n">Element</span> <span class="k">as</span> <span class="n">CameraPage</span><span class="p">).</span><span class="n">SetPhotoResult</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">liveView</span><span class="p">.</span><span class="n">Bitmap</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span> <span class="n">liveView</span><span class="p">.</span><span class="n">Bitmap</span><span class="p">.</span><span class="n">Height</span><span class="p">);</span><span class="err">\</span><span class="n">n</span><span class="p">};</span><span class="err">\</span><span class="n">nliveView</span><span class="p">.</span><span class="n">SurfaceTextureListener</span> <span class="p">=</span> <span class="k">this</span><span class="p">;</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nAnd one more thing, let's to override the default behavior of the \"back\" button, so that it acts as a cancel button for the camera:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">npublic</span> <span class="k">override</span> <span class="kt">bool</span> <span class="n">OnKeyDown</span><span class="p">(</span><span class="n">Keycode</span> <span class="n">keyCode</span><span class="p">,</span> <span class="n">KeyEvent</span> <span class="n">e</span><span class="p">)</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="k">if</span> <span class="p">(</span><span class="n">keyCode</span> <span class="p">==</span> <span class="n">Keycode</span><span class="p">.</span><span class="n">Back</span><span class="p">)</span><span class="err">\</span><span class="n">n</span>    <span class="p">{</span><span class="err">\</span><span class="n">n</span>        <span class="p">(</span><span class="n">Element</span> <span class="k">as</span> <span class="n">CameraPage</span><span class="p">).</span><span class="n">Cancel</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>        <span class="k">return</span> <span class="k">false</span><span class="p">;</span><span class="err">\</span><span class="n">n</span>    <span class="p">}</span><span class="err">\</span><span class="n">n</span>    <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="n">OnKeyDown</span><span class="p">(</span><span class="n">keyCode</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span><span class="err">\</span><span class="n">n</span><span class="p">}</span><span class="err">\</span><span class="n">n</span></code></pre></figure>   \n\n### TextureView.ISurfaceTextureListener implementation  \nNow is time to implement the core of our page. Start by writing the code for the `OnSurfaceTextureAvailable` where we will prepare the output for the camera, but first we'll need a camera, right?\n\nAt class-level scope declare a `Camera`:  \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nAndroid</span><span class="p">.</span><span class="n">Hardware</span><span class="p">.</span><span class="n">Camera</span> <span class="n">camera</span><span class="p">;</span><span class="err">\</span><span class="n">n</span></code></pre></figure>\n \nInside the method, open the camera (by default it'll try to open the back camera of the device) and get its parameters. We need them to select the right preview size, because we want things to look great in our app:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">ncamera</span> <span class="p">=</span> <span class="n">Android</span><span class="p">.</span><span class="n">Hardware</span><span class="p">.</span><span class="n">Camera</span><span class="p">.</span><span class="n">Open</span><span class="p">();</span><span class="err">\</span><span class="n">nvar</span> <span class="n">parameters</span> <span class="p">=</span> <span class="n">camera</span><span class="p">.</span><span class="n">GetParameters</span><span class="p">();</span><span class="err">\</span><span class="n">n</span></code></pre></figure> \n\nOnce we have the parameters at hand, we can get the avaliable `PreviewSizes` and get the one that fits our preview surface. In this case I'm using a simple <a href=\"#\">linq expression</a> to get the best preview size based on aspect ratio:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nvar</span> <span class="n">aspect</span> <span class="p">=</span> <span class="p">((</span><span class="kt">decimal</span><span class="p">)</span><span class="n">height</span><span class="p">)</span> <span class="p">/</span> <span class="p">((</span><span class="kt">decimal</span><span class="p">)</span><span class="n">width</span><span class="p">);</span><span class="err">\</span><span class="n">n</span><span class="err">\</span><span class="n">nvar</span> <span class="n">previewSize</span> <span class="p">=</span> <span class="n">parameters</span><span class="p">.</span><span class="n">SupportedPreviewSizes</span><span class="err">\</span><span class="n">n</span>                            <span class="p">.</span><span class="n">OrderBy</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">Math</span><span class="p">.</span><span class="n">Abs</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">Width</span> <span class="p">/</span> <span class="p">(</span><span class="kt">decimal</span><span class="p">)</span><span class="n">s</span><span class="p">.</span><span class="n">Height</span> <span class="p">-</span> <span class="n">aspect</span><span class="p">))</span><span class="err">\</span><span class="n">n</span>                            <span class="p">.</span><span class="n">First</span><span class="p">();</span><span class="err">\</span><span class="n">n</span><span class="err">\</span><span class="n">nparameters</span><span class="p">.</span><span class="n">SetPreviewSize</span><span class="p">(</span><span class="n">previewSize</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span> <span class="n">previewSize</span><span class="p">.</span><span class="n">Height</span><span class="p">);</span><span class="err">\</span><span class="n">ncamera</span><span class="p">.</span><span class="n">SetParameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">);</span><span class="err">\</span><span class="n">n</span></code></pre></figure> \n\nFinish by setting our surface as the preview texture, at this point the only thing left to do is to start the camera:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">ncamera</span><span class="p">.</span><span class="n">SetPreviewTexture</span><span class="p">(</span><span class="n">surface</span><span class="p">);</span><span class="err">\</span><span class="n">nStartCamera</span><span class="p">();</span><span class="err">\</span><span class="n">n</span></code></pre></figure> \n\nThe other method we need to write code into is `OnSurfaceTextureDestroyed` in order to stop the camera, so just write the following inside and it'll be all:  \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nStopCamera</span><span class="p">();</span><span class="err">\</span><span class="n">nreturn</span> <span class="k">true</span><span class="p">;</span><span class="err">\</span><span class="n">n</span></code></pre></figure> \n\n### StartCamera and StopCamera\nThese two methods are quite simple too, for `StartCamera` we only need to rotate the preview to make it look right in the screen (in this case I'm setting it to be viewed vertically), and then finally, start the camera:   \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">ncamera</span><span class="p">.</span><span class="n">SetDisplayOrientation</span><span class="p">(</span><span class="m">90</span><span class="p">);</span><span class="err">\</span><span class="n">ncamera</span><span class="p">.</span><span class="n">StartPreview</span><span class="p">();</span><span class="err">\</span><span class="n">n</span></code></pre></figure> \n\nThe `StopCamera` method stops the preview and releases the camera, so that other apps can access to it:   \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">ncamera</span><span class="p">.</span><span class="n">StopPreview</span><span class="p">();</span><span class="err">\</span><span class="n">ncamera</span><span class="p">.</span><span class="n">Release</span><span class="p">();</span><span class="err">\</span><span class="n">n</span></code></pre></figure> \n\n### TakePhoto\n\nIn order to get a photo, the only thing we need to do is get an sitll image from the live feed presented in the `TextureView`, here is the code to do so and then return the image in bytes:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">ncamera</span><span class="p">.</span><span class="n">StopPreview</span><span class="p">();</span><span class="err">\</span><span class="n">nvar</span> <span class="n">ratio</span> <span class="p">=</span> <span class="p">((</span><span class="kt">decimal</span><span class="p">)</span><span class="n">Height</span><span class="p">)</span> <span class="p">/</span> <span class="n">Width</span><span class="p">;</span><span class="err">\</span><span class="n">nvar</span> <span class="n">image</span> <span class="p">=</span> <span class="n">Bitmap</span><span class="p">.</span><span class="n">CreateBitmap</span><span class="p">(</span><span class="n">liveView</span><span class="p">.</span><span class="n">Bitmap</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">liveView</span><span class="p">.</span><span class="n">Bitmap</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">liveView</span><span class="p">.</span><span class="n">Bitmap</span><span class="p">.</span><span class="n">Width</span> <span class="p">*</span> <span class="n">ratio</span><span class="p">));</span><span class="err">\</span><span class="n">nbyte</span><span class="p">[]</span> <span class="n">imageBytes</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span><span class="err">\</span><span class="n">nusing</span> <span class="p">(</span><span class="kt">var</span> <span class="n">imageStream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">MemoryStream</span><span class="p">())</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="k">await</span> <span class="n">image</span><span class="p">.</span><span class="n">CompressAsync</span><span class="p">(</span><span class="n">Bitmap</span><span class="p">.</span><span class="n">CompressFormat</span><span class="p">.</span><span class="n">Jpeg</span><span class="p">,</span> <span class="m">50</span><span class="p">,</span> <span class="n">imageStream</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">image</span><span class="p">.</span><span class="n">Recycle</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>    <span class="n">imageBytes</span> <span class="p">=</span> <span class="n">imageStream</span><span class="p">.</span><span class="n">ToArray</span><span class="p">();</span><span class="err">\</span><span class="n">n</span><span class="p">}</span><span class="err">\</span><span class="n">ncamera</span><span class="p">.</span><span class="n">StartPreview</span><span class="p">();</span><span class="err">\</span><span class="n">nreturn</span> <span class="n">imageBytes</span><span class="p">;</span><span class="err">\</span><span class="n">n</span></code></pre></figure> \n\nAnd that's it, after all that code, you can now make use of this camera page. Keep reading to find a sample usage code:\n\n## Usage in Forms  \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nvar</span> <span class="n">cameraPage</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CameraPage</span><span class="p">();</span><span class="err">\</span><span class="n">ncameraPage</span><span class="p">.</span><span class="n">OnPhotoResult</span> <span class="p">+=</span> <span class="n">CameraPage_OnPhotoResult</span><span class="p">;</span><span class="err">\</span><span class="n">nNavigation</span><span class="p">.</span><span class="n">PushModalAsync</span><span class="p">(</span><span class="n">cameraPage</span><span class="p">);</span>  <span class="err">\</span><span class="n">n</span><span class="c1">// ...\nasync void CameraPage_OnPhotoResult(Pages.PhotoResultEventArgs result)\n{\n    await Navigation.PopModalAsync();\n    if (!result.Success)\n        return;\n    Image.Source = ImageSource.FromStream(() =&gt; new MemoryStream(result.Image));\n</span></code></pre></figure>  \n\nIf you <strong><a href=\"https://github.com/ThatCSharpGuy/Forms-FullCameraPage\" target=\"_blank\">download the source code</a></strong> and run it, you will see something like this:\n\n<iframe width=\"560\" height=\"315\" src=\"https://www.youtube.com/embed/DgFEK9tPKs0\" frameborder=\"0\" allowfullscreen></iframe>\n\n\n\n## Acknowledgements \nThe code for this post was entirely based on the code from the <a href=\"..\\Aharphat-Android\" target=\"_blank\">CharpHat</a>, which at the same time was based on the <a href=\"https://blog.xamarin.com/build-your-own-snapchat-clone-with-xamarin-forms-and-azure/\" target=\"_blank\">Moments app</a> by <a href=\"https://github.com/pierceboggan\" target=\"_blank\">Pierce Boggan</a>."'   
}