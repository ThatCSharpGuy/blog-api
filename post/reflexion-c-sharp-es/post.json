{	
	"id" : "/post/reflexion-c-sharp-es/",
	"tv" : false,
	"date": "2016-10-10 14:00:01 -0500",
	"title" : "Reflexión en C#",
	"author" : "Antonio Feregrino Bolaños",
	"featured_image": "http://thatcsharpguy.com/postimages//aprende-c-sharp/reflexion.jpg",
	"tags" :
	[ 
		"AprendeCSharp"
	],
	"content" : "<p>La reflexión en C# es solo otra de las caracterísitcas que el lenguaje nos entrega para desarrollar con él. No es una característica tan conocida por todos los desarrolladores y me atrevería a decir que de los que lo conocen, no todas la usan y es que no es necesaria usarla en todos los programas.</p>

<p>La reflexión nos permite acceder a la información de un tipo en tiempo de ejecución. Cuando estamos escribiendo el código, somos nosotros quienes tenemos una idea general del sistema: sabemos los tipos de dato de las variables, los métodos que contienen las clases, los atributos de los miembros de estas y un sin fin de cosas más. Otro elemento que conoce <em>todo</em> de nuestro programa es el compilador, ya que sabe si estamos usando los tipos correctos para llamar a los métodos o tenemos permiso para acceder a determinado miembro de una clase.</p>

<p>Sin embargo, una vez que se compila, el programa no tiene idea de los tipos de dato, métodos y demás complejidades del programa, por ejemplo, el siguiente programa no sabe que <code>zero</code> es del tipo <code>string</code>:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">zero</span> <span class="p">=</span> <span class="err">“</span><span class="m">0</span><span class="err">”</span><span class="p">;</span></code></pre></figure></p>

<p>No es sino hasta que empleamos la reflexión que el programa tiene acceso a esta información a través de un tipo <code>Type</code>:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="n">zero</span><span class="p">.</span><span class="n">GetType</span><span class="p">();</span>
<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">type</span><span class="p">);</span> <span class="c1">// System.String</span></code></pre></figure></p>

<p>También se puede acceder al ensamblado al que pertenece el tipo <code>String</code>:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Assembly</span> <span class="n">assembly</span> <span class="p">=</span> <span class="n">type</span><span class="p">.</span><span class="n">Assembly</span><span class="p">;</span>
<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">type</span><span class="p">.</span><span class="n">Assembly</span><span class="p">);</span> <span class="c1">// mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</span></code></pre></figure></p>

<p>Y a partir de un ensamblado podemos obtener todos sus tipos con el método <code>GetTypes</code>, en este caso, además de obteneros, también los estamos filtrando, seleccionando solo aquellos cuyo nombre comience con “Int32”:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">ty</span> <span class="k">in</span> <span class="n">assembly</span><span class="p">.</span><span class="n">GetTypes</span><span class="p">()</span>
    <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">ty</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="n">StartsWith</span><span class="p">(</span><span class="err">“</span><span class="n">Int32</span><span class="err">”</span><span class="p">)))</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">ty</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure></p>

<p>Otro de las cosas que podemos hacer empleando la reflexión, es instanciar tipos de dato a partir de una instancia de <code>Type</code> y la clase <code>Activator</code>:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">int32Type</span> <span class="p">=</span> <span class="n">assembly</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="err">“</span><span class="n">System</span><span class="p">.</span><span class="n">Int32</span><span class="err">”</span><span class="p">);&lt;/</span><span class="n">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="kt">var</span> <span class="n">createdInt</span>  <span class="p">=</span> <span class="n">Activator</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">(</span><span class="n">int32Type</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">createdInt</span><span class="p">);</span> <span class="c1">// 0</span></code></pre></figure></p>

<p>Como ya habíamos visto antes, mediante los <a href=\"../atributos-c-sharp\" target=\"_blank\">atributos en C#</a> podemos proveer a los programas de metadatos, como es la clase <code>Smartphone</code> (cuya implementación puedes <a href=\"https://github.com/ThatCSharpGuy/aprende-c-sharp/blob/master/Reflexion/Smartphone.cs#L10\" target=\"_blank\">encontrar aquí</a>).</p>

<p>El siguiente ejemplo de código obtiene todos los atributos de la propiedad <code>Carrier</code>:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">phone</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Smartphone</span><span class="p">();</span>
<span class="n">phone</span><span class="p">.</span><span class="n">IsLocked</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
<span class="n">phone</span><span class="p">.</span><span class="n">Carrier</span> <span class="p">=</span> <span class="err">“</span><span class="n">Entel</span><span class="err">”</span><span class="p">;&lt;/</span><span class="n">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="kt">var</span> <span class="n">t</span> <span class="p">=</span> <span class="n">phone</span><span class="p">.</span><span class="n">GetType</span><span class="p">();&lt;/</span><span class="n">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="kt">var</span> <span class="n">carrierProperty</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="n">GetProperty</span><span class="p">(</span><span class="err">“</span><span class="n">Carrier</span><span class="err">”</span><span class="p">);&lt;/</span><span class="n">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">att</span> <span class="k">in</span> <span class="n">carrierProperty</span><span class="p">.</span><span class="n">GetCustomAttributes</span><span class="p">())</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">att</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure></p>

<p>El resultado de ejecutar el código anterior es:</p>

<pre>
RequiredAttribute
ValidCarrierAttribute
DisplayAttribute
</pre>

<p>Que son los atributos que tiene la propiedad <code>Carrier</code>.</p>

<p>Y si queremos, podemos hacer cosas un poco más complejas. Por ejemplo, si deseamos encontrar todas las propiedades que tengan <code>DisplayAttribute</code> podemos buscarlas con <a href=\"../linq-en-c-sharp\">Linq</a>:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">propertiesWithDisplayName</span> <span class="p">=</span> <span class="k">from</span> <span class="n">prop</span> <span class="k">in</span> <span class="n">t</span><span class="p">.</span><span class="n">GetProperties</span><span class="p">()</span>
                                <span class="k">where</span> <span class="n">prop</span><span class="p">.</span><span class="n">GetCustomAttributes</span><span class="p">&lt;</span><span class="n">displayattribute</span><span class="p">&gt;().</span><span class="n">Any</span><span class="p">()</span>
                                <span class="k">select</span> <span class="n">prop</span><span class="p">;</span></code></pre></figure></displayattribute></p>

<p>Para luego mostrar los valores de una manera “amigable”:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">property</span> <span class="k">in</span> <span class="n">propertiesWithDisplayName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">attr</span> <span class="p">=</span> <span class="n">property</span><span class="p">.</span><span class="n">GetCustomAttribute</span><span class="p">&lt;</span><span class="n">displayattribute</span><span class="p">&gt;();</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">attr</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="err">\</span><span class="s">&quot;: \&quot; + property.GetValue(phone));</span>
<span class="p">}</span></code></pre></figure></displayattribute></p>

<p>Ejecutar el código anterior dará como resultado:</p>

<pre>
Compañía: Entel
Bloqueado: true
</pre>

<p>Ya para terminar, otra de las posiblidades que nos da la reflexión en C# es la de modificar los valores de una variable o propiedad en tiempo de ejecución con solo tener su nombre. Toma en cuenta el código siguiente, en donde se solicita al usuario ingresar el nombre de una propiedad y se busca dicha propiedad en el tipo <code>Smartphone</code>:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="err">“</span><span class="n">Escribe</span> <span class="n">el</span> <span class="n">nombre</span> <span class="n">de</span> <span class="n">la</span> <span class="n">propiedad</span> <span class="n">a</span> <span class="n">modificar</span><span class="p">:</span><span class="err">”</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">propertyName</span> <span class="p">=</span> <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">propertyToModify</span> <span class="p">=</span> <span class="n">phoneType</span><span class="p">.</span><span class="n">GetProperty</span><span class="p">(</span><span class="n">propertyName</span><span class="p">);</span></code></pre></figure></p>

<p>Después se verifica que la propiedad exista (el método <code>GetProperty</code> regresa <code>null</code> si no encuentra una propiedad con el nombre indicado) y si existe, solicitamos el nuevo valor para la propiedad:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">if</span> <span class="p">(</span><span class="n">propertyToModify</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="err">“</span><span class="n">Escribe</span> <span class="n">el</span> <span class="n">valor</span><span class="p">:</span><span class="err">”</span><span class="p">);</span>
    <span class="kt">var</span> <span class="k">value</span> <span class="p">=</span> <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
    <span class="c1">// Efectuar conversión … </span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="err">“</span><span class="n">La</span> <span class="n">propiedad</span> <span class="err">“</span> <span class="p">+</span> <span class="n">propertyName</span> <span class="p">+</span> <span class="err">“</span> <span class="n">no</span> <span class="n">existe</span><span class="err">”</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure></p>

<p>Para efectuar la conversión debemso recurrir, nuevamente, a la reflexión. A través del método <code>SetValue</code> y la clase <code>Convert</code>:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">propertyToModify</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">phone</span><span class="p">,</span> <span class="n">Convert</span><span class="p">.</span><span class="n">ChangeType</span><span class="p">(</span><span class="k">value</span><span class="p">,</span> <span class="n">propertyToModify</span><span class="p">.</span><span class="n">PropertyType</span><span class="p">));</span></code></pre></figure></p>

<h2 id=\"usos-de-la-reflexin\">Usos de la reflexión</h2>
<p>Si tu trabajo es el de ser un desarrollador de aplicaciones para usuario final, tal vez no le veas mucho uso a esta poderosa característica, sin embargo, usándola se puede</p>

<ul>
  <li>Acceder a los metadatos y conocer los atributos de cada uno de los componentes de un programa</li>
  <li>Instanciar clases en tiempo de ejecución</li>
  <li>Tener acceso a métodos, propiedades y cualquier otro miembro privado de los tipos de dato</li>
</ul>

<h2 id=\"para-finalizar\">Para finalizar</h2>
<p>Es importante señalar que en este post doy apenas una mínima introducción a lo que se puede hacer, esperando despertar tu interés. También debes saber que hacer uso de la reflexión hará que un programa se ejecute un poco más lento que si no se usara, ya que se realizan operaciones un poco más complejas.</p>
"
}