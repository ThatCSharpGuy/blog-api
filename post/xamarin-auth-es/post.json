{	
	"id" : "/post/xamarin-auth-es/",
	"tv" : false,
	"date": "2016-10-17 14:00:01 -0500",
	"title" : "OAuth en Forms con Xamarin.Auth",
	"author" : "Antonio Feregrino Bolaños",
	"featured_image": "http://thatcsharpguy.com/postimages//xamarin/auth/featured.jpg",
	"tags" :
	["Xamarin","XamarinForms","NuGetRecomendado"],
	
	"content" : body"<div class=\"warning\">\nEste post debe ser usado como guía, como sabrás, en ningún momento es buena idea dejar poner en tu código cualquier tipo de llave que no quieres que sea pública (como los AppSecrets o los Tokens). Te recomiendo visitar estos elnaces: <a href=\"http://www.androidauthority.com/how-to-hide-your-api-key-in-android-600583/\" target=\"blank\">How to hide your key</a> y <a href=\"https://stormpath.com/blog/the-ultimate-guide-to-mobile-api-security\" target=\"blank\">The Ultimate Guide to Mobile API Security</a> para mayor información.\n</div>\nEs un hecho que las redes sociales están dominando el mundo, y que tu app tenga conexión con alguna (o varias) de ellas es una característica que tal vez tus usuarios apreciarían en ella. Sin embargo, para acceder a ellas es necesario contar con el permiso de los usuarios, ¿cierto?  \n\nPara nuestra suerte, muchos servicios proporcionan una forma rápida y estandarizada de solicitar dicho permiso de ellos y es través de <a href=\"https://oauth.net\" target=\"_blank\">OAuth</a>. Sin embargo, el proceso que ocurre despues de que los usuarios nos han dado permiso no es <a href=\"https://oauth.net/core/diagram.png\" target=\"_blank\">tan sencillo como parece</a>, para nuestra suerte, **Xamarin.Auth** nos ofrece una forma de ejecutar este proceso de manera sencilla y en unas cuantas líneas de código.  \n\nEn este post, trataré de explicar cómo usar Xamarin.Auth para conectarse con GitHub, Facebook y Twitter.\n\n## Registrando aplicaciones en servicios  \nPrimero que nada, tenemos que registrar nuestras aplicaciones en los servicios de terceros: \n\n### GitHub  \nLo primero que tienes que hacer es darte de alta en el programa de desarrolladores de GitHub en <a href=\"https://developer.github.com/program/\" target=\"_blank\">este enlace</a> y una vez que lo hayas hecho, debes dirigirte a <a href=\"https://github.com/settings/developers\" target=\"_blank\">este otro enlace</a> en donde podrás registrar tu nueva app, en la pantalla de registro debes poner los datos de tu app, pero debes colocar `https://github.com` en el campo *\"Authorization callback URL\"*: \n\n{% post_image github-developer-2.jpg \"Registro de nueva aplicación\" %} \n\nUna vez que has completado estos pasos, tu aplicación estará registrada y lista para usarse, una vez creada te aparecerán dos valores que son muy importantes y que debes guardar con mucho cuidado: \n\n{% post_image github-keys.jpg \"GitHub keys\" %} \n\n### Facebook  \nPara Facebook la cosa no es tan diferente, debes acceder a <a href=\"https://developers.facebook.com\" target=\"_blank\">https://developers.facebook.com</a> y registrarte como desarrollador para después registrar tu aplicación en el mismo sitio. Ahora, después de elegir un nombre para nuestra aplicación, de proporcionar un correo electrónico para contacto y resolver un captcha, nos aparecerá una pantalla con un menú como el siguiente y en el cual debemos dar click en *\"Add product\"* y seleccionar *\"Facebook Login\"*:  \n\n{% post_image fb-app-addlogin.jpg \"Add product\" %}\n\nUna vez que hayamos hecho esto, del lado izquierdo, aparecerá un nuevo ítem en el menú llamado, justamente, *\"Facebook Login\"* con dos opciones debajo, damos click en *\"Settings\"*, después de esto aparecerá un formulario, en donde lo que tenemos que modificar es el campo *\"Valid OAuth redirect URIs\"*, en donde debes colocar lo siguiente: `https://www.facebook.com/connect/login_success.html`:\n\n{% post_image oauthredirectaddr.png \"Modificar url de redirección\" %}\n\nGuardamos los cambios y ahora, en el menú de la izquierda damos click en *\"Dashboard\"*, que nos llevará a la pantalla inicial de nuestra app, de donde debemos copiar el valor de *\"App ID\"* y listo, hemos terminado de registrar nuestra app en Facebook.\n\n### Twitter  \nBásicamente, ahora que has registrado tu app en GitHub y Facebook, sabrás más o menos qué esperar con Twitter. Primero, tienes que iniciar el registro de tu app en <a href=\"https://apps.twitter.com\" target=\"_blank\">https://apps.twitter.com</a>, de nuevo, debemos ingresar detalles sobre la app y, **muy importante**, en el campo *\"Callback URL\"* debemos colocar `https://mobile.twitter.com/home`. Una vez dada de alta, tendremos acceso a una *\"Consumer Key\"* y a un *\"Consumer Secret\"*, este último debe permanecer **siempre secreto**:  \n\n{% post_image twttr-keys.jpg \"Llaves Twitter\" %}\n\nBien, hemos terminado el papeleo, ahora, a escribir código:  \n\n## En el proyecto de Forms  \n\nComenzaremos por crear una interfaz que especifique algunas de las propiedades comunes a la hora de realizar la autenticación:\n\n{% highlight csharp %}\npublic interface IKeys\n{\n    string ClientId { get; }\n    string ClientSecret { get; }\n    string Scope { get; }\n    string AuthorizeUrl { get; }\n    string RedirectUrl { get; }\n    string RequestTokenUrl { get; }\n    string AccessTokenUrl { get; }\n    string ConsumerSecret { get; }\n    string ConsumerKey { get; }\n    string CallbackUrl { get; }\n}\n{% endhighlight %}  \n\nAhora es cuando tenemos que usar los valores obtenidos en la fase de \"El Papeleo\", creamos una clase por cada servicio conectado, fijate cómo es que las clases implementan la interfaz IKey:\n\n{% highlight csharp %}\t\npublic class FacebookKeys : IKeys\n{\n    public string ClientId { get; } = \"XXXXXXXXX\"; // El valor de App ID en el Dashobard\n    public string AuthorizeUrl { get; } = \"https://m.facebook.com/dialog/oauth/\";\n    public string RedirectUrl { get; } = \"https://www.facebook.com/connect/login_success.html\";\n    // ...\n\npublic class GitHubKeys : IKeys\n{\n    public string ClientId => \"XXXXXXXXXX\"; // El valor de Client Id de GitHub\n    public string ClientSecret => \"XXXXXXXXXXXXXXXX\"; // El valor de Client Secret de GitHub\n    public string AccessTokenUrl { get; } = \"https://github.com/login/oauth/access_token\";\n    public string AuthorizeUrl { get; } = \"https://github.com/login/oauth/authorize\";\n    public string RedirectUrl { get; } = \"https://github.com\";\n    // ...\n\npublic class TwitterKeys : IKeys\n{\n    public string ConsumerKey { get; } = \"EnPK4XXXXXXXtrwXXXXXXXEm\"; // Consumer Key de Twitter\n    public string ConsumerSecret => \"FhSHfXXXXXXXXyu0ZqXXXXXXXXXXXXhbFcr8ETG2p\"; // Consumer Secret de Twitter\n    public string AccessTokenUrl { get; } = \"https://api.twitter.com/oauth/access_token\";\n    public string AuthorizeUrl { get; } = \"https://api.twitter.com/oauth/authorize\";\n    public string RedirectUrl { get; } = \"https://mobile.twitter.com/home\";\n    public string RequestTokenUrl => \"https://api.twitter.com/oauth/request_token\";\n    public string CallbackUrl => \"https://mobile.twitter.com/home\";\n    //\n{% endhighlight %}  \n\nAdemás de un <a href=\"../c-sharp-enums\" target=\"_blank\">tipo <code>enum</code></a> que represente a los servicios que podemos usar, usamos un `enum` para evitar usar cadenas mágicas en el código: \n\n{% highlight csharp %}\npublic enum Services\n{\n    GitHub,\n    Facebook,\n    Twitter\n}\n{% endhighlight %}  \n\nDado que Xamarin.Auth hace uso de APIs nativas de cada platforma, sus métodos son únicamente accesibles en los proyectos \"cliente\" y no desde el núcleo de nuestra aplicación, es por eso que para interactuar con ella indepentiéntemente de la plataforma, necesitamos hacer uso de una interfaz: \n\n{% highlight csharp %}\npublic interface IAccountManagerService\n{\n    List<Services> Accounts { get; }\n\n    string GetPropertyFromAccount(Services service, string property);\n\n    void EraseAll();\n}\n{% endhighlight %}  \n\nLa pantalla de autorización es una nueva `Activity` o un nuevo `UIViewController`, dependiendo de la plataforma, y como desde Forms no tenemos acceso a estas clases, de nuevo creamos una solución independiente de la plataforma. En este caso lo haremos a través de un <a href=\"https://developer.xamarin.com/guides/xamarin-forms/custom-renderer/contentpage/\" target=\"_blank\"><i>Custom renderer</i></a> de una `ContentPage`:\n\n{% highlight csharp %}\npublic class AuthorizePage : ContentPage\n{\n    public Services Service { get; private set; }\n\n    public AuthorizePage(Services service)\n    {\n        Service = service;\n    }\n}\n{% endhighlight %}  \n\nComo puedes ver, tiene una propiedad llamada `Service` del tipo `Service`, a través de la cual especificaremos a cuál de los servicios nos vamos a conectar. Más adelante demostraré el uso de este tipo de páginas.\n\n## En Xamarin.iOS y Xamarin.Android\nUna vez terminado el código multiplataforma, vamos a trabajar con los proyectos de iOS y Android; como las diferencias entre un código y otro son mínimas, podemos utilizar un proyecto compartido y usar <a href=\"../directivas-preprocesador-c-sharp\" target=\"_blank\">directivas de preprocesador</a> para compilar determinadas porciones de código de acuerdo al proyecto que estamos ejecutando.\n\nComenzaremos por implementar la interfaz `IAccountManagerService` a través de la que interactuaremos con el servicio de gestión de cuentas de Xamarin.Auth:\n\n{% highlight csharp %}\nusing System;\nusing System.Linq;\nusing System.Collections.Generic;\nusing Authy.AccountManagement;\n\n#if __IOS__\nnamespace Authy.iOS.AccountManagement\n#elif __ANDROID__\nnamespace Authy.Droid.AccountManagement\n#endif\n{\n\tpublic class AccountManagementImplementation : IAccountManagerService\n\t{\n\t\tpublic List<Services> Accounts\n\t\t{\n\t\t\tget\n\t\t\t{\n\t\t\t\tvar accounts = new List<Services>();\n\t\t\t\tvar accountStore = Xamarin.Auth.AccountStore.Create();\n\t\t\t\tforeach (var service in Enum.GetNames(typeof(Services)))\n\t\t\t\t{\n\t\t\t\t\tvar acc = accountStore.FindAccountsForService(service).FirstOrDefault();\n\t\t\t\t\tif (acc != null)\n\t\t\t\t\t{\n\t\t\t\t\t\taccounts.Add((Services)Enum.Parse(typeof(Services), service));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn accounts;\n\t\t\t}\n\t\t}\n\n\t\tpublic void EraseAll()\n\t\t{\n\t\t\tvar accountStore = Xamarin.Auth.AccountStore.Create();\n\t\t\tforeach (var service in Enum.GetNames(typeof(Services)))\n\t\t\t{\n\t\t\t\tvar acc = accountStore.FindAccountsForService(service).FirstOrDefault();\n\t\t\t\tif (acc != null)\n\t\t\t\t{\n\t\t\t\t\taccountStore.Delete(acc, service);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tpublic string GetPropertyFromAccount(Services service, string property)\n\t\t{\n\t\t\tvar accountStore = Xamarin.Auth.AccountStore.Create();\n\t\t\tvar account = accountStore.FindAccountsForService(service.ToString()).FirstOrDefault();\n\t\t\tif (account != null)\n\t\t\t{\n\t\t\t\treturn account.Properties[property];\n\t\t\t}\n\t\t\treturn null;\n\t\t}\n\t}\n}\n{% endhighlight %}  \n\nPara esta ocasión estaremos usando otra de las herramientas de XF, el <a href=\"https://developer.xamarin.com/guides/xamarin-forms/dependency-service/\" target=\"_blank\">DependencyService</a>, así que no te olvides de colocar la siguiente línea en tu archivo:\n\n{% highlight csharp %}\n[assembly: Xamarin.Forms.Dependency(typeof(AccountsImplementation))]\n{% endhighlight %}  \n\nDespués, es momento de implementar el *custom renderer* de la página con la que vamos a solicitar la autorización: \n\n{% highlight csharp %}\nusing System;\nusing Authy.AccountManagement;\nusing Xamarin.Forms;\nusing Xamarin.Auth;\n#if __IOS__\nusing Xamarin.Forms.Platform.iOS;\n#elif __ANDROID__\nusing Xamarin.Forms.Platform.Android;\n#endif\n\n#if __IOS__\n[assembly: ExportRenderer(typeof(AuthorizePage), typeof(Authy.iOS.AccountManagement.AuthorizePageRenderer))]\nnamespace Authy.iOS.AccountManagement\n#elif __ANDROID__\n[assembly: ExportRenderer(typeof(AuthorizePage), typeof(Authy.Droid.AccountManagement.AuthorizePageRenderer))]\nnamespace Authy.Droid.AccountManagement\n#endif\n{\n\tpublic class AuthorizePageRenderer : PageRenderer\n\t{\n\n#if __IOS__\n\t\tpublic override void ViewDidAppear(bool animated)\n\t\t{\n\t\t\tbase.ViewDidAppear(animated);\n#elif __ANDROID__\n\t\tprotected override void OnElementChanged(ElementChangedEventArgs<Page> e)\n\t\t{\n\t\t\tbase.OnElementChanged(e);\n\t\t\tvar activity = this.Context as Android.App.Activity;\n#endif\n\n\n\t\t\tOAuth2Authenticator auth2 = null;\n\t\t\tOAuth1Authenticator auth1 = null;\n\t\t\tIKeys keys = null;\n\n\t\t\tvar authPage = Element as AuthorizePage;\n\n\t\t\tswitch (authPage.Service)\n\t\t\t{\n\t\t\t\tcase Services.Facebook:\n\t\t\t\t\tkeys = new FacebookKeys();\n\t\t\t\t\tauth2 = new OAuth2Authenticator(\n\t\t\t\t\t\tclientId: keys.ClientId,\n\t\t\t\t\t\tscope: keys.Scope,\n\t\t\t\t\t\tauthorizeUrl: new Uri(keys.AuthorizeUrl),\n\t\t\t\t\t\tredirectUrl: new Uri(keys.RedirectUrl));\n\t\t\t\t\tbreak;\n\t\t\t\tcase Services.Twitter:\n\t\t\t\t\tkeys = new TwitterKeys();\n\t\t\t\t\tauth1 = new OAuth1Authenticator(\n\t\t\t\t\t\t\tconsumerKey: keys.ConsumerKey,\n\t\t\t\t\t\t\tconsumerSecret: keys.ConsumerSecret,\n\t\t\t\t\t\t\trequestTokenUrl: new Uri(keys.RequestTokenUrl),\n\t\t\t\t\t\t\tauthorizeUrl: new Uri(keys.AuthorizeUrl),\n\t\t\t\t\t\t\taccessTokenUrl: new Uri(keys.AccessTokenUrl),\n\t\t\t\t\t\t\tcallbackUrl: new Uri(keys.CallbackUrl));\n\t\t\t\t\tbreak;\n\t\t\t\tcase Services.GitHub:\n\t\t\t\t\tkeys = new GitHubKeys();\n\t\t\t\t\tauth2 = new OAuth2Authenticator(\n\t\t\t\t\t\tclientId: keys.ClientId,\n\t\t\t\t\t\tclientSecret: keys.ClientSecret,\n\t\t\t\t\t\tscope: keys.Scope,\n\t\t\t\t\t\tauthorizeUrl: new Uri(keys.AuthorizeUrl),\n\t\t\t\t\t\tredirectUrl: new Uri(keys.RedirectUrl),\n\t\t\t\t\t\taccessTokenUrl: new Uri(keys.AccessTokenUrl));\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tthrow new Exception(\"Service \" + authPage.Service + \" not yet supported\");\n\t\t\t}\n\n\t\t\tif (auth2 != null)\n\t\t\t{\n\t\t\t\tauth2.Completed += async (sender, eventArgs) =>\n\t\t\t\t{\n#if __IOS__\n\t\t\t\t\tDismissViewController(true, null);\n#endif\n\t\t\t\t\tif (eventArgs.IsAuthenticated)\n\t\t\t\t\t\tAccountStore.Create().Save(eventArgs.Account, authPage.Service.ToString());\n\t\t\t\t\tawait authPage.Navigation.PopAsync();\n\t\t\t\t};\n#if __IOS__\n\t\t\t\tPresentViewController(auth2.GetUI(), true, null);\n#elif __ANDROID__\n\t\t\t\tactivity.StartActivity(auth2.GetUI(activity));\n#endif\n\t\t\t}\n\n\t\t\tif (auth1 != null)\n\t\t\t{\n\t\t\t\tauth1.Completed += async (sender, eventArgs) =>\n\t\t\t\t{\n#if __IOS__\n\t\t\t\t\tDismissViewController(true, null);\n#endif\n\t\t\t\t\tif (eventArgs.IsAuthenticated)\n\t\t\t\t\t\tAccountStore.Create().Save(eventArgs.Account, authPage.Service.ToString());\n\t\t\t\t\tawait authPage.Navigation.PopAsync();\n\t\t\t\t};\n\t\t\t\n#if __IOS__\n\t\t\t\tPresentViewController(auth1.GetUI(), true, null);\n#elif __ANDROID__\n\t\t\t\tactivity.StartActivity(auth1.GetUI(activity));\n#endif\n\t\t\t}\n\n\t\t}\n\t}\n\n}\n{% endhighlight %}\n\nLo que el código anterior hace es declarar dos formas de obtener la autorización (`OAuth2Authenticator` y `OAuth2Authenticator`), también delcara una variable del tipo `IKeys`. \n\nLuego obtiene una referencia a la página de Xamarin.Forms desde la que estamos llamándola (para saber a qué servicio queremos conectarnos), con esta información comienza a crear la petición adecuada de acuerdo al servicio que solicitamos. Es importante que veas que dentro de cada una de las opciones de la instrucción `switch`, se instancia la clase que contiene las llaves del servicio que vamos a usar.\n\nPor último, y después de que se ha creado correctamente una instancia de `OAuth2Authenticator` o de `OAuth1Authenticator`, asigna un manejador al evento `Completed`, para que si se obtuvo el permiso requerido lo almacene en el dispositivo mediante la llamada a `AccountStore.Create().Save()`. Luego de todo esto, podemos mostrar la pantalla al usuario. En android mediante el método `StartActivity`, mientras que en iOS mediante `PresentViewController`.\n\nDe este modo, cada vez que naveguemos hacia una página del tipo `AuthorizePage`, se mostrará la interfaz de autorización solicitada, de acuerdo al valor pasado en el constructor de la clase.\n\nEse es todo el código que necesitas para los proyectos \"cliente\". Ahora, de vuelta al proyecto de Forms:  \n   \n## De vuelta en Xamarin.Forms  \nCuando solicitemos permiso para usar determinado servicio, lo único que debemos hacer es crear una nueva página en Forms y navegar hacia ella:\n\n{% highlight csharp %}\nawait Navigation.PushAsync(new AuthorizePage(Services.Facebook));\n{% endhighlight %}  \n\nPara corroborar si el usuario ha otorgado permiso debemos obtener las cuentas que tenemos guardadas en el dispositivo usando la implementación de la clase `IAccountManagerService` del servicio de dependencias:\n\n{% highlight csharp %}\n_services = DependencyService.Get<IAccountManagerService>();\n{% endhighlight %}  \n\nY luego revisar la propiedad `Accounts` buscando si existe el servicio que deseamos:\n\n{% highlight csharp %}\nvar accounts = _services.Accounts;\nif (accounts.Contains(Services.Facebook))\n{ // ...\n{% endhighlight %}  \n\nSi sabemos que el usuario nos ha autorizado, podemos acceder a los tokens, claves y demás información de permisos mediante el método `GetPropertyFromAccount`:\n\n{% highlight csharp %}\nvar screen_name = _services.GetPropertyFromAccount(Services.Twitter, \"screen_name\");\nvar oauth_consumer_key = _services.GetPropertyFromAccount(Services.Twitter, \"oauth_consumer_key\");\nvar oauth_token_secret = _services.GetPropertyFromAccount(Services.Twitter, \"oauth_token_secret\");\n{% endhighlight %}  \n\n## Demo\nPuedes ver el vídeo de la app que usa el código explicado en el código anterior:  \n\n<div class=\"pure-g\">\n<div class=\"pure-u-1 pure-u-md-1-2\">\n<img src=\"//i.imgur.com/7tBrHtI.gif\" />\n</div>\n<div class=\"pure-u-1 pure-u-md-1-2\">\n<img src=\"http://i.giphy.com/11S78bw1xcfodi.gif\" />\n</div>  \n</div> \n\n\n## Para finalizar  \nComo puedes ver no es tan complicado (espero me haya explicado bien), y añadir otros servicios es tan simple como conseguir las llaves, modificar unas cuantas clases y ¡listo! Tu app se puede conectar con el resto del internet.  \n\nNo olvides que me puedes preguntar dudas por correo o por Twitter, ah... y <a href=\"https://github.com/fferegrino/Authy\" target=\"_blank\"><strong>descargar el código fuente</strong></a>."
}