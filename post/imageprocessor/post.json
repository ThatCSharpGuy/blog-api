{	
	"id" : "/post/imageprocessor/",
	"tv" : false,
	"date": "2016-07-11 14:00:01 -0500",
	"title" : "Trabajando con imágenes e ImageProcessor",
	"author" : "Antonio Feregrino Bolaños",
	"featured_image": "http://thatcsharpguy.com/postimages//imageprocessor/featured.jpg",
	"tags" : ["NuGetRecomendado"],
	"content": "<p>Hoy toca hablar de otro <a href=\"http://thatcsharpguy.com/tag/NuGetRecomendado\">#NuGetRecomendado</a>. Este es tal vez uno de los más entretenidos que he usado en mi vida, espero que tu también lo encuentres así.</p>\n\n<p>Es muy probable que ya te hayas enfrentado o que tengas que enfrentarte con este problema en el futuro: Procesamiento de imagenes. Puede ser algo tan simple como cargar y recortar las imagenes de perfil de usuarios a un sistema o aplicar filtos a fotos al más puro estilo de Instagram, como programadores comenzamos a imaginarnos y a investigar cómo podemos realizar esta tareas… o, tal vez busquemos mejor una librería para hacerlo.</p>\n\n<p>Esta es precisamente una tarea para <a href=\"http://imageprocessor.org/\" target=\"_blank\" rel=\"nofollow\"><i>ImageProcessor</i></a>, una librería para realizar algunas operaciones sobre imagenes con la ayuda de sus métodos, pero vamos a ver cómo se usa:</p>\n\n<h2 id=\"comenzando\">Comenzando</h2>\n\n<p>Vamos a trabajar con esta imagen:</p>\n\n<p>post_image balon.jpg “Balón”</p>\n\n<p>Para comenzar a trabajar con una imagen, es necesario cargarla y con <em>ImageProcessor</em> esta tarea se realiza a través de una instancia de <code>ImageFactory</code> y un flujo de datos (en este caso un <code>MemoryStream</code>), los colocamos dentro de <code>using</code> para facilitarnos el manejo de memoria:</p>\n\n<pre class=\"csharp\">\nvar balonBytes = File.ReadAllBytes(\"photo/balon.jpg\");\n\nusing (var inStream = new MemoryStream(balonBytes))\nusing (var imageFactory = new ImageFactory(false))\n\n</pre>\n\n<h3 id=\"load\">Load</h3>\n\n<p>Una vez creada la <code>imageFactory</code> podemos cargar nuestra imagen usando el método <code>Load</code>:</p>\n\n<pre class=\"csharp\">\nvar img = imageFactory.Load(inStream);\n</pre>\n\n<h3 id=\"resize\">Resize</h3>\n\n<p>Una vez cargada, podemos comenzar a aplicar las transformaciones. Por ejemplo, cambiar el tamaño:</p>\n\n<pre class=\"csharp\">\nimg.Resize(new Size(300, 0));\n</pre>\n\n<h3 id=\"save\">Save</h3>\n\n<p>Hasta este punto, tenemos la imagen modificada en memoria, así que nuestro <code>imageFactory</code> nos provee un método para guardarla en disco:</p>\n\n<pre class=\"csharp\">\nimg.Save(\"photo/bolaResized.jpg\");\n</pre>\n\n<p>Tras lo cual nos queda la siguiente imagen:</p>\n\n<p>post_image bolaResized.jpg “Balón”</p>\n\n<h2 id=\"api-fluda\">API fluída</h2>\n\n<p>Para nuestra conveniencia, <em>ImageProcessor</em> provee una API fluída (fluent API) para encadenar todos los métodos anteriores, por ejemplo, el código anterior se puede reescribir de la siguiente manera:</p>\n\n<pre class=\"csharp\">\nimageFactory.Load(inStream)\n            .Resize(new Size(300, 0))\n            .Save(\"photo/bolaResized.jpg\");\n</pre>\n\n<h3 id=\"quality\">Quality</h3>\n\n<p>Otra de las transformaciones que permite es la de reducir la calidad de una imagen, esto a través del método <code>Quality</code> que recibe número con la nueva calidad de la imagen:</p>\n\n<pre class=\"csharp\">\nimageFactory.Load(inStream)\n            .Quality(5) // Only works with jpg\n            .Save(\"photo/bolaLow.jpg\");\n</pre>\n\n<p>post_image bolaLow.jpg “Balón”</p>\n\n<h3 id=\"format\">Format</h3>\n<p>Trabajar con diversos formatos de archivo a veces puede ser un poco complicado, es por eso que esta librería también permite cambiar el formato de la imagen, por ejemplo, en esta convertimos la imagen de <code>jpg</code> a <code>png</code>:</p>\n\n<pre class=\"csharp\">\nimageFactory.Load(inStream)\n            .Format(new PngFormat  Quality = 10 )\n            .Save(\"photo/balon.png\");\n</pre>\n\n<h2 id=\"transformaciones-en-la-imagen\">Transformaciones en la imagen</h2>\n\n<p>Además de cosas como cambio de formatos, de tamaño y de calidad <em>ImageProcessor</em> también permite modificar la imagen para aplicarle algunos efectos y transformaciones al contenido, para este ejemplo vamos a trabajar con la foto de la perrita Micha:</p>\n\n<p>post_image micha.jpg “Micha”</p>\n\n<h3 id=\"filter\">Filter</h3>\n<p>Al más puro estilo de Instagram, podemos aplicarle filtros a la imagen con el método <code>Filter</code>, la librería tiene ya definidos algunos filtos como sepia y escala de grises, entre otros. O si estás muy inspirado, puedes crear el tuyo propio:</p>\n\n<pre class=\"csharp\">\nimageFactory.Load(inStream)\n            .Filter(MatrixFilters.HiSatch)\n            .Save(\"photo/michaArt.jpg\");\n</pre>\n\n<p>Y este es el resultado:</p>\n\n<p>post_image michaArt.jpg “Micha”</p>\n\n<p>Qué sería de esta ibrería si no diera la capacidad de invertir los colores de una imagen. Esta transformación no requiere de mucha explicación, salvo que se usa el método <code>Filter</code> con el filtro <code>Invert</code>:</p>\n\n<pre class=\"csharp\">\nimageFactory.Load(inStream)\n            .Filter(MatrixFilters.Invert)\n            .Save(\"photo/michaInverse.jpg\");\n</pre>\n\n<p>Y este es el resultado:</p>\n\n<p>post_image michaInverse.jpg “Micha”</p>\n\n<h3 id=\"michstagram-filter-tint-y-saturation\">Michstagram (Filter, Tint y Saturation)</h3>\n\n<p>Aprovechando que se pueden encadenar varias transformaciones gracias a la API fluída podemos crear un pequeño instagram para Micha:</p>\n\n<pre class=\"csharp\">\nimageFactory.Load(inStream)\n            .Filter(MatrixFilters.Sepia)\n            .Tint(Color.LightSalmon)\n            .Saturation(50)\n            .Save(\"photo/michaInstagram.jpg\");\n</pre>\n\n<p>post_image michaInstagram.jpg “Micha”</p>\n\n<h3 id=\"ms-transformaciones\">Más transformaciones</h3>\n\n<p><em>ImageProcessor</em> no se queda ahí, sino que también nos deja recortar recuadros de la imagen, girarla e invertirla respecto a determinado eje. Para la demostración mira la siguiente imagen:</p>\n\n<p>post_image motherboard.jpg “Motherboard”</p>\n\n<div class=\"pure-g\">\n<div class=\"pure-u-1 pure-u-md-1-3\">       \n<h3>Crop</h3>\n<pre class=\"csharp\">\nvar m = imageFactory.Load(inStream)\n        .Crop(new Rectangle(100, 100, 250, 250))\n        .Save(\"photo/motherboardCropped.jpg\");\n</pre>    \n\n post_image motherboardCropped.jpg \"Motherboard\" \n</div>\n<div class=\"pure-u-1 pure-u-md-1-3\">  \n<h3>Rotate</h3>  \n<pre class=\"csharp\">\nm.Rotate(10f)\n .Save(\"photo/motherboardRotated.jpg\");  \n \n</pre>    \n\n post_image motherboardRotated.jpg \"Motherboard\" \n</div>  \n<div class=\"pure-u-1 pure-u-md-1-3\">  \n<h3>Flip</h3>\n<pre class=\"csharp\">\nm.Flip(true, true)\n .Save(\"photo/motherboardFlipped.jpg\");  \n \n</pre>    \n\n post_image motherboardFlipped.jpg \"Motherboard\" \n</div>  \n</div>\n\n<h2 id=\"extras\">Extras</h2>\n\n<p>Usando una combinación de APIs se pueden crear aplicaciones más interesantes, por ejemplo, con el uso de los <a href=\"https://www.microsoft.com/cognitive-services/en-us/apis\" target=\"_blank\" rel=\"nofollow\">Cognitive Services</a> y en especifico, el reconocimiento de caras, se pueden lograr cosas como estas:</p>\n\n<div class=\"pure-g\">\n<div class=\"pure-u-1 pure-u-md-3-4\">\n<pre class=\"csharp\">\nFace face = null;\nusing (var inStream = new MemoryStream(robbieBytes))\n\n    var detectionTask = faceServiceClient.DetectAsync(inStream);\n    detectionTask.Wait();\n    face = detectionTask.Result.FirstOrDefault();\n\n\nvar faceContainer = new Rectangle(face.FaceRectangle.Left, \n    face.FaceRectangle.Top, face.FaceRectangle.Width, face.FaceRectangle.Height);\nusing (var inStream = new MemoryStream(robbieBytes))\nusing (var imageFactory = new ImageFactory(false))\n\n    imageFactory.Load(inStream)\n            .Crop(faceContainer)\n            .Save(\"photo/robbieFace.jpg\");\n\n</pre>  \n</div>\n<div class=\"pure-u-1 pure-u-md-1-4\">\n post_image robbie3.jpg \"Robbie Williams\" \n\n post_image robbieFace.jpg \"Robbie Williams face\" \n</div>\n</div>\n\n<p>O mejor aún, podemos detectar las caras aplicarle algunas transformaciones como pixelizarlas:</p>\n\n<pre class=\"csharp\">\nFace[] faces;\nusing (var inStream = new MemoryStream(friendsBytes))\n\n    var detectionTask = faceServiceClient.DetectAsync(inStream);\n    detectionTask.Wait();\n    faces = detectionTask.Result;\n\n\nusing (var inStream = new MemoryStream(friendsBytes))\nusing (var imageFactory = new ImageFactory(false))\n\n    var friendsImage = imageFactory.Load(inStream);\n    foreach (var f in faces)\n    \n        var faceContainer = new Rectangle(f.FaceRectangle.Left, f.FaceRectangle.Top, \n            f.FaceRectangle.Width, f.FaceRectangle.Height);\n        friendsImage.Pixelate(20, faceContainer);\n    \n    friendsImage.Save(\"photo/friendsAnonymous.jpg\");\n\n</pre>\n\n<div class=\"pure-g\">\n<div class=\"pure-u-1 pure-u-md-1-2\">\n post_image friends2.jpg \"Friends\" \n</div>\n<div class=\"pure-u-1 pure-u-md-1-2\">\n post_image friendsAnonymous.jpg \"Friends anon\" \n</div>\n</div>\n\n<h2 id=\"conclusin\">Conclusión</h2>\n<p>No hay mucho que decir sobre <em>ImageProcessor</em>, salvo que es una librería muy potente y que nunca está de más contemplarla para proyectos en los que se requiere manipular imágenes. Si bien me parece que podrían ser añadidos otros métodos, los que tiene son de gran provecho. También ten en cuenta que yo no he hablado de todos los métodos disponibles, y te invito a que veas la <a href=\"http://imageprocessor.org/imageprocessor/imagefactory/\" target=\"_blank\" rel=\"nofollow\">documentación completa</a> para conocerlos todos.</p>\n\n<h1 id=\"instalacin\">Instalación</h1>\n<p>Como siempre, hay que buscar en el gestor de paquetes de NuGet: <code>ImageProcessor</code></p>\n\n<p>O desde la consola:</p>\n\n<p>console titulo \nPM&gt; Install-Package ImageProcessor\n endconsole</p>\n\n<p>No olvides echarle un ojo al <a href=\"https://github.com/JimBobSquarePants/ImageProcessor\" target=\"_blank\">proyecto en GitHub</a> o en el <a href=\"http://imageprocessor.org\" target=\"_blank\">sitio web del proyecto</a>. Y de nueva cuenta, te invito a <strong><a href=\"https://github.com/ThatCSharpGuy/ImageProcessor-Sample\" target=\"_blank\">descargar el código</a></strong> y hagas pruebas con él.</p>\n"
}