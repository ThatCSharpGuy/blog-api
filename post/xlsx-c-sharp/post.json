{	
	"id" : "/post/xlsx-c-sharp/",
	"tv" : false,
	"date": "2016-03-07 13:00:00 -0600",
	"title" : "Trabajando con XslX en C#",
	"author" : "Antonio Feregrino Bolaños",
	"featured_image": "http://thatcsharpguy.com/postimages//xlsx-c-sharp/featured.png",
	"tags" : ["NuGetRecomendado"],
	  
	"content": '"Justamente hace unos cuantos posts, les hablaba de cómo <a href=\"http://thatcsharpguy.com/post/docx-c-sharp/\">trabajar con documentos de Word en C#</a>, y esta vez hablo sobre algo similar... solo que con hojas de cálculo de Excel, seguramente es una tarea más requerida dada la naturaleza, ligada a los datos, de este tipo de archivos. Esto es posible a través de una librería que también se distribuye a través de NuGet, la librería en cuestión se llama EPPlus y en este post presento algunos casos de uso.  \r\n\r\nEn esta ocasión mostraré cómo crear un pequeño reporte de las clases y maestros que se imparten en una escuela, usando la misma información del <a href=\"http://thatcsharpguy.com/post/linq-en-c-sharp-3/\">post sobre LINQ en C#</a>, para finalizar con un ejemplo de lectura de un libro de Excel en nuestra aplicación:  \r\n\r\n## Creando un libro  \r\nPara crear un libro de excel usaremos la clase `ExcelPackage` junto con un objeto de la clase `FileInfo`, la documentación no indica que debemos emplear nuestro código dentro de un bloque `using`, pero para evitar sorpresas, creamos el documento dentro de uno:\r\n\r\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nFileInfo</span> <span class="n">prueba</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FileInfo</span><span class="p">(</span><span class="err">\</span><span class="s">&quot;prueba.xlsx\&quot;);\r\nusing (ExcelPackage excel = new ExcelPackage(prueba))\r\n{\r\n    var workbook = excel.Workbook;\r\n    // ... \r\n</span></code></pre></figure>  \r\n  \r\nPodemos ver a la clase `ExcelPackage` como un contenedor de nuestro libro, al que podemos acceder a través de la propiedad `Workbook`. \r\n\r\n## Guardando un documento  \r\nAl igual que con DocX, una vez creado el documento y después de que hemos terminado de trabajar con él debemos guardar nuestros cambios, esto se hace mediante una llamada a su método `Save`, con lo cual todos los cambios hechos en el documento serán aplicados sobre el archivo. \r\n\r\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span>    <span class="c1">// ...\r\n    excel.Save();\r\n}\r\n</span></code></pre></figure>\r\n\r\nCabe señalar que también tenemos a nuestra disposición el método `SaveAs` que permite guardar una copia del documento con el que estamos trabajando, hay otra sobrecarga que inclusive nos eprmite establecer una contraseña para el archivo.  \r\n  \r\nSi ejecutamos el código hasta este momento veremos un archivo `.xlsx` llamado \"prueba.xlsx\" en la carpeta donde está nuestra aplicación, en mi caso es dentro de `bin\\Debug`, y es porque al crear nuestro documento únicamente empleamos el nombre de un archivo, pero bien pudimos usar una ruta absoluta para guardarlo en otro lugar.  \r\n  \r\n<figure><img src='/postimages/post/xlsx-c-sharp/post.jsonnew-xlsx.png' alt='\"Documento vacío\" images_set' /></figure>  \r\n\r\n## Agregando información  \r\nQueremos generar un reporte con todos los maestros en una hoja de Excel y así es una de las maneras en que se puede hacer usando EPPlus\r\n  \r\n### Hojas de trabajo  \r\nPara insertar datos en nuestro libro de Excel necesitamos primero agregar una hoja de trabajo o *worksheet*, lo cual se hace mediante el método `Add`, que recibe el nombre de la hoja que vamos a crear. Ten cuidado con intentar agregar dos hojas con el mismo nombre, puesto que esto no está permitido.\r\n\r\nEl método `Add` regresa una referencia a la hoja recién añadida y es precisamente usando esa referencia como vamos a añadir la información.  \r\n\r\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nvar</span> <span class="n">teacherWorksheet</span> <span class="p">=</span> <span class="n">wb</span><span class="p">.</span><span class="n">Worksheets</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="err">\</span><span class="s">&quot;Maestros\&quot;);\r\n</span></code></pre></figure>  \r\n\r\n### Celdas\r\nPartiendo de la referencia a `teacherWorksheet` podemos ahora si trabajar con las celdas (`Cells`) de esa hoja, la forma de hacerlo es como lo haríamos manualmente en el documento, es decir, mediante el sistema de coordenadas compuesto por letras y números. Por ejemplo, si queremos añadir los nombres de las columnas para nuestros datos:\r\n\r\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nteacherWorksheet</span><span class="p">.</span><span class="n">Cells</span><span class="p">[</span><span class="err">\</span><span class="s">&quot;A1\&quot;].Value = \&quot;ID\&quot;;\r\nteacherWorksheet.Cells[\&quot;B1\&quot;].Value = \&quot;Nombre\&quot;;\r\nteacherWorksheet.Cells[\&quot;C1\&quot;].Value = \&quot;Apellidos\&quot;;\r\nteacherWorksheet.Cells[\&quot;D1\&quot;].Value = \&quot;Email\&quot;;\r\nteacherWorksheet.Cells[\&quot;E1\&quot;].Value = \&quot;Edad\&quot;;\r\n</span></code></pre></figure>\r\n\r\nUsamos la propiedad `Value` de nuestras celdas es como podemos asignarles un valor, la propiedad es de tipo `object` por lo que podemos poner ahí lo que sea.  \r\n  \r\nPero, como queremos distinguir los encabezados del resto de los datos, ¿por qué no los ponemos en **negritas**?\r\n\r\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nteacherWorksheet</span><span class="p">.</span><span class="n">Cells</span><span class="p">[</span><span class="err">\</span><span class="s">&quot;A1:E1\&quot;].Style.Font.Bold = true; \r\n</span></code></pre></figure>\r\n\r\nComo puedes ver, `Cells` también nos ayuda a recuperar todo un rango de celdas, para así poder trabajar con todas ellas de una sola vez.\r\n\r\nYa por último en un ciclo `foreach` insertamos cada uno de los valores en su correspondiente celda\r\n\r\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nint</span> <span class="n">cell</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nforeach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">teacher</span> <span class="k">in</span> <span class="n">Database</span><span class="p">.</span><span class="n">Teachers</span><span class="p">)</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span>    <span class="n">teacherWorksheet</span><span class="p">.</span><span class="n">Cells</span><span class="p">[</span><span class="err">\</span><span class="s">&quot;A\&quot; + cell].Value = teacher.Id;\r\n    teacherWorksheet.Cells[\&quot;B\&quot; + cell].Value = teacher.GivenName;\r\n    // ... más asignaciones\r\n    cell++;\r\n} \r\n</span></code></pre></figure>\r\n\r\nTras lo cual obtendremos algo como esto:  \r\n  \r\n<figure><img src='/postimages/post/xlsx-c-sharp/post.jsonsample-1.png' alt='\"Documento vacío\" images_set' /></figure>\r\n\r\nPodemos agregar más hojas a nuestro libro, también añadiremos una hoja para guardar las Clases impartidas por los maestros.\r\n\r\n## Hoja de resumen  \r\nAhora veremos cómo agregar una página de resumen, en la cual mostraremos algunos datos basados en la información contenida dentro del libro.\r\n\r\n### Combinando y centrando celdas  \r\nPrimero añadimos una nueva hoja al libro, después vamos a unir las celdas `A1` y `B1`, ponerlas en negritas y centrar el texto para el \"título\" de la hoja de resumen. Todo eso es posible con el siguiente código:\r\n\r\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nvar</span> <span class="n">summaryWorksheet</span> <span class="p">=</span> <span class="n">wb</span><span class="p">.</span><span class="n">Worksheets</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="err">\</span><span class="s">&quot;Resumen\&quot;);\r\n\r\nvar titleCell = summaryWorksheet.Cells[\&quot;A1:B1\&quot;]; // Tomamos un rango de celdas\r\ntitleCell.Merge = true;\r\ntitleCell.Style.Font.Bold = true;\r\ntitleCell.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;\r\ntitleCell.Value = \&quot;Resumen\&quot;;\r\n</span></code></pre></figure>  \r\n\r\nQue nos dejará con el siguiente resultado:\r\n\r\n<figure><img src='/postimages/post/xlsx-c-sharp/post.jsonsample-2.png' alt='\"Documento vacío\" images_set' /></figure>  \r\n  \r\n### Formulas  \r\nPara añadir fórmulas debemos usar la propiedad `Formula` de las celdas, lo que si es importante es hacer referencia a ellas a través de su nombre original en inglés.\r\n\r\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nsummaryWorksheet</span><span class="p">.</span><span class="n">Cells</span><span class="p">[</span><span class="err">\</span><span class="s">&quot;B2\&quot;].Formula = \&quot;AVERAGE(Maestros!E2:E31)\&quot;;  \r\n// ...\r\nsummaryWorksheet.Cells[\&quot;B3\&quot;].Formula = \&quot;COUNTIF(Maestros!D2:D31,\\\&quot;\\\&quot;)\&quot;;\r\n</span></code></pre></figure>  \r\n\r\nEn este caso estamos usando AVERAGE para sacar el promedio de edad y COUNTIF para contar la cantidad de maestros sin correo electrónico.  \r\n\r\n<figure><img src='/postimages/post/xlsx-c-sharp/post.jsonsample-3.png' alt='\"Documento vacío\" images_set' /></figure>\r\n\r\n## Usando LINQ\r\nUna cosa que relamente es genial de EPPlus es que nos permite usar LINQ para trabajar con las hojas y celdas de nuestros libros, por ejemplo, para obtener una referencia a una hoja de trabajo existente podemos buscarla por su nombre usando el método `Single`:\r\n\r\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nvar</span> <span class="n">teacherWorksheet</span> <span class="p">=</span> <span class="n">wb</span><span class="p">.</span><span class="n">Worksheets</span><span class="p">.</span><span class="n">Single</span><span class="p">(</span><span class="n">ws</span> <span class="p">=&gt;</span> <span class="n">ws</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="err">\</span><span class="s">&quot;Maestros\&quot;); \r\n</span></code></pre></figure>  \r\n\r\nY ahora, con la referencia `teacherWorksheet` consultamos sus celdas, nuevamente usando LINQ:\r\n\r\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nvar</span> <span class="n">cellsWithYoungTeachers</span> <span class="p">=</span> <span class="k">from</span> <span class="n">cell</span> <span class="k">in</span> <span class="n">teacherWorksheet</span><span class="p">.</span><span class="n">Cells</span><span class="p">[</span><span class="err">\</span><span class="s">&quot;E:E\&quot;].Skip(1)\r\n                             where ((int)cell.Value) &lt; 20\r\n                             select cell;\r\n</span></code></pre></figure>  \r\n\r\nEn el código anterior estamos:  \r\n   \r\n - Seleccionando todas las celdas de la columna E con `.Cells[\"E:E\"]` \r\n - Brincándonos la primera de esas celdas (porque es el título) con `.Skip(1)` \r\n - Filtrándo las celdas que contienen un valor menor a 20 `where ((int)cell.Value) < 20`\r\n \r\n## Modificando el formato de las celdas\r\nDespués podemos iterar sobre la colección recién creada y darle un estilo diferente a las celdas que coincidieron con las condiciones que especificamos:\r\n\r\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nforeach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">cell</span> <span class="k">in</span> <span class="n">cellsWithYoungTeachers</span><span class="p">)</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span>    <span class="n">cell</span><span class="p">.</span><span class="n">Style</span><span class="p">.</span><span class="n">Fill</span><span class="p">.</span><span class="n">PatternType</span> <span class="p">=</span> <span class="n">ExcelFillStyle</span><span class="p">.</span><span class="n">Solid</span><span class="p">;</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span>    <span class="n">cell</span><span class="p">.</span><span class="n">Style</span><span class="p">.</span><span class="n">Fill</span><span class="p">.</span><span class="n">BackgroundColor</span><span class="p">.</span><span class="n">SetColor</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">BlueViolet</span><span class="p">);</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span>    <span class="n">cell</span><span class="p">.</span><span class="n">Style</span><span class="p">.</span><span class="n">Font</span><span class="p">.</span><span class="n">Color</span><span class="p">.</span><span class="n">SetColor</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">Snow</span><span class="p">);</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span><span class="p">}</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \r\n\r\nQue nos dejará el resultado siguiente:\r\n\r\n<figure><img src='/postimages/post/xlsx-c-sharp/post.jsonsample-4.png' alt='\"Celdas coloreadas\" images_set' /></figure>\r\n\r\nAdemás de poder modificar el relleno de una celda también tenemos acceso a personalizar el borde, fuente y alineación. \r\n\r\n## Formato condicional\r\nAdicionalmente a añadir nuestro propio formato, esta librería también permite trabajar con formato condicional para las celdas, y la manera de hacerlo es la siguiente:\r\n\r\nPrimero que nada, y como siempre, obtenemos una referencia a la hoja sobre la que vamos a trabajar y después determinamos sobre qué rango de columnas vamos a trabajar y creamos un objeto `ExcelAddress`. Para nuestro caso es sobre la columna de edad de los maestros que es la E:\r\n\r\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nvar</span> <span class="n">teacherWorksheet</span> <span class="p">=</span> <span class="n">wb</span><span class="p">.</span><span class="n">Worksheets</span><span class="p">.</span><span class="n">Single</span><span class="p">(</span><span class="n">ws</span> <span class="p">=&gt;</span> <span class="n">ws</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="err">\</span><span class="s">&quot;Maestros\&quot;);\r\nvar ageCellsStringAddress = \&quot;$E$2:$E$31\&quot;;\r\nvar ageCellsAddress = new ExcelAddress(ageCellsStringAddress);\r\n</span></code></pre></figure>  \r\n\r\nUna vez que tenemos determinado el rango, accedemos a la propiedad `ConditionalFormatting` para agregar un nuevo formato condicional, en este caso usaremos una escala de dos colores: \r\n\r\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nvar</span> <span class="n">formatting</span> <span class="p">=</span> <span class="n">teacherWorksheet</span><span class="p">.</span><span class="n">ConditionalFormatting</span><span class="p">.</span><span class="n">AddTwoColorScale</span><span class="p">(</span><span class="n">ageCellsAddress</span><span class="p">);</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span></code></pre></figure> \r\n\r\nLo siguiente es configurar el formato condicional, usaremos fórmulas para obtener el valor mínimo y máximo de las edades de los profesores:\r\n\r\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nformatting</span><span class="p">.</span><span class="n">LowValue</span><span class="p">.</span><span class="n">Type</span> <span class="p">=</span> <span class="n">eExcelConditionalFormattingValueObjectType</span><span class="p">.</span><span class="n">Formula</span><span class="p">;</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nformatting</span><span class="p">.</span><span class="n">LowValue</span><span class="p">.</span><span class="n">Formula</span> <span class="p">=</span> <span class="err">\</span><span class="s">&quot;MIN(\&quot; + ageCellsAddress + \&quot;)\&quot;;\r\nformatting.LowValue.Color = Color.LightGreen;\r\n\r\nformatting.HighValue.Type = eExcelConditionalFormattingValueObjectType.Formula;\r\nformatting.HighValue.Formula = \&quot;MAX(\&quot; + ageCellsAddress + \&quot;)\&quot;;\r\nformatting.HighValue.Color = Color.Green;\r\n</span></code></pre></figure>  \r\n\r\nTras lo cual el libro se verá así:\r\n\r\n<figure><img src='/postimages/post/xlsx-c-sharp/post.jsonsample-5.png' alt='\"Formato condicional\" images_set' /></figure>\r\n\r\n## Leyendo celdas  \r\nAsí como podemos crear hojas desde cero, también podemos leer las ya existentes. Esto es particularmente útil cuando vas a solicitar información a los usuarios a través de un libro de Excel. \r\n\r\nAsí que supongamos que cargaremos maestros a la base con un archivo llamado `teachers.xlsx`, bastaría con abrirlo:\r\n\r\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nFileInfo</span> <span class="n">uploaded</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FileInfo</span><span class="p">(</span><span class="err">\</span><span class="s">&quot;teachers.xlsx\&quot;);\r\nusing (ExcelPackage excel = new ExcelPackage(uploaded))\r\n{\r\n    // ...\r\n</span></code></pre></figure>  \r\n\r\nBuscar la la hoja que necesitamos y contar las filas que contiene:\r\n\r\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">teacherWorksheet</span> <span class="p">=</span> <span class="n">excel</span><span class="p">.</span><span class="n">Workbook</span><span class="p">.</span><span class="n">Worksheets</span><span class="p">.</span><span class="n">Single</span><span class="p">(</span><span class="n">ws</span> <span class="p">=&gt;</span> <span class="n">ws</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="err">\</span><span class="s">&quot;Maestros\&quot;);\r\n    var cells = teacherWorksheet.Cells;\r\n    int rowCount = cells[\&quot;A:A\&quot;].Count();\r\n</span></code></pre></figure>  \r\n\r\nY leer los datos accediendo a las celdas y su propiedad `Value`:\r\n\r\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;=</span> <span class="n">rowCount</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span>    <span class="p">{</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span>        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span>            <span class="n">cells</span><span class="p">[</span><span class="err">\</span><span class="s">&quot;A\&quot; + i].Value.ToString() + \&quot;\\t\&quot; +\r\n            cells[\&quot;B\&quot; + i].Value.ToString() + \&quot;\\t\&quot; +\r\n            cells[\&quot;C\&quot; + i].Value.ToString() + \&quot;\\t\&quot; +\r\n            cells[\&quot;D\&quot; + i].Value.ToString() + \&quot;\\t\&quot; \r\n            );\r\n    }\r\n</span></code></pre></figure>  \r\n\r\nEn este caso los datos leídos se imprimen a consola, pero sería sencillo insertarlos en una base de datos o hacer algun tipo de procesamiento con ellos.\r\n\r\n## Conclusión  \r\nSin lugar a dudas, la API de EPPlus es bastante buena y fácil de usar y si bien tiene poca documentación, es posible encontrar recursos en línea que explícan un poco más acerca de su uso. Como ya vimos, nos puede resultar útil para generar documentos desde cero o interactuar con documentos ya existentes. Es importante remarcar que para su funcionamiento **no requiere que el lugar en donde se ejecute cuente con Office instalado**, al igual que DocX.\r\n \r\n# Instalación  \r\nNo olvides visitar <a href=\"http://epplus.codeplex.com\" target=\"_blank\">la página de EPPlus en Codeplex</a> o instala el paquete de NuGet en tu proyecto:\r\n\r\n<figure class="console"><pre><code>\r\nPM> Install-Package EPPlus\r\n</code></pre></figure>\r\n"'   
}