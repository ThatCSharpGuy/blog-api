{	
	"id" : "/post/xlsx-c-sharp/",
	"tv" : false,
	"date": "2016-03-07 13:00:00 -0600",
	"title" : "Trabajando con XslX en C#",
	"author" : "Antonio Feregrino Bolaños",
	"featured_image": "http://thatcsharpguy.com/postimages//xlsx-c-sharp/featured.png",
	"tags" : ["NuGetRecomendado"],
	"content": "<p>Justamente hace unos cuantos posts, les hablaba de cómo <a href=\"http://thatcsharpguy.com/post/docx-c-sharp/\">trabajar con documentos de Word en C#</a>, y esta vez hablo sobre algo similar… solo que con hojas de cálculo de Excel, seguramente es una tarea más requerida dada la naturaleza, ligada a los datos, de este tipo de archivos. Esto es posible a través de una librería que también se distribuye a través de NuGet, la librería en cuestión se llama EPPlus y en este post presento algunos casos de uso.</p>\n\n<p>En esta ocasión mostraré cómo crear un pequeño reporte de las clases y maestros que se imparten en una escuela, usando la misma información del <a href=\"http://thatcsharpguy.com/post/linq-en-c-sharp-3/\">post sobre LINQ en C#</a>, para finalizar con un ejemplo de lectura de un libro de Excel en nuestra aplicación:</p>\n\n<h2 id=\"creando-un-libro\">Creando un libro</h2>\n<p>Para crear un libro de excel usaremos la clase <code>ExcelPackage</code> junto con un objeto de la clase <code>FileInfo</code>, la documentación no indica que debemos emplear nuestro código dentro de un bloque <code>using</code>, pero para evitar sorpresas, creamos el documento dentro de uno:</p>\n\n<pre class=\"csharp\">\nFileInfo prueba = new FileInfo(\"prueba.xlsx\");\nusing (ExcelPackage excel = new ExcelPackage(prueba))\n\n    var workbook = excel.Workbook;\n    // ... \n</pre>\n\n<p>Podemos ver a la clase <code>ExcelPackage</code> como un contenedor de nuestro libro, al que podemos acceder a través de la propiedad <code>Workbook</code>.</p>\n\n<h2 id=\"guardando-un-documento\">Guardando un documento</h2>\n<p>Al igual que con DocX, una vez creado el documento y después de que hemos terminado de trabajar con él debemos guardar nuestros cambios, esto se hace mediante una llamada a su método <code>Save</code>, con lo cual todos los cambios hechos en el documento serán aplicados sobre el archivo.</p>\n\n<pre class=\"csharp\">\n    // ...\n    excel.Save();\n\n</pre>\n\n<p>Cabe señalar que también tenemos a nuestra disposición el método <code>SaveAs</code> que permite guardar una copia del documento con el que estamos trabajando, hay otra sobrecarga que inclusive nos eprmite establecer una contraseña para el archivo.</p>\n\n<p>Si ejecutamos el código hasta este momento veremos un archivo <code>.xlsx</code> llamado “prueba.xlsx” en la carpeta donde está nuestra aplicación, en mi caso es dentro de <code>bin\\Debug</code>, y es porque al crear nuestro documento únicamente empleamos el nombre de un archivo, pero bien pudimos usar una ruta absoluta para guardarlo en otro lugar.</p>\n\n<p>post_image new-xlsx.png “Documento vacío”</p>\n\n<h2 id=\"agregando-informacin\">Agregando información</h2>\n<p>Queremos generar un reporte con todos los maestros en una hoja de Excel y así es una de las maneras en que se puede hacer usando EPPlus</p>\n\n<h3 id=\"hojas-de-trabajo\">Hojas de trabajo</h3>\n<p>Para insertar datos en nuestro libro de Excel necesitamos primero agregar una hoja de trabajo o <em>worksheet</em>, lo cual se hace mediante el método <code>Add</code>, que recibe el nombre de la hoja que vamos a crear. Ten cuidado con intentar agregar dos hojas con el mismo nombre, puesto que esto no está permitido.</p>\n\n<p>El método <code>Add</code> regresa una referencia a la hoja recién añadida y es precisamente usando esa referencia como vamos a añadir la información.</p>\n\n<pre class=\"csharp\">\nvar teacherWorksheet = wb.Worksheets.Add(\"Maestros\");\n</pre>\n\n<h3 id=\"celdas\">Celdas</h3>\n<p>Partiendo de la referencia a <code>teacherWorksheet</code> podemos ahora si trabajar con las celdas (<code>Cells</code>) de esa hoja, la forma de hacerlo es como lo haríamos manualmente en el documento, es decir, mediante el sistema de coordenadas compuesto por letras y números. Por ejemplo, si queremos añadir los nombres de las columnas para nuestros datos:</p>\n\n<pre class=\"csharp\">\nteacherWorksheet.Cells[\"A1\"].Value = \"ID\";\nteacherWorksheet.Cells[\"B1\"].Value = \"Nombre\";\nteacherWorksheet.Cells[\"C1\"].Value = \"Apellidos\";\nteacherWorksheet.Cells[\"D1\"].Value = \"Email\";\nteacherWorksheet.Cells[\"E1\"].Value = \"Edad\";\n</pre>\n\n<p>Usamos la propiedad <code>Value</code> de nuestras celdas es como podemos asignarles un valor, la propiedad es de tipo <code>object</code> por lo que podemos poner ahí lo que sea.</p>\n\n<p>Pero, como queremos distinguir los encabezados del resto de los datos, ¿por qué no los ponemos en <strong>negritas</strong>?</p>\n\n<pre class=\"csharp\">\nteacherWorksheet.Cells[\"A1:E1\"].Style.Font.Bold = true; \n</pre>\n\n<p>Como puedes ver, <code>Cells</code> también nos ayuda a recuperar todo un rango de celdas, para así poder trabajar con todas ellas de una sola vez.</p>\n\n<p>Ya por último en un ciclo <code>foreach</code> insertamos cada uno de los valores en su correspondiente celda</p>\n\n<pre class=\"csharp\">\nint cell = 2;\nforeach (var teacher in Database.Teachers)\n\n    teacherWorksheet.Cells[\"A\" + cell].Value = teacher.Id;\n    teacherWorksheet.Cells[\"B\" + cell].Value = teacher.GivenName;\n    // ... más asignaciones\n    cell++;\n \n</pre>\n\n<p>Tras lo cual obtendremos algo como esto:</p>\n\n<p>post_image sample-1.png “Documento vacío”</p>\n\n<p>Podemos agregar más hojas a nuestro libro, también añadiremos una hoja para guardar las Clases impartidas por los maestros.</p>\n\n<h2 id=\"hoja-de-resumen\">Hoja de resumen</h2>\n<p>Ahora veremos cómo agregar una página de resumen, en la cual mostraremos algunos datos basados en la información contenida dentro del libro.</p>\n\n<h3 id=\"combinando-y-centrando-celdas\">Combinando y centrando celdas</h3>\n<p>Primero añadimos una nueva hoja al libro, después vamos a unir las celdas <code>A1</code> y <code>B1</code>, ponerlas en negritas y centrar el texto para el “título” de la hoja de resumen. Todo eso es posible con el siguiente código:</p>\n\n<pre class=\"csharp\">\nvar summaryWorksheet = wb.Worksheets.Add(\"Resumen\");\n\nvar titleCell = summaryWorksheet.Cells[\"A1:B1\"]; // Tomamos un rango de celdas\ntitleCell.Merge = true;\ntitleCell.Style.Font.Bold = true;\ntitleCell.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;\ntitleCell.Value = \"Resumen\";\n</pre>\n\n<p>Que nos dejará con el siguiente resultado:</p>\n\n<p>post_image sample-2.png “Documento vacío”</p>\n\n<h3 id=\"formulas\">Formulas</h3>\n<p>Para añadir fórmulas debemos usar la propiedad <code>Formula</code> de las celdas, lo que si es importante es hacer referencia a ellas a través de su nombre original en inglés.</p>\n\n<pre class=\"csharp\">\nsummaryWorksheet.Cells[\"B2\"].Formula = \"AVERAGE(Maestros!E2:E31)\";  \n// ...\nsummaryWorksheet.Cells[\"B3\"].Formula = \"COUNTIF(Maestros!D2:D31,\\\"\\\")\";\n</pre>\n\n<p>En este caso estamos usando AVERAGE para sacar el promedio de edad y COUNTIF para contar la cantidad de maestros sin correo electrónico.</p>\n\n<p>post_image sample-3.png “Documento vacío”</p>\n\n<h2 id=\"usando-linq\">Usando LINQ</h2>\n<p>Una cosa que relamente es genial de EPPlus es que nos permite usar LINQ para trabajar con las hojas y celdas de nuestros libros, por ejemplo, para obtener una referencia a una hoja de trabajo existente podemos buscarla por su nombre usando el método <code>Single</code>:</p>\n\n<pre class=\"csharp\">\nvar teacherWorksheet = wb.Worksheets.Single(ws =&gt; ws.Name == \"Maestros\"); \n</pre>\n\n<p>Y ahora, con la referencia <code>teacherWorksheet</code> consultamos sus celdas, nuevamente usando LINQ:</p>\n\n<pre class=\"csharp\">\nvar cellsWithYoungTeachers = from cell in teacherWorksheet.Cells[\"E:E\"].Skip(1)\n                             where ((int)cell.Value) &lt; 20\n                             select cell;\n</pre>\n\n<p>En el código anterior estamos:</p>\n\n<ul>\n  <li>Seleccionando todas las celdas de la columna E con <code>.Cells[\"E:E\"]</code></li>\n  <li>Brincándonos la primera de esas celdas (porque es el título) con <code>.Skip(1)</code></li>\n  <li>Filtrándo las celdas que contienen un valor menor a 20 <code>where ((int)cell.Value) &lt; 20</code></li>\n</ul>\n\n<h2 id=\"modificando-el-formato-de-las-celdas\">Modificando el formato de las celdas</h2>\n<p>Después podemos iterar sobre la colección recién creada y darle un estilo diferente a las celdas que coincidieron con las condiciones que especificamos:</p>\n\n<pre class=\"csharp\">\nforeach (var cell in cellsWithYoungTeachers)\n\n    cell.Style.Fill.PatternType = ExcelFillStyle.Solid;\n    cell.Style.Fill.BackgroundColor.SetColor(Color.BlueViolet);\n    cell.Style.Font.Color.SetColor(Color.Snow);\n\n</pre>\n\n<p>Que nos dejará el resultado siguiente:</p>\n\n<p>post_image sample-4.png “Celdas coloreadas”</p>\n\n<p>Además de poder modificar el relleno de una celda también tenemos acceso a personalizar el borde, fuente y alineación.</p>\n\n<h2 id=\"formato-condicional\">Formato condicional</h2>\n<p>Adicionalmente a añadir nuestro propio formato, esta librería también permite trabajar con formato condicional para las celdas, y la manera de hacerlo es la siguiente:</p>\n\n<p>Primero que nada, y como siempre, obtenemos una referencia a la hoja sobre la que vamos a trabajar y después determinamos sobre qué rango de columnas vamos a trabajar y creamos un objeto <code>ExcelAddress</code>. Para nuestro caso es sobre la columna de edad de los maestros que es la E:</p>\n\n<pre class=\"csharp\">\nvar teacherWorksheet = wb.Worksheets.Single(ws =&gt; ws.Name == \"Maestros\");\nvar ageCellsStringAddress = \"$E$2:$E$31\";\nvar ageCellsAddress = new ExcelAddress(ageCellsStringAddress);\n</pre>\n\n<p>Una vez que tenemos determinado el rango, accedemos a la propiedad <code>ConditionalFormatting</code> para agregar un nuevo formato condicional, en este caso usaremos una escala de dos colores:</p>\n\n<pre class=\"csharp\">\nvar formatting = teacherWorksheet.ConditionalFormatting.AddTwoColorScale(ageCellsAddress);\n</pre>\n\n<p>Lo siguiente es configurar el formato condicional, usaremos fórmulas para obtener el valor mínimo y máximo de las edades de los profesores:</p>\n\n<pre class=\"csharp\">\nformatting.LowValue.Type = eExcelConditionalFormattingValueObjectType.Formula;\nformatting.LowValue.Formula = \"MIN(\" + ageCellsAddress + \")\";\nformatting.LowValue.Color = Color.LightGreen;\n\nformatting.HighValue.Type = eExcelConditionalFormattingValueObjectType.Formula;\nformatting.HighValue.Formula = \"MAX(\" + ageCellsAddress + \")\";\nformatting.HighValue.Color = Color.Green;\n</pre>\n\n<p>Tras lo cual el libro se verá así:</p>\n\n<p>post_image sample-5.png “Formato condicional”</p>\n\n<h2 id=\"leyendo-celdas\">Leyendo celdas</h2>\n<p>Así como podemos crear hojas desde cero, también podemos leer las ya existentes. Esto es particularmente útil cuando vas a solicitar información a los usuarios a través de un libro de Excel.</p>\n\n<p>Así que supongamos que cargaremos maestros a la base con un archivo llamado <code>teachers.xlsx</code>, bastaría con abrirlo:</p>\n\n<pre class=\"csharp\">\nFileInfo uploaded = new FileInfo(\"teachers.xlsx\");\nusing (ExcelPackage excel = new ExcelPackage(uploaded))\n\n    // ...\n</pre>\n\n<p>Buscar la la hoja que necesitamos y contar las filas que contiene:</p>\n\n<pre class=\"csharp\">\n    var teacherWorksheet = excel.Workbook.Worksheets.Single(ws =&gt; ws.Name == \"Maestros\");\n    var cells = teacherWorksheet.Cells;\n    int rowCount = cells[\"A:A\"].Count();\n</pre>\n\n<p>Y leer los datos accediendo a las celdas y su propiedad <code>Value</code>:</p>\n\n<pre class=\"csharp\">\n    for (int i = 1; i &lt;= rowCount; i++)\n    \n        Console.WriteLine(\n            cells[\"A\" + i].Value.ToString() + \"\\t\" +\n            cells[\"B\" + i].Value.ToString() + \"\\t\" +\n            cells[\"C\" + i].Value.ToString() + \"\\t\" +\n            cells[\"D\" + i].Value.ToString() + \"\\t\" \n            );\n    \n</pre>\n\n<p>En este caso los datos leídos se imprimen a consola, pero sería sencillo insertarlos en una base de datos o hacer algun tipo de procesamiento con ellos.</p>\n\n<h2 id=\"conclusin\">Conclusión</h2>\n<p>Sin lugar a dudas, la API de EPPlus es bastante buena y fácil de usar y si bien tiene poca documentación, es posible encontrar recursos en línea que explícan un poco más acerca de su uso. Como ya vimos, nos puede resultar útil para generar documentos desde cero o interactuar con documentos ya existentes. Es importante remarcar que para su funcionamiento <strong>no requiere que el lugar en donde se ejecute cuente con Office instalado</strong>, al igual que DocX.</p>\n\n<h1 id=\"instalacin\">Instalación</h1>\n<p>No olvides visitar <a href=\"http://epplus.codeplex.com\" target=\"_blank\">la página de EPPlus en Codeplex</a> o instala el paquete de NuGet en tu proyecto:</p>\n\n<p>console titulo \nPM&gt; Install-Package EPPlus\n endconsole</p>\n"
}