{	
	"id" : "/post/markdownview-xamarin-forms-control/",
	"tv" : false,
	"date": "2016-02-01 15:00:00 -0600",
	"title" : "MarkdownView control for Xamarin.Forms",
	"author" : "Antonio Feregrino Bolaños",
	"featured_image": "http://thatcsharpguy.com/postimagesfeatured.png",
	"tags" :
	[ 
		"Xamarin",
		"XamarinForms"
	],
	"content" : "<p>By this time you definetly must have heard about the Markdown markup language. If you think you have not, here is a hint for you: Is that language where you use <code>#</code> do denote headings, <code>*</code> for emphasis and <code>**</code> for strong emphasis… I’m sure you know what I’m talking about.</p>

<p>The thing with Markdown is that it is becoming more and more popular among almost every person who writes stuff in a computer due its simplicity and ease of use. I mean, it is readable at naked eye and you don’t need a fancy editor to work with it, in fact: this blog post is written with Markdown.</p>

<p>While the Markdown is by itself a language that does not depend on anything else to stand, it is often associated with HTML because is one of the format to which Md is converted to in order to be displayed to an end user.</p>

<p>And that bring us where I wanted: Taking advantage of the vast number of implementations of Md converters out in the wild, I decided to create a MarkdownView control, one that could display Md documents without much hassle from the developer’s point of view.</p>

<h2 id=\"commonmark\">CommonMark</h2>
<p>To convert from Md to HTML this control uses the <a href=\"https://github.com/Knagis/CommonMark.NET\" target=\"_blank\">CommonMark.NET</a> converter, in which, as the name states, the CommonMark is used to make the conversion between the two languages. I decided to stick with CommonMark because it is widely (if not the most) used online and it is endorsed by some big tech companies.</p>

<h2 id=\"just-a-wrapper\">Just a wrapper</h2>
<p>I didn’t created the control from scratch, mostly because I thought it wasn’t neccesary, since the output of the CommonMark.NET library is HTML, all I needed was a simple wrapper around the existing <code>WebView</code>. So all the things that apply to that control (like <a href=\"https://developer.xamarin.com/guides/xamarin-forms/user-interface/webview/#Layout\" target=\"_blank\">the layout issues</a>) are generally applicable to <code>MarkdownView</code>.</p>

<h3 id=\"htmlwebviewsource\">HtmlWebViewSource</h3>
<p>The <code>WebView</code> control has a <code>Source</code> property that we can use to set its content, such property can be set to an <code>HtmlWebViewSource</code> that at the same time has an string property that holds the actual <code>Html</code> to be rendered in the view. This control takes advantage of that by building an <code>HtmlWebViewSource</code> with the output of the library.</p>

<h3 id=\"content\">Content</h3>
<p>The <code>MarkdownView</code> exposes a bindable property named <code>Markdown</code> of type <code>string</code> which must be used to set the markdown document’s source, and everytime it changes, new content is rendered. This is the code that is called when such property changes:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="k">void</span> <span class="nf">SetWebViewSourceFromMarkdown</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">swapCssFunction</span> <span class="p">=</span>
        <span class="err">@”</span>
<span class="n">function</span> <span class="nf">_sw</span><span class="p">(</span><span class="n">e</span><span class="p">){</span> 
    <span class="kt">var</span> <span class="n">cssFile</span> <span class="p">=</span> <span class="err">‘”</span> <span class="p">+</span> <span class="n">_baseUrl</span> <span class="p">+</span> <span class="err">“‘</span><span class="p">+</span><span class="n">e</span><span class="p">+</span><span class="err">’</span><span class="p">.</span><span class="n">css</span><span class="err">’</span><span class="p">;</span> <span class="err">“</span> <span class="p">+</span>
    <span class="err">@”</span><span class="n">document</span><span class="p">.</span><span class="n">getElementById</span><span class="p">(</span><span class="err">‘</span><span class="n">_ss</span><span class="err">’</span><span class="p">).</span><span class="n">setAttribute</span><span class="p">(</span><span class="err">‘</span><span class="n">href</span><span class="err">’</span><span class="p">,</span><span class="n">cssFile</span><span class="p">);</span>
<span class="p">}</span><span class="err">”</span><span class="p">;</span>
    <span class="kt">string</span> <span class="n">head</span> <span class="p">=</span> <span class="err">@”</span><span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="p">=</span><span class="err">\</span><span class="s">&quot;viewport\&quot; content=\&quot;width=device-width, initial-scale=1.0, user-scalable=no\&quot; /&gt;</span>
<span class="p">&lt;</span><span class="n">link</span> <span class="n">id</span><span class="p">=</span><span class="err">\</span><span class="s">&quot;_ss\&quot; rel=\&quot;stylesheet\&quot; href=\&quot;#\&quot; /&gt;</span>
<span class="p">&lt;</span><span class="n">script</span><span class="p">&gt;</span><span class="err">\</span><span class="s">&quot; + swapCssFunction + @\&quot;&lt;/script&gt;</span>
<span class="p">&lt;/</span><span class="n">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="err">”</span><span class="p">;&lt;/</span><span class="n">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">pre</span><span class="p">&gt;&lt;</span><span class="n">code</span><span class="p">&gt;</span><span class="kt">var</span> <span class="n">body</span> <span class="p">=</span> <span class="err">@\</span><span class="s">&quot;</span>
<span class="p">&lt;/</span><span class="n">code</span><span class="p">&gt;&lt;/</span><span class="n">pre</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">body</span><span class="p">&gt;</span><span class="err">\</span><span class="s">&quot; +</span>
<span class="n">CommonMarkConverter</span><span class="p">.</span><span class="n">Convert</span><span class="p">(</span><span class="n">Markdown</span><span class="p">)</span> <span class="p">+</span> 
<span class="err">\</span><span class="s">&quot;&lt;/body&gt;</span>
<span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="err">”</span><span class="p">;&lt;/</span><span class="n">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">pre</span><span class="p">&gt;&lt;</span><span class="n">code</span><span class="p">&gt;</span><span class="n">Source</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HtmlWebViewSource</span> <span class="p">{</span> <span class="n">Html</span> <span class="p">=</span> <span class="err">\</span><span class="s">&quot;&amp;lt;html&amp;gt;\&quot; + head + body + \&quot;&amp;lt;/html&amp;gt;\&quot;, BaseUrl = _baseUrl };</span>

<span class="n">SetStylesheet</span><span class="p">();</span> <span class="p">}</span> </code></pre></figure>  
</code></pre>

<p>Wow wow wow, that is a lot of hardcoded html… but it is necesary to create a valid document to host our converted Markdown. This valid document will be the html of our MarkdownView soruce, this source is reset everytime the <code>Markdown</code> is changed.</p>

<p>As you can see there is also a JavaScript function named <code>_sw</code> inside the document definition. It is there to swap the stylesheets by simply calling it, more on that later.</p>

<h3 id=\"setting-the-baseurl\">Setting the BaseUrl</h3>
<p>In order to work with local files inside a <code>WebView</code> we must set the BaseUrl property of the html source, each platform has its own local url, and that is why it has to be done through a mechanism like the dependency service, like in <a rel=\"nofollow\" target=\"_blank\" href=\"https://developer.xamarin.com/guides/xamarin-forms/user-interface/webview/#Local_HTML_Content\">this Xamarin how-to</a>. I’m sure this can be done in the control renderer, though I have not found a way to do it.</p>

<h3 id=\"styling\">Styling</h3>
<p>A well formed html document is readable by itself, though it may be not very pretty, that is why this control also allows setting a local css file as the stylesheet for the document, the control exposes the property <code>Stylesheet</code> which is a string and everytime its contents change, a JavaScript function is triggered inside the html of the WebView by calling <code>Eval</code> method and passing the desired stylesheet name, in fact, here is the code:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">void</span> <span class="nf">SetStylesheet</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">String</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">Stylesheet</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">Eval</span><span class="p">(</span><span class="err">“</span><span class="n">_sw</span><span class="p">(</span><span class="err">\</span><span class="s">&quot;” + Stylesheet + “\&quot;)”);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure></p>

<p>Be aware that this control does not provide stylesheets, however, <a href=\"https://github.com/jasonm23/markdown-css-themes\" target=\"_blank\">here are some</a> that you can download and use with your application. Remember to put them into each platform appropiate folder: <code>Assets</code> for Android and Windows, <code>Resources</code> for iOS.</p>

<h3 id=\"where-to-get-it\"> Where to get it</h3>
<p>It is available on NuGet, just install the following package:</p>

<p><figure class="console"><pre><code>PM&gt; Install-Package Xam.Plugins.Forms.MarkdownView</code></pre></figure></p>

<p>An example of its usage can be seen in my <a href=\"/MrkViewer\">MrkViewer app</a>, I recently switched to it to show the content of the markdown documents.</p>
"
}