{	
	"id" : "/post/full-camera-page-es/",
	"tv" : false,
	"date": "2016-11-08 02:00:00 -0600",
	"title" : "Cámara a página completa en Xamarin.Forms",
	"author" : "Antonio Feregrino Bolaños",
	"featured_image": "http://thatcsharpguy.com/postimages//xamarin-forms/camerapage/featured.jpg",
	"tags" : ["XamarinForms","Xamarin"],
	  
	"content": '"Hace ya un tiempo desde que programé la aplicación<a href=\"..\\Aharphat-Android\" target=\"_blank\">CharpHat</a>, que es una aplicación que permite tomar una foto de cualquier cosa y ponerle un birrete de C# en ella. La aplicación no era perfecta, pero me ayudó a practicar el uso de los *custom page renderers*.  \n\nAhora, decidí retomar el proyecto, pero en esta ocasión con la meta de aislar el código necesario para crear la interfaz y funconalidad de la cámara, de tal modo que cualquiera que quisiera implementar una cámara en su aplicación lo pudiera reutilizar en sus proyectos. Asegúrate de <strong><a href=\"https://github.com/ThatCSharpGuy/Forms-FullCameraPage\" target=\"_blank\">descargar el código fuente</a></strong> para este post.\n\n## Abstracciones de Forms\n<small><a href=\"https://github.com/ThatCSharpGuy/Forms-FullCameraPage/blob/master/CameraPage.cs\" target=\"_blank\">Aquí está el código fuente para esta sección.</a></small>  \n\nComencemos creando la página de Forms que nos servirá como medio de interacción con el código de clada plataforma:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">npublic</span> <span class="k">class</span> <span class="nc">CameraPage</span> <span class="p">:</span> <span class="n">ContentPage</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="k">public</span> <span class="k">delegate</span> <span class="k">void</span> <span class="n">PhotoResultEventHandler</span><span class="p">(</span><span class="n">PhotoResultEventArgs</span> <span class="n">result</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="k">public</span> <span class="k">event</span> <span class="n">PhotoResultEventHandler</span> <span class="n">OnPhotoResult</span><span class="p">;</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nNada fuera de lo normal, crea una clase que derive de `ContentPage`. Añadí un *event handler* ya que que queremos obtener la foto tomada por el usuario. Ahora, agreguémos algunos métodos para llamar cada vez que el usuario realice una acción en la página (en este caso, el usuario podrá tomar una foto o cancelar la acción):\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">npublic</span> <span class="k">void</span> <span class="n">SetPhotoResult</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">image</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="n">OnPhotoResult</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">(</span><span class="k">new</span> <span class="n">PhotoResultEventArgs</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">));</span><span class="err">\</span><span class="n">n</span><span class="p">}</span><span class="err">\</span><span class="n">n</span><span class="err">\</span><span class="n">npublic</span> <span class="k">void</span> <span class="n">Cancel</span><span class="p">()</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="n">OnPhotoResult</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">(</span><span class="k">new</span> <span class="n">PhotoResultEventArgs</span><span class="p">());</span><span class="err">\</span><span class="n">n</span><span class="p">}</span> <span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nComo referencia, mira las propiedades dentro de la clase `PhotoResultEventArgs`:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">npublic</span> <span class="kt">bool</span> <span class="n">Success</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span><span class="err">\</span><span class="n">npublic</span> <span class="kt">int</span> <span class="n">Width</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span><span class="err">\</span><span class="n">npublic</span> <span class="kt">int</span> <span class="n">Height</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span><span class="err">\</span><span class="n">npublic</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">Image</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nAhora es momento de seguir al código específico de cada plataforma. \n\n## In Xamarin.iOS    \n<small><a href=\"https://github.com/ThatCSharpGuy/Forms-FullCameraPage/blob/master/iOS/CameraPageRenderer.cs\" target=\"_blank\">Aquí está el código fuente para esta sección.</a></small>  \n\nPara ser sincero, la implementación en iOS es la más sencilla por mucho. Comenzamos por crear una clase que derive de `PageRenderer` y le añadimos el atributo `ExportRenderer`:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">n</span><span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="n">ExportRenderer</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">CameraPage</span><span class="p">),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">CameraPageRenderer</span><span class="p">))]</span><span class="err">\</span><span class="n">nnamespace</span> <span class="n">FullCameraPage</span><span class="p">.</span><span class="n">iOS</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span><span class="err">\</span><span class="n">tpublic</span> <span class="k">class</span> <span class="nc">CameraPageRenderer</span> <span class="p">:</span> <span class="n">PageRenderer</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nAhora, y esto es muy importante, tienes que sobreescribir el método `ViewDidLoad` dado que es llamado tan pronto nuestra página es cargada por el sistema operativo. Para organizar un poco mejor el código, partamos el código en varios métodos:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">npublic</span> <span class="k">override</span> <span class="k">async</span> <span class="k">void</span> <span class="n">ViewDidLoad</span><span class="p">()</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="k">base</span><span class="p">.</span><span class="n">ViewDidLoad</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>    <span class="n">SetupUserInterface</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>    <span class="n">SetupEventHandlers</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>    <span class="n">AuthorizeCameraUse</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>    <span class="n">SetupLiveCameraStream</span><span class="p">();</span><span class="err">\</span><span class="n">n</span><span class="p">}</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\n### SetupUserInterface \nTal y como el nombre lo dice, aquí es donde tenemos que construir la interfaz. Como podrás haber adivinado, todo se hace con código, pero no te preocupes, es muy sencillo en tanto tu interfaz no sea muy complicada, pero puedes hacer lo que tu quieras aquí.  \n\nPara este ejemplo la interfaz consistrá de un par de botones y una superficie donde la vista en vivo de la cámara se mostrará, así que declara las siguientes campos a nivel de clase:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nVectorButton</span> <span class="n">takePhotoButton</span><span class="p">;</span><span class="err">\</span><span class="n">nVectorButton</span> <span class="n">cancelPhotoButton</span><span class="p">;</span><span class="err">\</span><span class="n">nUIView</span> <span class="n">liveCameraStream</span><span class="p">;</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nAhora para poner los controles en su lugar necesitas pensar como si estuvieras trabajando con un *relative layout*, lo que significa que hay que poner la posición del control en la pantalla. Por ejemplo, observa cómo se ubica la vista de la cámara:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nprivate</span> <span class="k">void</span> <span class="n">SetupUserInterface</span><span class="p">()</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="c1">// Code ommited ...\n    liveCameraStream = new UIView()\n    {\n        Frame = new CGRect(0f, 0f, View.Bounds.Width, View.Bounds.Height)\n    };\n    // Code ommited ...\n    View.Add(liveCameraStream);\n    // Code ommited ...\n}\n</span></code></pre></figure>  \n\n### SetupEventHandlers  \nAhora que ya hemos terminado la interfaz, podemos *conectar* los manejadores de eventos a cada control, por suerte en nuestro ejemplo únicamente tenemos dos botones en la pantalla: para tomar fotos y para cancelar la captura.\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">ncancelPhotoButton</span><span class="p">.</span><span class="n">TouchUpInside</span> <span class="p">+=</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&gt;</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="p">(</span><span class="n">Element</span> <span class="k">as</span> <span class="n">CameraPage</span><span class="p">).</span><span class="n">Cancel</span><span class="p">();</span><span class="err">\</span><span class="n">n</span><span class="p">};</span><span class="err">\</span><span class="n">n</span><span class="err">\</span><span class="n">ntakePhotoButton</span><span class="p">.</span><span class="n">TouchUpInside</span> <span class="p">+=</span> <span class="k">async</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&gt;</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="k">await</span> <span class="n">CapturePhoto</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>    <span class="n">UIImage</span> <span class="n">imageInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UIImage</span><span class="p">(</span><span class="n">data</span><span class="p">);</span><span class="err">\</span><span class="n">n</span><span class="err">\</span><span class="n">n</span>    <span class="p">(</span><span class="n">Element</span> <span class="k">as</span> <span class="n">CameraPage</span><span class="p">).</span><span class="n">SetPhotoResult</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">ToArray</span><span class="p">(),</span><span class="err">\</span><span class="n">n</span>                                           <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">imageInfo</span><span class="p">.</span><span class="n">Size</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span><span class="err">\</span><span class="n">n</span>                                           <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">imageInfo</span><span class="p">.</span><span class="n">Size</span><span class="p">.</span><span class="n">Height</span><span class="p">);</span><span class="err">\</span><span class="n">n</span><span class="p">};</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nLa propiedad `Element` contiene una referencia a la página asociada con el *renderer* y es nuestro medio de interacción con el proyecto de Forms. Si te preguntas sobre el método `CapturePhoto`, lo veremos más adelante.  \n\n## AuthorizeCameraUse  \nAhora es momento de solicitar permiso al usuario para usar su cámara. \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nvar</span> <span class="n">authorizationStatus</span> <span class="p">=</span> <span class="n">AVCaptureDevice</span><span class="p">.</span><span class="n">GetAuthorizationStatus</span><span class="p">(</span><span class="n">AVMediaType</span><span class="p">.</span><span class="n">Video</span><span class="p">);</span><span class="err">\</span><span class="n">nif</span> <span class="p">(</span><span class="n">authorizationStatus</span> <span class="p">!=</span> <span class="n">AVAuthorizationStatus</span><span class="p">.</span><span class="n">Authorized</span><span class="p">)</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="k">await</span> <span class="n">AVCaptureDevice</span><span class="p">.</span><span class="n">RequestAccessForMediaTypeAsync</span><span class="p">(</span><span class="n">AVMediaType</span><span class="p">.</span><span class="n">Video</span><span class="p">);</span><span class="err">\</span><span class="n">n</span><span class="p">}</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nPero antes de ejecutar el código anterior tienes que agregar la entrada `Privacy - Camera Usage Description` al archivo Info.plist en tu proyecto.  \n\n### SetupLiveCameraStream  \nAhora la parte \"complicada\".\n  \nComienza delcarando a nivel de clase una `AVCaptureSession`, `AVCaptureDeviceInput` y `AVCaptureStillImageOutput`,  ya que estos nos ayudaran a acceder a la cámara, mostrarla en vivo, y capturar la imagen.  \n\nEntonces dentro de `SetupLiveCameraStream`, inicializa una sesión de captura, crea una capa de previsualización del mismo tamaño que nuestra `liveCameraStream`, y añádela como una subcapa de esta:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">n</span>    <span class="n">captureSession</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AVCaptureSession</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">videoPreviewLayer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AVCaptureVideoPreviewLayer</span><span class="p">(</span><span class="n">captureSession</span><span class="p">)</span><span class="err">\</span><span class="n">n</span>    <span class="p">{</span><span class="err">\</span><span class="n">n</span>        <span class="n">Frame</span> <span class="p">=</span> <span class="n">liveCameraStream</span><span class="p">.</span><span class="n">Bounds</span><span class="err">\</span><span class="n">n</span>    <span class="p">};</span><span class="err">\</span><span class="n">n</span>    <span class="n">liveCameraStream</span><span class="p">.</span><span class="n">Layer</span><span class="p">.</span><span class="n">AddSublayer</span><span class="p">(</span><span class="n">videoPreviewLayer</span><span class="p">);</span><span class="err">\</span><span class="n">n</span></code></pre></figure>    \n\nDespués, \"crea\" un dispositivo de captura (que puedes configurar de acuerdo a tus necesidades). Y entonces de éste dispositivo crea una entrada para la sesión de captura:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">captureDevice</span> <span class="p">=</span> <span class="n">AVCaptureDevice</span><span class="p">.</span><span class="n">DefaultDeviceWithMediaType</span><span class="p">(</span><span class="n">AVMediaType</span><span class="p">.</span><span class="n">Video</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">ConfigureCameraForDevice</span><span class="p">(</span><span class="n">captureDevice</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">captureDeviceInput</span> <span class="p">=</span> <span class="n">AVCaptureDeviceInput</span><span class="p">.</span><span class="n">FromDevice</span><span class="p">(</span><span class="n">captureDevice</span><span class="p">);</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nYa tenemos una entrada (la cámara del dispositivo), ahora necesitamos una salida, que será una fotografía en formato jpeg:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">dictionary</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NSMutableDictionary</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>    <span class="n">dictionary</span><span class="p">[</span><span class="n">AVVideo</span><span class="p">.</span><span class="n">CodecKey</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NSNumber</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">AVVideoCodec</span><span class="p">.</span><span class="n">JPEG</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">stillImageOutput</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AVCaptureStillImageOutput</span><span class="p">()</span><span class="err">\</span><span class="n">n</span>    <span class="p">{</span><span class="err">\</span><span class="n">n</span>        <span class="n">OutputSettings</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NSDictionary</span><span class="p">()</span><span class="err">\</span><span class="n">n</span>    <span class="p">};</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nTerminamos estableciendo la entrada y salida de la sesión de captura y la iniciamos:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">n</span>    <span class="n">captureSession</span><span class="p">.</span><span class="n">AddOutput</span><span class="p">(</span><span class="n">stillImageOutput</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">captureSession</span><span class="p">.</span><span class="n">AddInput</span><span class="p">(</span><span class="n">captureDeviceInput</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">captureSession</span><span class="p">.</span><span class="n">StartRunning</span><span class="p">();</span><span class="err">\</span><span class="n">n</span></code></pre></figure>\n\n### CapturePhoto\nFinalmente la cereza del pastel. El código para capturar la foto. En sí, el código es bastante simple: Toma la salida y obten una imagen fija de ella, ya que nosotros solo necesitamos los bytes (`NSData`) que contenga la foto tomada: \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">npublic</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">NSData</span><span class="p">&gt;</span> <span class="n">CapturePhoto</span><span class="p">()</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">videoConnection</span> <span class="p">=</span> <span class="n">stillImageOutput</span><span class="p">.</span><span class="n">ConnectionFromMediaType</span><span class="p">(</span><span class="n">AVMediaType</span><span class="p">.</span><span class="n">Video</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">sampleBuffer</span> <span class="p">=</span> <span class="k">await</span> <span class="n">stillImageOutput</span><span class="p">.</span><span class="n">CaptureStillImageTaskAsync</span><span class="p">(</span><span class="n">videoConnection</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">jpegImageAsNsData</span> <span class="p">=</span> <span class="n">AVCaptureStillImageOutput</span><span class="p">.</span><span class="n">JpegStillToNSData</span><span class="p">(</span><span class="n">sampleBuffer</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="k">return</span> <span class="n">jpegImageAsNsData</span><span class="p">;</span><span class="err">\</span><span class="n">n</span><span class="p">}</span><span class="err">\</span><span class="n">n</span></code></pre></figure>\n\n## In Xamarin.Android    \n<small><a href=\"https://github.com/ThatCSharpGuy/Forms-FullCameraPage/blob/master/Droid/CameraPageRenderer.cs\" target=\"_blank\">Aquí está el código fuente para esta sección.</a></small>      \n\nEsta implementación no es tan limpia como en iOS. Principalmente porque Android hace más énfasis en el uso de *listeners* que en manejadores de evento. Como sea, ese no es un problema para nosotros.\n\nComo en iOS, comienza creando una clase que derive de `PageRenderer` y también haz que implmente la interfaz `TextureView.ISurfaceTextureListener`. No olvides el atributo `ExportRenderer`:  \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">n</span><span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="n">Xamarin</span><span class="p">.</span><span class="n">Forms</span><span class="p">.</span><span class="n">ExportRenderer</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">CameraPage</span><span class="p">),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">CameraPageRenderer</span><span class="p">))]</span><span class="err">\</span><span class="n">nnamespace</span> <span class="n">FullCameraPage</span><span class="p">.</span><span class="n">Droid</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="k">public</span> <span class="k">class</span> <span class="nc">CameraPageRenderer</span> <span class="p">:</span> <span class="n">PageRenderer</span><span class="p">,</span> <span class="n">TextureView</span><span class="p">.</span><span class="n">ISurfaceTextureListener</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nDespués, sobreescribe el método `OnElementChanged` (si ya has trabajado con *custom renderers* antes, este método te puede parecer familiar), ya que este será llamado cada vez que una `CameraPage` es mostrada en la pantalla:\n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nprotected</span> <span class="k">override</span> <span class="k">void</span> <span class="n">OnElementChanged</span><span class="p">(</span><span class="n">ElementChangedEventArgs</span><span class="p">&lt;</span><span class="n">Xamarin</span><span class="p">.</span><span class="n">Forms</span><span class="p">.</span><span class="n">Page</span><span class="p">&gt;</span> <span class="n">e</span><span class="p">)</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="k">base</span><span class="p">.</span><span class="n">OnElementChanged</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">SetupUserInterface</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>    <span class="n">SetupEventHandlers</span><span class="p">();</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\n### SetupUserInterface  \nEn este método se debe crear la interfaz de la cámara, puedes hacerlo mediante un archivo *axml* e \"inflarlo\" con los mecanismos de Android... o, como en este ejemplo, crearlo en código.  \n\nPara este ejemplo vamos a necesitar un `RelativeLayout` como contenedor, un `TextureView` para mostrar la cámara y un botón para tomar la foto. Declara todo a nivel de clase:  \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nRelativeLayout</span> <span class="n">mainLayout</span><span class="p">;</span><span class="err">\</span><span class="n">nTextureView</span> <span class="n">liveView</span><span class="p">;</span><span class="err">\</span><span class="n">nPaintCodeButton</span> <span class="n">capturePhotoButton</span><span class="p">;</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nSolamente falta instanciarlos y añadirlos a la pantalla, por ejemplo, observa cómo se crea el contenedor y se le añada el control `TextureView`:    \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nvoid</span> <span class="n">SetupUserInterface</span><span class="p">()</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="n">mainLayout</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RelativeLayout</span><span class="p">(</span><span class="n">Context</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span> <span class="n">mainLayoutParams</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">(</span><span class="err">\</span><span class="n">n</span>        <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">.</span><span class="n">MatchParent</span><span class="p">,</span><span class="err">\</span><span class="n">n</span>        <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">.</span><span class="n">MatchParent</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">mainLayout</span><span class="p">.</span><span class="n">LayoutParameters</span> <span class="p">=</span> <span class="n">mainLayoutParams</span><span class="p">;</span><span class="err">\</span><span class="n">n</span><span class="err">\</span><span class="n">n</span>    <span class="n">liveView</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TextureView</span><span class="p">(</span><span class="n">Context</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span> <span class="n">liveViewParams</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">(</span><span class="err">\</span><span class="n">n</span>        <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">.</span><span class="n">MatchParent</span><span class="p">,</span> <span class="err">\</span><span class="n">n</span>        <span class="n">RelativeLayout</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">.</span><span class="n">MatchParent</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">liveView</span><span class="p">.</span><span class="n">LayoutParameters</span> <span class="p">=</span> <span class="n">liveViewParams</span><span class="p">;</span><span class="err">\</span><span class="n">n</span>    <span class="n">mainLayout</span><span class="p">.</span><span class="n">AddView</span><span class="p">(</span><span class="n">liveView</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="err">\</span><span class="n">n</span>    <span class="c1">// Code ommited...\n\n    AddView(mainLayout);\n}\n</span></code></pre></figure>  \n\nAntes de continuar hay otro método que debemos sobreescribir para darle al contenedor su tamaño (y también lo podemos usar para acomodar la interfaz correctamente):  \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nprotected</span> <span class="k">override</span> <span class="k">void</span> <span class="n">OnLayout</span><span class="p">(</span><span class="kt">bool</span> <span class="n">changed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="k">base</span><span class="p">.</span><span class="n">OnLayout</span><span class="p">(</span><span class="n">changed</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="k">if</span> <span class="p">(!</span><span class="n">changed</span><span class="p">)</span><span class="err">\</span><span class="n">n</span>        <span class="k">return</span><span class="p">;</span><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">msw</span> <span class="p">=</span> <span class="n">MeasureSpec</span><span class="p">.</span><span class="n">MakeMeasureSpec</span><span class="p">(</span><span class="n">r</span> <span class="p">-</span> <span class="n">l</span><span class="p">,</span> <span class="n">MeasureSpecMode</span><span class="p">.</span><span class="n">Exactly</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">msh</span> <span class="p">=</span> <span class="n">MeasureSpec</span><span class="p">.</span><span class="n">MakeMeasureSpec</span><span class="p">(</span><span class="n">b</span> <span class="p">-</span> <span class="n">t</span><span class="p">,</span> <span class="n">MeasureSpecMode</span><span class="p">.</span><span class="n">Exactly</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">mainLayout</span><span class="p">.</span><span class="n">Measure</span><span class="p">(</span><span class="n">msw</span><span class="p">,</span> <span class="n">msh</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">mainLayout</span><span class="p">.</span><span class="n">Layout</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">r</span> <span class="p">-</span> <span class="n">l</span><span class="p">,</span> <span class="n">b</span> <span class="p">-</span> <span class="n">t</span><span class="p">);</span><span class="err">\</span><span class="n">n</span><span class="err">\</span><span class="n">n</span>    <span class="n">capturePhotoButton</span><span class="p">.</span><span class="n">SetX</span><span class="p">(</span> <span class="n">mainLayout</span><span class="p">.</span><span class="n">Width</span> <span class="p">/</span> <span class="m">2</span> <span class="p">-</span> <span class="m">60</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">capturePhotoButton</span><span class="p">.</span><span class="n">SetY</span><span class="p">(</span><span class="n">mainLayout</span><span class="p">.</span><span class="n">Height</span> <span class="p">-</span> <span class="m">200</span><span class="p">);</span><span class="err">\</span><span class="n">n</span><span class="p">}</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\n### SetupEventHandlers  \nComo dije antes, Android depende mucho de *event listeners* en lugar de  *event handlers*, así que este método es muy sencillo. Necesitamos colocar un manejador de evento al botón que tomará la foto, asi como asignar un escuchador que estará atento al estado del control  `SurfaceTexture` (¿Recuerdas que nuestro *renderer* implementa una interfaz?):  \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">ncapturePhotoButton</span><span class="p">.</span><span class="n">Click</span> <span class="p">+=</span> <span class="k">async</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&gt;</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="kt">var</span> <span class="n">bytes</span> <span class="p">=</span> <span class="k">await</span> <span class="n">TakePhoto</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>    <span class="p">(</span><span class="n">Element</span> <span class="k">as</span> <span class="n">CameraPage</span><span class="p">).</span><span class="n">SetPhotoResult</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">liveView</span><span class="p">.</span><span class="n">Bitmap</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span> <span class="n">liveView</span><span class="p">.</span><span class="n">Bitmap</span><span class="p">.</span><span class="n">Height</span><span class="p">);</span><span class="err">\</span><span class="n">n</span><span class="p">};</span><span class="err">\</span><span class="n">nliveView</span><span class="p">.</span><span class="n">SurfaceTextureListener</span> <span class="p">=</span> <span class="k">this</span><span class="p">;</span><span class="err">\</span><span class="n">n</span></code></pre></figure>  \n\nAh, y otra cosa, vamos a sobreescribir el comportamiento del botón \"Atrás\" para que funcione para cancelar la fotografía:  \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">npublic</span> <span class="k">override</span> <span class="kt">bool</span> <span class="n">OnKeyDown</span><span class="p">(</span><span class="n">Keycode</span> <span class="n">keyCode</span><span class="p">,</span> <span class="n">KeyEvent</span> <span class="n">e</span><span class="p">)</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="k">if</span> <span class="p">(</span><span class="n">keyCode</span> <span class="p">==</span> <span class="n">Keycode</span><span class="p">.</span><span class="n">Back</span><span class="p">)</span><span class="err">\</span><span class="n">n</span>    <span class="p">{</span><span class="err">\</span><span class="n">n</span>        <span class="p">(</span><span class="n">Element</span> <span class="k">as</span> <span class="n">CameraPage</span><span class="p">).</span><span class="n">Cancel</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>        <span class="k">return</span> <span class="k">false</span><span class="p">;</span><span class="err">\</span><span class="n">n</span>    <span class="p">}</span><span class="err">\</span><span class="n">n</span>    <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="n">OnKeyDown</span><span class="p">(</span><span class="n">keyCode</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span><span class="err">\</span><span class="n">n</span><span class="p">}</span><span class="err">\</span><span class="n">n</span></code></pre></figure>   \n\n### TextureView.ISurfaceTextureListener implementation  \nAhora toca implementar el núcleo de la página. Comienza por escribir el código para el método `OnSurfaceTextureAvailable` en donde vamos a preparar la salida de la cámara... pero primero necesitamos una cámara, ¿cierto?  \nA nivel de clase declara una `Camera`:    \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nAndroid</span><span class="p">.</span><span class="n">Hardware</span><span class="p">.</span><span class="n">Camera</span> <span class="n">camera</span><span class="p">;</span><span class="err">\</span><span class="n">n</span></code></pre></figure>\n \nDentro del método abre la cámara (por default tomará la cámara trasera del dispositivo) y obtén sus parámetros. Los necesitamos para elegir el tamaño de previsualización correcto porque queremos que se vea bien en nuestra app:  \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">ncamera</span> <span class="p">=</span> <span class="n">Android</span><span class="p">.</span><span class="n">Hardware</span><span class="p">.</span><span class="n">Camera</span><span class="p">.</span><span class="n">Open</span><span class="p">();</span><span class="err">\</span><span class="n">nvar</span> <span class="n">parameters</span> <span class="p">=</span> <span class="n">camera</span><span class="p">.</span><span class="n">GetParameters</span><span class="p">();</span><span class="err">\</span><span class="n">n</span></code></pre></figure> \n\nUna vez que tenemos los parámetros a mano, podemos obtener los `PreviewSizes` y de ellos elegir el que mejor se ajusta a nuestras necesidades. En este caso estoy usando una simple <a href=\"#\">expresión linq</a> para obtener el mejor tamaño de acuerdo a la relación de aspecto:  \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nvar</span> <span class="n">aspect</span> <span class="p">=</span> <span class="p">((</span><span class="kt">decimal</span><span class="p">)</span><span class="n">height</span><span class="p">)</span> <span class="p">/</span> <span class="p">((</span><span class="kt">decimal</span><span class="p">)</span><span class="n">width</span><span class="p">);</span><span class="err">\</span><span class="n">n</span><span class="err">\</span><span class="n">nvar</span> <span class="n">previewSize</span> <span class="p">=</span> <span class="n">parameters</span><span class="p">.</span><span class="n">SupportedPreviewSizes</span><span class="err">\</span><span class="n">n</span>                            <span class="p">.</span><span class="n">OrderBy</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">Math</span><span class="p">.</span><span class="n">Abs</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">Width</span> <span class="p">/</span> <span class="p">(</span><span class="kt">decimal</span><span class="p">)</span><span class="n">s</span><span class="p">.</span><span class="n">Height</span> <span class="p">-</span> <span class="n">aspect</span><span class="p">))</span><span class="err">\</span><span class="n">n</span>                            <span class="p">.</span><span class="n">First</span><span class="p">();</span><span class="err">\</span><span class="n">n</span><span class="err">\</span><span class="n">nparameters</span><span class="p">.</span><span class="n">SetPreviewSize</span><span class="p">(</span><span class="n">previewSize</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span> <span class="n">previewSize</span><span class="p">.</span><span class="n">Height</span><span class="p">);</span><span class="err">\</span><span class="n">ncamera</span><span class="p">.</span><span class="n">SetParameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">);</span><span class="err">\</span><span class="n">n</span></code></pre></figure> \n\nTermina estableciendo el valor de `surface` como la textura de previsualización, una vez hecho esto, lo único que queda por hacer es iniciar la cámara:  \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">ncamera</span><span class="p">.</span><span class="n">SetPreviewTexture</span><span class="p">(</span><span class="n">surface</span><span class="p">);</span><span class="err">\</span><span class="n">nStartCamera</span><span class="p">();</span><span class="err">\</span><span class="n">n</span></code></pre></figure> \n\nHay otro método en el que debemos escribir código, este es `OnSurfaceTextureDestroyed` en donde debemos detener el uso de la cámara, así que únicamente escribe el código siguiente en él:  \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nStopCamera</span><span class="p">();</span><span class="err">\</span><span class="n">nreturn</span> <span class="k">true</span><span class="p">;</span><span class="err">\</span><span class="n">n</span></code></pre></figure> \n\n### StartCamera and StopCamera  \nEste par de métodos son bastante simples también, para `StartCamera` únicamente tenemos que rotar la previsualización para hacer que se vea correctamente en la pantalla (en este caso está establecido para que se vea verticalmente), y terminamos iniciando la cámara:  \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">ncamera</span><span class="p">.</span><span class="n">SetDisplayOrientation</span><span class="p">(</span><span class="m">90</span><span class="p">);</span><span class="err">\</span><span class="n">ncamera</span><span class="p">.</span><span class="n">StartPreview</span><span class="p">();</span><span class="err">\</span><span class="n">n</span></code></pre></figure> \n\nEl métodod `StopCamera` detiene la previsualización y libera la cámara para que otras aplicaciones puedan acceder a ella:  \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">ncamera</span><span class="p">.</span><span class="n">StopPreview</span><span class="p">();</span><span class="err">\</span><span class="n">ncamera</span><span class="p">.</span><span class="n">Release</span><span class="p">();</span><span class="err">\</span><span class="n">n</span></code></pre></figure> \n\n### TakePhoto\nPara tomar una foto, lo que hay que hacer es obtener una imagen fija de lo que se muestra en el video en vivo dentro de la `TextureView`, aquí está el código para hacerlo y regresar los bytes correspondientes:    \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">ncamera</span><span class="p">.</span><span class="n">StopPreview</span><span class="p">();</span><span class="err">\</span><span class="n">nvar</span> <span class="n">ratio</span> <span class="p">=</span> <span class="p">((</span><span class="kt">decimal</span><span class="p">)</span><span class="n">Height</span><span class="p">)</span> <span class="p">/</span> <span class="n">Width</span><span class="p">;</span><span class="err">\</span><span class="n">nvar</span> <span class="n">image</span> <span class="p">=</span> <span class="n">Bitmap</span><span class="p">.</span><span class="n">CreateBitmap</span><span class="p">(</span><span class="n">liveView</span><span class="p">.</span><span class="n">Bitmap</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">liveView</span><span class="p">.</span><span class="n">Bitmap</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">liveView</span><span class="p">.</span><span class="n">Bitmap</span><span class="p">.</span><span class="n">Width</span> <span class="p">*</span> <span class="n">ratio</span><span class="p">));</span><span class="err">\</span><span class="n">nbyte</span><span class="p">[]</span> <span class="n">imageBytes</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span><span class="err">\</span><span class="n">nusing</span> <span class="p">(</span><span class="kt">var</span> <span class="n">imageStream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">MemoryStream</span><span class="p">())</span><span class="err">\</span><span class="n">n</span><span class="p">{</span><span class="err">\</span><span class="n">n</span>    <span class="k">await</span> <span class="n">image</span><span class="p">.</span><span class="n">CompressAsync</span><span class="p">(</span><span class="n">Bitmap</span><span class="p">.</span><span class="n">CompressFormat</span><span class="p">.</span><span class="n">Jpeg</span><span class="p">,</span> <span class="m">50</span><span class="p">,</span> <span class="n">imageStream</span><span class="p">);</span><span class="err">\</span><span class="n">n</span>    <span class="n">image</span><span class="p">.</span><span class="n">Recycle</span><span class="p">();</span><span class="err">\</span><span class="n">n</span>    <span class="n">imageBytes</span> <span class="p">=</span> <span class="n">imageStream</span><span class="p">.</span><span class="n">ToArray</span><span class="p">();</span><span class="err">\</span><span class="n">n</span><span class="p">}</span><span class="err">\</span><span class="n">ncamera</span><span class="p">.</span><span class="n">StartPreview</span><span class="p">();</span><span class="err">\</span><span class="n">nreturn</span> <span class="n">imageBytes</span><span class="p">;</span><span class="err">\</span><span class="n">n</span></code></pre></figure> \n\nY así es como después de tanto código podemos hacer uso de la cámara. Sigue leyendo para encontrar un ejemplo de uso:  \n\n## Usage in Forms  \n\n<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">\</span><span class="n">nvar</span> <span class="n">cameraPage</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CameraPage</span><span class="p">();</span><span class="err">\</span><span class="n">ncameraPage</span><span class="p">.</span><span class="n">OnPhotoResult</span> <span class="p">+=</span> <span class="n">CameraPage_OnPhotoResult</span><span class="p">;</span><span class="err">\</span><span class="n">nNavigation</span><span class="p">.</span><span class="n">PushModalAsync</span><span class="p">(</span><span class="n">cameraPage</span><span class="p">);</span>  <span class="err">\</span><span class="n">n</span><span class="c1">// ...\nasync void CameraPage_OnPhotoResult(Pages.PhotoResultEventArgs result)\n{\n    await Navigation.PopModalAsync();\n    if (!result.Success)\n        return;\n    Image.Source = ImageSource.FromStream(() =&gt; new MemoryStream(result.Image));\n</span></code></pre></figure>  \n\nSi <strong><a href=\"https://github.com/ThatCSharpGuy/Forms-FullCameraPage\" target=\"_blank\">descargas el código fuente</a></strong> y lo ejecutas, verás algo como esto:   \n\n<iframe width=\"560\" height=\"315\" src=\"https://www.youtube.com/embed/DgFEK9tPKs0\" frameborder=\"0\" allowfullscreen></iframe>\n\n\n\n## Acknowledgements   \nEl código para este post está basado completamente en el código de la <a href=\"..\\Aharphat-Android\" target=\"_blank\">CharpHat app</a>,  que a su vez está basado en el código de la app <a href=\"https://blog.xamarin.com/build-your-own-snapchat-clone-with-xamarin-forms-and-azure/\" target=\"_blank\">Moments</a> de <a href=\"https://github.com/pierceboggan\" target=\"_blank\">Pierce Boggan</a>."'   
}