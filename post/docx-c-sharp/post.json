{	
	"id" : "/post/docx-c-sharp/",
	"tv" : false,
	"date": "2016-02-15 13:00:00 -0600",
	"title" : "Trabajando con DocX en C#",
	"author" : "Antonio Feregrino Bolaños",
	"featured_image": "http://thatcsharpguy.com/postimages/docx-c-sharp/featured.png",
	"tags" : ["NuGetRecomendado"],
	"content": "<p>Me atrevería a decir que la gran mayoría de aplicaciones tienen una forma de reportar sus acciones al usuario a través de determinada interfaz. La interfaz más famosa es el monitor de la computadora ya sea mediante imágenes, vídeo o texto, pero no a todos lados es práctico andar cargando con una pantalla, ¿cierto? Es por eso que muchas aplicaciones también ofrecen la posibilidad de descargar su información en forma de documentos de texto, de tal forma que el usuario las pueda descargar e imprimir.</p>\n\n<p>Muchos conocen a esta acción como “Generación de informes o reportes” y hay una enorme cantidad de herramientas para realizarla, entre ellas están el <code>ReportViewer</code> de Microsoft o el Telerik, Crystal Reports de SAP, o alguna de las herramientas de Aspose. Mientras que todas esas herramientas son bastante útiles, algunas son costosas y requieren de mucha infraestructura para poder ser implementadas. Es por eso que en este post te presento una pequeña librería útil como no te imaginas que permite crear y manipular documentos de Word (únicamente los <code>.docx</code>) <strong>sin tener instalado Office</strong>.</p>\n\n<p>En esta ocasión mostraré cómo crear un reporte de las clases (<code>lectures</code>) que imparte un determinado maestro (<code>teacher</code>), con la información que usé en el <a href=\"http://thatcsharpguy.com/post/linq-en-c-sharp-3/\">post sobre LINQ en C#</a>:</p>\n\n<h2 id=\"creando-un-documento\">Creando un documento</h2>\n<p>Para crear un documento es necesario utilizar el método estático <code>Create</code> especificando la ruta del archivo. La sentencia <code>using</code> es importante para asegurarnos que cuando terminemos de usar el documento, se liberen sus recursos de manera adecuada:</p>\n\n<pre class=\"csharp\"> \nusing (var document = DocX.Create(\"Prueba.docx\"))\n\n    // Dentro de este bloque tenemos disponible el documento\n    // ...\n</pre>\n\n<h2 id=\"guardando-un-documento\">Guardando un documento</h2>\n<p>Una vez creado el documento y después de que hemos terminado de trabajar con él debemos guardar nuestros cambios, esto se hace mediante una llamada a su método <code>Save</code>, con lo cual todos los cambios hechos en el documento serán aplicados sobre el archivo. Es importante que llames al método dentro del bloque <code>using</code> (de otro modo obtendrás un error de compilación).</p>\n\n<pre class=\"csharp\">\n    // ...\n    document.Save();\n\n</pre>\n\n<p>Cabe señalar que también tenemos a nuestra disposición el método <code>SaveAs</code> que permite especificar una ruta distinta a la que usamos para crear nuestro documento.</p>\n\n<p>Si ejecutamos el código hasta este momento veremos un documento vacío llamado “Prueba.docx” en la carpeta donde está nuestra aplicación, en mi caso es dentro de <code>bin\\Debug</code>, y es porque al crear nuestro documento únicamente empleamos el nombre de un archivo.</p>\n\n<p>post_image created-document.png “Documento vacío”</p>\n\n<h2 id=\"aadiendo-texto\">Añadiendo texto</h2>\n<p>El texto dentro de un documento de DocX está organizado en párrafos, y por eso debemos añadir párrafos a nuestro documento, para ello debemos tomar nuestro documento y llamar el método <code>InsertParagraph</code>.</p>\n\n<pre class=\"csharp\">\nvar reportParagraph = document.InsertParagraph();\n</pre>\n\n<p>El método devuelve una referencia al párrafo que añadió al documento, a partir de aquí podemos añadirle texto a dicho párrafo, y por ende, al documento. Para agregar texto debemos usar el método <code>Append</code> de la clase <code>Paragraph</code>, este método funciona de manera similar a un <code>StringBuilder</code> ya que podemos <em>“encadenar”</em> las llamadas para separar partes del código:</p>\n\n<pre class=\"csharp\">\nreportParagraph.Append(\"Este es un reporte perteneciente a las clases que imparte \" + teacher.GivenName + \" \" +\n                    teacher.LastName + \", generado en \" + DateTime.Now.ToShortDateString() + \". \")\n    .Append(\"El profesor/ra \" + teacher.LastName + \" imparte actualmente \" + lectures.Length + \" asignaturas.\");\n</pre>\n\n<p>Hasta este momento, el resultado de ejecutar el código es un documento que contiene el texto arriba indicado, se ve más o menos así:</p>\n\n<p>post_image sin-estilo.png “Documento sin estilo”</p>\n\n<h3 id=\"formateando-el-texto\">Formateando el texto</h3>\n<p>El texto sin formato está bien, ¿pero sabes qué es mejor?</p>\n\n<p>DocX tiene una API peculiar para aplicar el formato, ya que todo es a través de métodos que se llaman sobre la instancia de <code>Pharagraph</code>. El formato deseado se aplica al texto que acaba de ser “escrito” con <code>Append</code>, por ejemplo:</p>\n\n<pre class=\"csharp\">\nreportParagraph.Append (\"Este es un reporte perteneciente a las clases que imparte \");\nreportParagraph.Append (teacher.GivenName + \" \" + teacher.LastName).Bold().Append(\", generado en \");\nreportParagraph.Append (DateTime.Now.ToShortDateString ()).Italic().Append (\". \")\n    .Append (\"El profesor/ra \").Append(teacher.LastName).Font(new FontFamily(\"Arial Black\"))\n    .Append(\" imparte actualmente \")\n    .Append(lectures.Length + \" asignaturas.\").Color(Color.Blue).Italic().Bold();\n</pre>\n\n<p>En el código de arriba están pasando varias cosas:</p>\n\n<ul>\n  <li>En la segunda línea se está poniendo el texto <code>teacher.GivenName + \" \" + teacher.LastName</code> en <strong>negritas</strong> con el método <code>Bold</code></li>\n  <li>En la tercera línea se pone en <em>cursiva</em> la fecha con <code>Italic</code></li>\n  <li>En la cuarta se cambia la fuente del texto con el que se escribe apellido del profesor con <code>Font</code></li>\n  <li>En la sexta se cambia el color del texto, se pone en cursivas y en negritas también.</li>\n</ul>\n\n<p>Obtenemos un resultado como este:</p>\n\n<p>post_image estilo.png “Documento estilizado”</p>\n\n<p>Además de estas opciones de formato también podemos subrayar, cruzar, cambiar el tamaño del texto.</p>\n\n<h2 id=\"ttulos\">Títulos</h2>\n<p>Una de las mejores funciones que tiene Word es la posibilidad de añadir títulos a los documentos, y DocX no se queda atrás. Como ya vimos, es necesario añadir un párrafo, agregarle texto e indicarle qué tipo de encabezado deseamos</p>\n\n<pre class=\"csharp\">\nvar titleParagraph = document.InsertParagraph();\ntitleParagraph.Append(\"Reporte \" + LastName).Heading(HeadingType.Heading1);\n</pre>\n\n<p>Y acá está el resultado:</p>\n\n<p>post_image encabezado.png “Encabezado”</p>\n\n<h2 id=\"encabezado-y-pie-de-pgina\">Encabezado y pie de página</h2>\n<p>Para darle un poco más de formalidad al documento, vamos a añadirle un pie de página y un encabezado, otra vez debemos añadir párrafos. Antes que nada, es necesario llamar a dos métodos para preparar el terreno.</p>\n\n<pre class=\"csharp\">\ndocument.AddHeaders();\ndocument.AddFooters();\n</pre>\n\n<p>Una vez hecho esto, podemos comenzar:</p>\n\n<pre class=\"csharp\">\nvar header = document.Headers.odd.InsertParagraph();\nheader.Append (\"Reporte - DocX\").Font(new FontFamily(\"Courier New\"));\n\ndocument.Footers.odd.PageNumbers = true;\n</pre>\n\n<p>En este caso estamos agregando el texto “Reporte - DocX” al encabezado y un número de página al pie de página:</p>\n\n<div class=\"pure-g\">\n<div class=\"pure-u-1 pure-u-md-1-2\">\n post_image header.png \"Encabezado\"   \n</div>\n<div class=\"pure-u-1 pure-u-md-1-2\">\n post_image footer.png \"Pie de pagina\"   \n</div>  \n</div>\n\n<h2 id=\"tablas\">Tablas</h2>\n<p>La inserción de tablas se hace también a través de un método y especificando el número de filas y columnas que se requieren, para este caso requeriremos únicamente 3 columnas y colocaremos una fila de encabezados, también le añadiremos un poco de estilos y bordes para que se vea mejor el “reporte”:</p>\n\n<pre class=\"csharp\">\nvar table = document.InsertTable (1, 3);\n\ntable.AutoFit = AutoFit.Window;\nvar border = new Border (BorderStyle.Tcbs_single, BorderSize.one, 0, Color.Black);\ntable.SetBorder (TableBorderType.InsideH, border); // ... más bordes\n</pre>\n\n<p>De ahí accedemos a la fila <code>0</code> y a sus celdas mediante la propiedad <code>Cells</code>, cada celda funciona como un nuevo documento, por lo que debemos trabajar con los párrafos como anteriormente:</p>\n\n<pre class=\"csharp\">\nvar tableHeaders = table.Rows[0];\ntableHeaders.Cells[0].InsertParagraph().Append(\"ID\").Bold();\ntableHeaders.Cells[1].InsertParagraph().Append(\"Clase\").Bold();\ntableHeaders.Cells[2].InsertParagraph().Append(\"Nivel\").Bold();\n</pre>\n\n<p>Después con un ciclo sobre <code>lectures</code>, agregamos todos los datos:</p>\n\n<pre class=\"csharp\">\nforeach (var lecture in lectures) \n\n    var tableRow = table.InsertRow();\n    tableRow.Cells[0].InsertParagraph().Append (lecture.Id.ToString());\n    tableRow.Cells[1].InsertParagraph().Append(lecture.Name);\n    tableRow.Cells[2].InsertParagraph().Append(lecture.Level);\n\n</pre>\n\n<p>Y el resultado:</p>\n\n<p>post_image table.png “Tabla”</p>\n\n<p>Con esto llegamos al final de la generación de nuestro reporte, pero antes hay que decir que DocX también permite trabajar con imágenes, hipervínculos, propiedades del documento.</p>\n\n<h1 id=\"buscar-y-reemplazar\">Buscar y reemplazar</h1>\n<p>Personalmente pienso que la posibilidad de DocX de buscar y reemplazar texto en un documento es la mejor de todas, ya que podemos partir de un documento formateado a nuestro gusto (sin necesidad de crearlo desde 0) y obtener un resultado más que aceptable. Con esta característica construí una especie de “motor” para generar reportes en el trabajo.</p>\n\n<p>Por ejemplo, tenemos un documento llamado <code>template.docx</code>, lo abriremos con DocX usando el método <code>Load</code> y reemplazaremos algunos de sus valores para guardarlo como <code>out.docx</code>:</p>\n\n<p>post_image template.png “Template”</p>\n\n<pre class=\"csharp\">\ntemplate.ReplaceText(\"esta entrada\", \"este post sobre DocX\");\ntemplate.ReplaceText(\"querido\", \"querido y respetable\");\ntemplate.ReplaceText(\"Facebook\", \"Twitter\");\ntemplate.ReplaceText(\"correo electrónico\", \"feregrino@thatcsharpguy.com\");\n</pre>\n\n<p>post_image out.png “Salida”</p>\n\n<h2 id=\"conclusin\">Conclusión</h2>\n<p>Al principio la API de DocX nos puede parecer un poco rara y con poca documentación, sin embargo, eso no le resta a lo enormemente útil que resulta esta librería, cuando lo que buscamos es trabajar y generar documentos de Word de manera programática. Lo mejor de todo es que <strong>no requiere que la máquina en donde se ejecuta tenga instalado Office</strong>, gran, gran plus.</p>\n\n<h1 id=\"instalacin\">Instalación</h1>\n<p>No olvides visitar <a href=\"http://docx.codeplex.com\" target=\"_blank\">la página de DocX en Codeplex</a> o instala el paquete de NuGet en tu proyecto:</p>\n\n<p>console titulo \nPM&gt; Install-Package DocX\n endconsole</p>\n"
}