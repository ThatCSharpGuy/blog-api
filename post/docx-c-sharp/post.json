{	
	"id" : "/post/docx-c-sharp/",
	"tv" : false,
	"date": "2016-02-15 13:00:00 -0600",
	"title" : "Trabajando con DocX en C#",
	"author" : "Antonio Feregrino Bolaños",
	"featured_image": "http://thatcsharpguy.com/postimagesfeatured.png",
	"tags" :
	[ 
		"NuGetRecomendado"
	],
	"content" : "<p>Me atrevería a decir que la gran mayoría de aplicaciones tienen una forma de reportar sus acciones al usuario a través de determinada interfaz. La interfaz más famosa es el monitor de la computadora ya sea mediante imágenes, vídeo o texto, pero no a todos lados es práctico andar cargando con una pantalla, ¿cierto? Es por eso que muchas aplicaciones también ofrecen la posibilidad de descargar su información en forma de documentos de texto, de tal forma que el usuario las pueda descargar e imprimir.</p>

<p>Muchos conocen a esta acción como “Generación de informes o reportes” y hay una enorme cantidad de herramientas para realizarla, entre ellas están el <code>ReportViewer</code> de Microsoft o el Telerik, Crystal Reports de SAP, o alguna de las herramientas de Aspose. Mientras que todas esas herramientas son bastante útiles, algunas son costosas y requieren de mucha infraestructura para poder ser implementadas. Es por eso que en este post te presento una pequeña librería útil como no te imaginas que permite crear y manipular documentos de Word (únicamente los <code>.docx</code>) <strong>sin tener instalado Office</strong>.</p>

<p>En esta ocasión mostraré cómo crear un reporte de las clases (<code>lectures</code>) que imparte un determinado maestro (<code>teacher</code>), con la información que usé en el <a href=\"http://thatcsharpguy.com/post/linq-en-c-sharp-3/\">post sobre LINQ en C#</a>:</p>

<h2 id=\"creando-un-documento\">Creando un documento</h2>
<p>Para crear un documento es necesario utilizar el método estático <code>Create</code> especificando la ruta del archivo. La sentencia <code>using</code> es importante para asegurarnos que cuando terminemos de usar el documento, se liberen sus recursos de manera adecuada:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"> 
<span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">document</span> <span class="p">=</span> <span class="n">DocX</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="err">“</span><span class="n">Prueba</span><span class="p">.</span><span class="n">docx</span><span class="err">”</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// Dentro de este bloque tenemos disponible el documento</span>
    <span class="c1">// …</span></code></pre></figure></p>

<h2 id=\"guardando-un-documento\">Guardando un documento</h2>
<p>Una vez creado el documento y después de que hemos terminado de trabajar con él debemos guardar nuestros cambios, esto se hace mediante una llamada a su método <code>Save</code>, con lo cual todos los cambios hechos en el documento serán aplicados sobre el archivo. Es importante que llames al método dentro del bloque <code>using</code> (de otro modo obtendrás un error de compilación).</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp">    <span class="c1">// …</span>
    <span class="n">document</span><span class="p">.</span><span class="n">Save</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure></p>

<p>Cabe señalar que también tenemos a nuestra disposición el método <code>SaveAs</code> que permite especificar una ruta distinta a la que usamos para crear nuestro documento.</p>

<p>Si ejecutamos el código hasta este momento veremos un documento vacío llamado “Prueba.docx” en la carpeta donde está nuestra aplicación, en mi caso es dentro de <code>bin\Debug</code>, y es porque al crear nuestro documento únicamente empleamos el nombre de un archivo.</p>

<p><figure><img src='/postimages/post/docx-c-sharp/post.jsoncreated-document.png' alt='“Documento vacío” images_set' /></figure></p>

<h2 id=\"aadiendo-texto\">Añadiendo texto</h2>
<p>El texto dentro de un documento de DocX está organizado en párrafos, y por eso debemos añadir párrafos a nuestro documento, para ello debemos tomar nuestro documento y llamar el método <code>InsertParagraph</code>.</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">reportParagraph</span> <span class="p">=</span> <span class="n">document</span><span class="p">.</span><span class="n">InsertParagraph</span><span class="p">();</span></code></pre></figure></p>

<p>El método devuelve una referencia al párrafo que añadió al documento, a partir de aquí podemos añadirle texto a dicho párrafo, y por ende, al documento. Para agregar texto debemos usar el método <code>Append</code> de la clase <code>Paragraph</code>, este método funciona de manera similar a un <code>StringBuilder</code> ya que podemos <em>“encadenar”</em> las llamadas para separar partes del código:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">reportParagraph</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="err">“</span><span class="n">Este</span> <span class="n">es</span> <span class="n">un</span> <span class="n">reporte</span> <span class="n">perteneciente</span> <span class="n">a</span> <span class="n">las</span> <span class="n">clases</span> <span class="n">que</span> <span class="n">imparte</span> <span class="err">“</span> <span class="p">+</span> <span class="n">teacher</span><span class="p">.</span><span class="n">GivenName</span> <span class="p">+</span> <span class="err">“</span> <span class="err">“</span> <span class="p">+</span>
                    <span class="n">teacher</span><span class="p">.</span><span class="n">LastName</span> <span class="p">+</span> <span class="err">“</span><span class="p">,</span> <span class="n">generado</span> <span class="n">en</span> <span class="err">“</span> <span class="p">+</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">ToShortDateString</span><span class="p">()</span> <span class="p">+</span> <span class="err">“</span><span class="p">.</span> <span class="err">“</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="err">“</span><span class="n">El</span> <span class="n">profesor</span><span class="p">/</span><span class="n">ra</span> <span class="err">“</span> <span class="p">+</span> <span class="n">teacher</span><span class="p">.</span><span class="n">LastName</span> <span class="p">+</span> <span class="err">“</span> <span class="n">imparte</span> <span class="n">actualmente</span> <span class="err">“</span> <span class="p">+</span> <span class="n">lectures</span><span class="p">.</span><span class="n">Length</span> <span class="p">+</span> <span class="err">“</span> <span class="n">asignaturas</span><span class="p">.</span><span class="err">”</span><span class="p">);</span></code></pre></figure></p>

<p>Hasta este momento, el resultado de ejecutar el código es un documento que contiene el texto arriba indicado, se ve más o menos así:</p>

<p><figure><img src='/postimages/post/docx-c-sharp/post.jsonsin-estilo.png' alt='“Documento sin estilo” images_set' /></figure></p>

<h3 id=\"formateando-el-texto\">Formateando el texto</h3>
<p>El texto sin formato está bien, ¿pero sabes qué es mejor?</p>

<p>DocX tiene una API peculiar para aplicar el formato, ya que todo es a través de métodos que se llaman sobre la instancia de <code>Pharagraph</code>. El formato deseado se aplica al texto que acaba de ser “escrito” con <code>Append</code>, por ejemplo:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">reportParagraph</span><span class="p">.</span><span class="n">Append</span> <span class="p">(</span><span class="err">“</span><span class="n">Este</span> <span class="n">es</span> <span class="n">un</span> <span class="n">reporte</span> <span class="n">perteneciente</span> <span class="n">a</span> <span class="n">las</span> <span class="n">clases</span> <span class="n">que</span> <span class="n">imparte</span> <span class="err">“</span><span class="p">);</span>
<span class="n">reportParagraph</span><span class="p">.</span><span class="n">Append</span> <span class="p">(</span><span class="n">teacher</span><span class="p">.</span><span class="n">GivenName</span> <span class="p">+</span> <span class="err">“</span> <span class="err">“</span> <span class="p">+</span> <span class="n">teacher</span><span class="p">.</span><span class="n">LastName</span><span class="p">).</span><span class="n">Bold</span><span class="p">().</span><span class="n">Append</span><span class="p">(</span><span class="err">“</span><span class="p">,</span> <span class="n">generado</span> <span class="n">en</span> <span class="err">“</span><span class="p">);</span>
<span class="n">reportParagraph</span><span class="p">.</span><span class="n">Append</span> <span class="p">(</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">ToShortDateString</span> <span class="p">()).</span><span class="n">Italic</span><span class="p">().</span><span class="n">Append</span> <span class="p">(</span><span class="err">“</span><span class="p">.</span> <span class="err">“</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Append</span> <span class="p">(</span><span class="err">“</span><span class="n">El</span> <span class="n">profesor</span><span class="p">/</span><span class="n">ra</span> <span class="err">“</span><span class="p">).</span><span class="n">Append</span><span class="p">(</span><span class="n">teacher</span><span class="p">.</span><span class="n">LastName</span><span class="p">).</span><span class="n">Font</span><span class="p">(</span><span class="k">new</span> <span class="n">FontFamily</span><span class="p">(</span><span class="err">“</span><span class="n">Arial</span> <span class="n">Black</span><span class="err">”</span><span class="p">))</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="err">“</span> <span class="n">imparte</span> <span class="n">actualmente</span> <span class="err">“</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">lectures</span><span class="p">.</span><span class="n">Length</span> <span class="p">+</span> <span class="err">“</span> <span class="n">asignaturas</span><span class="p">.</span><span class="err">”</span><span class="p">).</span><span class="n">Color</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">Blue</span><span class="p">).</span><span class="n">Italic</span><span class="p">().</span><span class="n">Bold</span><span class="p">();</span></code></pre></figure></p>

<p>En el código de arriba están pasando varias cosas:</p>

<ul>
  <li>En la segunda línea se está poniendo el texto <code>teacher.GivenName + \" \" + teacher.LastName</code> en <strong>negritas</strong> con el método <code>Bold</code></li>
  <li>En la tercera línea se pone en <em>cursiva</em> la fecha con <code>Italic</code></li>
  <li>En la cuarta se cambia la fuente del texto con el que se escribe apellido del profesor con <code>Font</code></li>
  <li>En la sexta se cambia el color del texto, se pone en cursivas y en negritas también.</li>
</ul>

<p>Obtenemos un resultado como este:</p>

<p><figure><img src='/postimages/post/docx-c-sharp/post.jsonestilo.png' alt='“Documento estilizado” images_set' /></figure></p>

<p>Además de estas opciones de formato también podemos subrayar, cruzar, cambiar el tamaño del texto.</p>

<h2 id=\"ttulos\">Títulos</h2>
<p>Una de las mejores funciones que tiene Word es la posibilidad de añadir títulos a los documentos, y DocX no se queda atrás. Como ya vimos, es necesario añadir un párrafo, agregarle texto e indicarle qué tipo de encabezado deseamos</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">titleParagraph</span> <span class="p">=</span> <span class="n">document</span><span class="p">.</span><span class="n">InsertParagraph</span><span class="p">();</span>
<span class="n">titleParagraph</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="err">“</span><span class="n">Reporte</span> <span class="err">“</span> <span class="p">+</span> <span class="n">LastName</span><span class="p">).</span><span class="n">Heading</span><span class="p">(</span><span class="n">HeadingType</span><span class="p">.</span><span class="n">Heading1</span><span class="p">);</span></code></pre></figure></p>

<p>Y acá está el resultado:</p>

<p><figure><img src='/postimages/post/docx-c-sharp/post.jsonencabezado.png' alt='“Encabezado” images_set' /></figure></p>

<h2 id=\"encabezado-y-pie-de-pgina\">Encabezado y pie de página</h2>
<p>Para darle un poco más de formalidad al documento, vamos a añadirle un pie de página y un encabezado, otra vez debemos añadir párrafos. Antes que nada, es necesario llamar a dos métodos para preparar el terreno.</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">document</span><span class="p">.</span><span class="n">AddHeaders</span><span class="p">();</span>
<span class="n">document</span><span class="p">.</span><span class="n">AddFooters</span><span class="p">();</span></code></pre></figure></p>

<p>Una vez hecho esto, podemos comenzar:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">header</span> <span class="p">=</span> <span class="n">document</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">odd</span><span class="p">.</span><span class="n">InsertParagraph</span><span class="p">();</span>
<span class="n">header</span><span class="p">.</span><span class="n">Append</span> <span class="p">(</span><span class="err">“</span><span class="n">Reporte</span> <span class="p">-</span> <span class="n">DocX</span><span class="err">”</span><span class="p">).</span><span class="n">Font</span><span class="p">(</span><span class="k">new</span> <span class="n">FontFamily</span><span class="p">(</span><span class="err">“</span><span class="n">Courier</span> <span class="n">New</span><span class="err">”</span><span class="p">));&lt;/</span><span class="n">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="n">document</span><span class="p">.</span><span class="n">Footers</span><span class="p">.</span><span class="n">odd</span><span class="p">.</span><span class="n">PageNumbers</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span></code></pre></figure></p>

<p>En este caso estamos agregando el texto “Reporte - DocX” al encabezado y un número de página al pie de página:</p>

<div class=\"pure-g\">
<div class=\"pure-u-1 pure-u-md-1-2\">
<figure><img src='/postimages/post/docx-c-sharp/post.jsonheader.png' alt='\"Encabezado\" images_set' /></figure>  
</div>
<div class=\"pure-u-1 pure-u-md-1-2\">
<figure><img src='/postimages/post/docx-c-sharp/post.jsonfooter.png' alt='\"Pie de pagina\" images_set' /></figure>  
</div>  
</div>

<h2 id=\"tablas\">Tablas</h2>
<p>La inserción de tablas se hace también a través de un método y especificando el número de filas y columnas que se requieren, para este caso requeriremos únicamente 3 columnas y colocaremos una fila de encabezados, también le añadiremos un poco de estilos y bordes para que se vea mejor el “reporte”:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">table</span> <span class="p">=</span> <span class="n">document</span><span class="p">.</span><span class="n">InsertTable</span> <span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">3</span><span class="p">);&lt;/</span><span class="n">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">AutoFit</span> <span class="p">=</span> <span class="n">AutoFit</span><span class="p">.</span><span class="n">Window</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">border</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Border</span> <span class="p">(</span><span class="n">BorderStyle</span><span class="p">.</span><span class="n">Tcbs_single</span><span class="p">,</span> <span class="n">BorderSize</span><span class="p">.</span><span class="n">one</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span><span class="p">);</span>
<span class="n">table</span><span class="p">.</span><span class="n">SetBorder</span> <span class="p">(</span><span class="n">TableBorderType</span><span class="p">.</span><span class="n">InsideH</span><span class="p">,</span> <span class="n">border</span><span class="p">);</span> <span class="c1">// … más bordes</span></code></pre></figure></p>

<p>De ahí accedemos a la fila <code>0</code> y a sus celdas mediante la propiedad <code>Cells</code>, cada celda funciona como un nuevo documento, por lo que debemos trabajar con los párrafos como anteriormente:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">tableHeaders</span> <span class="p">=</span> <span class="n">table</span><span class="p">.</span><span class="n">Rows</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
<span class="n">tableHeaders</span><span class="p">.</span><span class="n">Cells</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">InsertParagraph</span><span class="p">().</span><span class="n">Append</span><span class="p">(</span><span class="err">“</span><span class="n">ID</span><span class="err">”</span><span class="p">).</span><span class="n">Bold</span><span class="p">();</span>
<span class="n">tableHeaders</span><span class="p">.</span><span class="n">Cells</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">InsertParagraph</span><span class="p">().</span><span class="n">Append</span><span class="p">(</span><span class="err">“</span><span class="n">Clase</span><span class="err">”</span><span class="p">).</span><span class="n">Bold</span><span class="p">();</span>
<span class="n">tableHeaders</span><span class="p">.</span><span class="n">Cells</span><span class="p">[</span><span class="m">2</span><span class="p">].</span><span class="n">InsertParagraph</span><span class="p">().</span><span class="n">Append</span><span class="p">(</span><span class="err">“</span><span class="n">Nivel</span><span class="err">”</span><span class="p">).</span><span class="n">Bold</span><span class="p">();</span></code></pre></figure></p>

<p>Después con un ciclo sobre <code>lectures</code>, agregamos todos los datos:</p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">lecture</span> <span class="k">in</span> <span class="n">lectures</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">tableRow</span> <span class="p">=</span> <span class="n">table</span><span class="p">.</span><span class="n">InsertRow</span><span class="p">();</span>
    <span class="n">tableRow</span><span class="p">.</span><span class="n">Cells</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">InsertParagraph</span><span class="p">().</span><span class="n">Append</span> <span class="p">(</span><span class="n">lecture</span><span class="p">.</span><span class="n">Id</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
    <span class="n">tableRow</span><span class="p">.</span><span class="n">Cells</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">InsertParagraph</span><span class="p">().</span><span class="n">Append</span><span class="p">(</span><span class="n">lecture</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
    <span class="n">tableRow</span><span class="p">.</span><span class="n">Cells</span><span class="p">[</span><span class="m">2</span><span class="p">].</span><span class="n">InsertParagraph</span><span class="p">().</span><span class="n">Append</span><span class="p">(</span><span class="n">lecture</span><span class="p">.</span><span class="n">Level</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure></p>

<p>Y el resultado:</p>

<p><figure><img src='/postimages/post/docx-c-sharp/post.jsontable.png' alt='“Tabla” images_set' /></figure></p>

<p>Con esto llegamos al final de la generación de nuestro reporte, pero antes hay que decir que DocX también permite trabajar con imágenes, hipervínculos, propiedades del documento.</p>

<h1 id=\"buscar-y-reemplazar\">Buscar y reemplazar</h1>
<p>Personalmente pienso que la posibilidad de DocX de buscar y reemplazar texto en un documento es la mejor de todas, ya que podemos partir de un documento formateado a nuestro gusto (sin necesidad de crearlo desde 0) y obtener un resultado más que aceptable. Con esta característica construí una especie de “motor” para generar reportes en el trabajo.</p>

<p>Por ejemplo, tenemos un documento llamado <code>template.docx</code>, lo abriremos con DocX usando el método <code>Load</code> y reemplazaremos algunos de sus valores para guardarlo como <code>out.docx</code>:</p>

<p><figure><img src='/postimages/post/docx-c-sharp/post.jsontemplate.png' alt='“Template” images_set' /></figure></p>

<p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">template</span><span class="p">.</span><span class="n">ReplaceText</span><span class="p">(</span><span class="err">“</span><span class="n">esta</span> <span class="n">entrada</span><span class="err">”</span><span class="p">,</span> <span class="err">“</span><span class="n">este</span> <span class="n">post</span> <span class="n">sobre</span> <span class="n">DocX</span><span class="err">”</span><span class="p">);</span>
<span class="n">template</span><span class="p">.</span><span class="n">ReplaceText</span><span class="p">(</span><span class="err">“</span><span class="n">querido</span><span class="err">”</span><span class="p">,</span> <span class="err">“</span><span class="n">querido</span> <span class="n">y</span> <span class="n">respetable</span><span class="err">”</span><span class="p">);</span>
<span class="n">template</span><span class="p">.</span><span class="n">ReplaceText</span><span class="p">(</span><span class="err">“</span><span class="n">Facebook</span><span class="err">”</span><span class="p">,</span> <span class="err">“</span><span class="n">Twitter</span><span class="err">”</span><span class="p">);</span>
<span class="n">template</span><span class="p">.</span><span class="n">ReplaceText</span><span class="p">(</span><span class="err">“</span><span class="n">correo</span> <span class="n">electrónico</span><span class="err">”</span><span class="p">,</span> <span class="err">“</span><span class="n">feregrino@thatcsharpguy</span><span class="p">.</span><span class="n">com</span><span class="err">”</span><span class="p">);</span></code></pre></figure></p>

<p><figure><img src='/postimages/post/docx-c-sharp/post.jsonout.png' alt='“Salida” images_set' /></figure></p>

<h2 id=\"conclusin\">Conclusión</h2>
<p>Al principio la API de DocX nos puede parecer un poco rara y con poca documentación, sin embargo, eso no le resta a lo enormemente útil que resulta esta librería, cuando lo que buscamos es trabajar y generar documentos de Word de manera programática. Lo mejor de todo es que <strong>no requiere que la máquina en donde se ejecuta tenga instalado Office</strong>, gran, gran plus.</p>

<h1 id=\"instalacin\">Instalación</h1>
<p>No olvides visitar <a href=\"http://docx.codeplex.com\" target=\"_blank\">la página de DocX en Codeplex</a> o instala el paquete de NuGet en tu proyecto:</p>

<p><figure class="console"><pre><code>PM&gt; Install-Package DocX</code></pre></figure></p>
"
}